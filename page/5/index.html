<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="珍惜在生命中遇到的每一个人">
<meta property="og:type" content="website">
<meta property="og:title" content="伍中联(Vanda)的博客">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="伍中联(Vanda)的博客">
<meta property="og:description" content="珍惜在生命中遇到的每一个人">
<meta property="og:locale">
<meta property="article:author" content="伍中联">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"default","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>伍中联(Vanda)的博客</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">伍中联(Vanda)的博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">当一切理所当然就没有你什么事了 当你说：“这个好麻烦，那么不要犹豫，主动出击”</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>About</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="伍中联"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">伍中联</p>
  <div class="site-description" itemprop="description">珍惜在生命中遇到的每一个人</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/10045125" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;10045125" rel="noopener" target="_blank"><i class="fab zhonglian-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/zhonglian.wzl@gmail.com" title="E-Mail → zhonglian.wzl@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/22/HTTP%E5%8D%8F%E8%AE%AE%E5%A4%B4%E9%83%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/22/HTTP%E5%8D%8F%E8%AE%AE%E5%A4%B4%E9%83%A8/" class="post-title-link" itemprop="url">HTTP协议头部</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-22 21:42:09" itemprop="dateCreated datePublished" datetime="2017-03-22T21:42:09+08:00">2017-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:35:00" itemprop="dateModified" datetime="2022-05-11T14:35:00+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="什么是Keep-Alive模式？"><a href="#什么是Keep-Alive模式？" class="headerlink" title="什么是Keep-Alive模式？"></a>什么是Keep-Alive模式？</h4><p>我们知道HTTP协议采用“请求-应答”模式，当使用普通模式，即非KeepAlive模式时，每个请求&#x2F;应答客户和服务器都要新建一个连接，完成 之后立即断开连接（HTTP协议为无连接的协议）；当使用Keep-Alive模式（又称持久连接、连接重用）时，Keep-Alive功能使客户端到服 务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive功能避免了建立或者重新建立连接。</p>
<p><img src="/./HTTP%E5%8D%8F%E8%AE%AE%E5%A4%B4%E9%83%A8/img/http.png"></p>
<p>http 1.0中默认是关闭的，需要在http头加入”Connection: Keep-Alive”，才能启用Keep-Alive；http 1.1中默认启用Keep-Alive，如果加入”Connection: close “，才关闭。目前大部分浏览器都是用http1.1协议，也就是说默认都会发起Keep-Alive的连接请求了，所以是否能完成一个完整的Keep- Alive连接就看服务器设置情况。</p>
<h4 id="启用Keep-Alive的优点"><a href="#启用Keep-Alive的优点" class="headerlink" title="启用Keep-Alive的优点"></a>启用Keep-Alive的优点</h4><p>从上面的分析来看，启用Keep-Alive模式肯定更高效，性能更高。因为避免了建立&#x2F;释放连接的开销。下面是RFC 2616 上的总结：</p>
<ol>
<li><p>By opening and closing fewer TCP connections, CPU time is saved in routers and hosts (clients, servers, proxies, gateways, tunnels, or caches), and memory used for TCP protocol control blocks can be saved in hosts.</p>
</li>
<li><p>HTTP requests and responses can be pipelined on a connection. Pipelining allows a client to make multiple requests without waiting for each response, allowing a single TCP connection to be used much more efficiently, with much lower elapsed time.</p>
</li>
<li><p>Network congestion is reduced by reducing the number of packets caused by TCP opens, and by allowing TCP sufficient time to determine the congestion state of the network.</p>
</li>
<li><p>Latency on subsequent requests is reduced since there is no time spent in TCP’s connection opening handshake.</p>
</li>
<li><p>HTTP can evolve more gracefully, since errors can be reported without the penalty of closing the TCP connection. Clients using future versions of HTTP might optimistically try a new feature, but if communicating with an older server, retry with old semantics after an error is reported.</p>
</li>
</ol>
<p>RFC 2616 （P47）还指出：单用户客户端与任何服务器或代理之间的连接数不应该超过2个。一个代理与其它服务器或代码之间应该使用不超过2 * N的活跃并发连接。这是为了提高HTTP响应时间，避免拥塞（冗余的连接并不能代码执行性能的提升）</p>
<h4 id="回到我们的问题（即如何判断消息内容-x2F-长度的大小？）"><a href="#回到我们的问题（即如何判断消息内容-x2F-长度的大小？）" class="headerlink" title="回到我们的问题（即如何判断消息内容&#x2F;长度的大小？）"></a>回到我们的问题（即如何判断消息内容&#x2F;长度的大小？）</h4><p>Keep-Alive模式，客户端如何判断请求所得到的响应数据已经接收完成（或者说如何知道服务器已经发生完了数据）？我们已经知道 了，Keep-Alive模式发送玩数据HTTP服务器不会自动断开连接，所有不能再使用返回EOF（-1）来判断（当然你一定要这样使用也没有办法，可 以想象那效率是何等的低）！下面我介绍两种来判断方法。</p>
<h6 id="使用消息首部字段Conent-Length"><a href="#使用消息首部字段Conent-Length" class="headerlink" title="使用消息首部字段Conent-Length"></a>使用消息首部字段Conent-Length</h6><p>故名思意，Conent-Length表示实体内容长度，客户端（服务器）可以根据这个值来判断数据是否接收完成。但是如果消息中没有Conent-Length，那该如何来判断呢？又在什么情况下会没有Conent-Length呢？请继续往下看……</p>
<h6 id="使用消息首部字段Transfer-Encoding"><a href="#使用消息首部字段Transfer-Encoding" class="headerlink" title="使用消息首部字段Transfer-Encoding"></a>使用消息首部字段Transfer-Encoding</h6><p>当客户端向服务器请求一个静态页面或者一张图片时，服务器可以很清楚的知道内容大小，然后通过Content-length消息首部字段告诉客户端 需要接收多少数据。但是如果是动态页面等时，服务器是不可能预先知道内容大小，这时就可以使用Transfer-Encoding：chunk模式来传输 数据了。即如果要一边产生数据，一边发给客户端，服务器就需要使用”Transfer-Encoding: chunked”这样的方式来代替Content-Length。</p>
<p>chunk编码将数据分成一块一块的发生。Chunked编码将使用若干个Chunk串连而成，由一个标明长度为0 的chunk标示结束。每个Chunk分为头部和正文两部分，头部内容指定正文的字符总数（十六进制的数字 ）和数量单位（一般不写），正文部分就是指定长度的实际内容，两部分之间用回车换行(CRLF) 隔开。在最后一个长度为0的Chunk中的内容是称为footer的内容，是一些附加的Header信息（通常可以直接忽略）。 Chunk编码的格式如下：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Chunked-Body = *<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>chunk <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="string">&quot;0&quot;</span> CRLF</span><br><span class="line">footer</span><br><span class="line">CRLF</span><br><span class="line">chunk = chunk-size [ chunk-ext ] CRLF</span><br><span class="line">chunk-data CRLF</span><br><span class="line"></span><br><span class="line">hex-no-zero = &amp;<span class="literal">lt</span>;HEX excluding <span class="string">&quot;0&quot;</span>&amp;<span class="literal">gt</span>;</span><br><span class="line"></span><br><span class="line">chunk-size = hex-no-zero *HEX</span><br><span class="line">chunk-ext = *( <span class="string">&quot;;&quot;</span> chunk-ext-name [ <span class="string">&quot;=&quot;</span> chunk-ext-value ] )</span><br><span class="line">chunk-ext-name = token</span><br><span class="line">chunk-ext-val = token | quoted-string</span><br><span class="line">chunk-data = chunk-size(OCTET)</span><br><span class="line"></span><br><span class="line">footer = *entity-header</span><br><span class="line"></span><br><span class="line">即Chunk编码由四部分组成： <span class="number">1</span>、<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>0至多个chunk块<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span> ，<span class="number">2</span>、<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>&quot;0&quot; CRLF <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span>，<span class="number">3</span>、<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>footer <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span>，<span class="number">4</span>、<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>CRLF<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span> <span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>.<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span> 而每个chunk块由：chunk-size、chunk-ext（可选）、CRLF、chunk-data、CRLF组成。</span><br></pre></td></tr></table></figure>

<h4 id="消息长度的总结"><a href="#消息长度的总结" class="headerlink" title="消息长度的总结"></a>消息长度的总结</h4><p>其实，上面2中方法都可以归纳为是如何判断http消息的大小、消息的数量。RFC 2616 对 消息的长度总结如下：一个消息的transfer-length（传输长度）是指消息中的message-body（消息体）的长度。当应用了 transfer-coding（传输编码），每个消息中的message-body（消息体）的长度（transfer-length）由以下几种情况 决定（优先级由高到低）：</p>
<ol>
<li><p>任何不含有消息体的消息（如1XXX、204、304等响应消息和任何头(HEAD，首部)请求的响应消息），总是由一个空行（CLRF）结束。</p>
</li>
<li><p>如果出现了Transfer-Encoding头字段 并且值为非“identity”，那么transfer-length由“chunked” 传输编码定义，除非消息由于关闭连接而终止。</p>
</li>
<li><p>如果出现了Content-Length头字段，它的值表示entity-length（实体长度）和transfer-length（传输长 度）。如果这两个长度的大小不一样（i.e.设置了Transfer-Encoding头字段），那么将不能发送Content-Length头字段。并 且如果同时收到了Transfer-Encoding字段和Content-Length头字段，那么必须忽略Content-Length字段。</p>
</li>
<li><p>如果消息使用媒体类型“multipart&#x2F;byteranges”，并且transfer-length 没有另外指定，那么这种自定界（self-delimiting）媒体类型定义transfer-length 。除非发送者知道接收者能够解析该类型，否则不能使用该类型。</p>
</li>
<li><p>由服务器关闭连接确定消息长度。（注意：关闭连接不能用于确定请求消息的结束，因为服务器不能再发响应消息给客户端了。）</p>
</li>
</ol>
<p>为了兼容HTTP&#x2F;1.0应用程序，HTTP&#x2F;1.1的请求消息体中必须包含一个合法的Content-Length头字段，除非知道服务器兼容 HTTP&#x2F;1.1。一个请求包含消息体，并且Content-Length字段没有给定，如果不能判断消息的长度，服务器应该用用400 (bad request) 来响应；或者服务器坚持希望收到一个合法的Content-Length字段，用 411 (length required)来响应。</p>
<p>所有HTTP&#x2F;1.1的接收者应用程序必须接受“chunked” transfer-coding (传输编码)，因此当不能事先知道消息的长度，允许使用这种机制来传输消息。消息不应该够同时包含 Content-Length头字段和non-identity transfer-coding。如果一个消息同时包含non-identity transfer-coding和Content-Length ，必须忽略Content-Length 。</p>
<h4 id="HTTP头字段总结"><a href="#HTTP头字段总结" class="headerlink" title="HTTP头字段总结"></a>HTTP头字段总结</h4><p>最后我总结下HTTP协议的头部字段。</p>
<ol>
<li><p>Accept：告诉WEB服务器自己接受什么介质类型，&#x2F; 表示任何类型，type&#x2F;* 表示该类型下的所有子类型，type&#x2F;sub-type。</p>
</li>
<li><p>Accept-Charset： 浏览器申明自己接收的字符集 Accept-Encoding： 浏览器申明自己接收的编码方法，通常指定压缩方法，是否支持压缩，支持什么压缩方法（gzip，deflate） Accept-Language：浏览器申明自己接收的语言 语言跟字符集的区别：中文是语言，中文有多种字符集，比如big5，gb2312，gbk等等。</p>
</li>
<li><p>Accept-Ranges：WEB服务器表明自己是否接受获取其某个实体的一部分（比如文件的一部分）的请求。bytes：表示接受，none：表示不接受。</p>
</li>
<li><p>Age：当代理服务器用自己缓存的实体去响应请求时，用该头部表明该实体从产生到现在经过多长时间了。</p>
</li>
<li><p>Authorization：当客户端接收到来自WEB服务器的 WWW-Authenticate 响应时，用该头部来回应自己的身份验证信息给WEB服务器。</p>
</li>
<li><p>Cache-Control：请求：no-cache（不要缓存的实体，要求现在从WEB服务器去取） max-age：（只接受 Age 值小于 max-age 值，并且没有过期的对象） max-stale：（可以接受过去的对象，但是过期时间必须小于 max-stale 值） min-fresh：（接受其新鲜生命期大于其当前 Age 跟 min-fresh 值之和的缓存对象） 响应：public(可以用 Cached 内容回应任何用户) private（只能用缓存内容回应先前请求该内容的那个用户） no-cache（可以缓存，但是只有在跟WEB服务器验证了其有效后，才能返回给客户端） max-age：（本响应包含的对象的过期时间） ALL: no-store（不允许缓存）</p>
</li>
<li><p>Connection：请求：close（告诉WEB服务器或者代理服务器，在完成本次请求的响应后，断开连接，不要等待本次连接的后续请求了）。 keepalive（告诉WEB服务器或者代理服务器，在完成本次请求的响应后，保持连接，等待本次连接的后续请求）。 响应：close（连接已经关闭）。 keepalive（连接保持着，在等待本次连接的后续请求）。 Keep-Alive：如果浏览器请求保持连接，则该头部表明希望 WEB 服务器保持连接多长时间（秒）。例如：Keep-Alive：300</p>
</li>
<li><p>Content-Encoding：WEB服务器表明自己使用了什么压缩方法（gzip，deflate）压缩响应中的对象。例如：Content-Encoding：gzip</p>
</li>
<li><p>Content-Language：WEB 服务器告诉浏览器自己响应的对象的语言。</p>
</li>
<li><p>Content-Length： WEB 服务器告诉浏览器自己响应的对象的长度。例如：Content-Length: 26012</p>
</li>
<li><p>Content-Range： WEB 服务器表明该响应包含的部分对象为整个对象的哪个部分。例如：Content-Range: bytes 21010-47021&#x2F;47022</p>
</li>
<li><p>Content-Type： WEB 服务器告诉浏览器自己响应的对象的类型。例如：Content-Type：application&#x2F;xml</p>
</li>
<li><p>ETag：就是一个对象（比如URL）的标志值，就一个对象而言，比如一个 html 文件，如果被修改了，其 Etag 也会别修改，所以ETag 的作用跟 Last-Modified 的作用差不多，主要供 WEB 服务器判断一个对象是否改变了。比如前一次请求某个 html 文件时，获得了其 ETag，当这次又请求这个文件时，浏览器就会把先前获得的 ETag 值发送给WEB 服务器，然后 WEB 服务器会把这个 ETag 跟该文件的当前 ETag 进行对比，然后就知道这个文件有没有改变了。</p>
</li>
<li><p>Expired：WEB服务器表明该实体将在什么时候过期，对于过期了的对象，只有在跟WEB服务器验证了其有效性后，才能用来响应客户请求。是 HTTP&#x2F;1.0 的头部。例如：Expires：Sat, 23 May 2009 10:02:12 GMT</p>
</li>
<li><p>Host：客户端指定自己想访问的WEB服务器的域名&#x2F;IP 地址和端口号。例如：Host：rss.sina.com.cn</p>
</li>
<li><p>If-Match：如果对象的 ETag 没有改变，其实也就意味著对象没有改变，才执行请求的动作。</p>
</li>
<li><p>If-None-Match：如果对象的 ETag 改变了，其实也就意味著对象也改变了，才执行请求的动作。</p>
</li>
<li><p>If-Modified-Since：如果请求的对象在该头部指定的时间之后修改了，才执行请求的动作（比如返回对象），否则返回代码304，告诉浏览器 该对象没有修改。例如：If-Modified-Since：Thu, 10 Apr 2008 09:14:42 GMT</p>
</li>
<li><p>If-Unmodified-Since：如果请求的对象在该头部指定的时间之后没修改过，才执行请求的动作（比如返回对象）。</p>
</li>
<li><p>If-Range：浏览器告诉 WEB 服务器，如果我请求的对象没有改变，就把我缺少的部分给我，如果对象改变了，就把整个对象给我。浏览器通过发送请求对象的 ETag 或者 自己所知道的最后修改时间给 WEB 服务器，让其判断对象是否改变了。总是跟 Range 头部一起使用。</p>
</li>
<li><p>Last-Modified：WEB 服务器认为对象的最后修改时间，比如文件的最后修改时间，动态页面的最后产生时间等等。例如：Last-Modified：Tue, 06 May 2008 02:42:43 GMT</p>
</li>
<li><p>Location：WEB 服务器告诉浏览器，试图访问的对象已经被移到别的位置了，到该头部指定的位置去取。例如：Location：<a target="_blank" rel="noopener" href="http://i0.sinaimg.cn/dy/deco/2008/0528/sinahome_0803_ws_005_text_0.gif">http://i0.sinaimg.cn/dy/deco/2008/0528/sinahome_0803_ws_005_text_0.gif</a></p>
</li>
<li><p>Pramga：主要使用 Pramga: no-cache，相当于 Cache-Control： no-cache。例如：Pragma：no-cache</p>
</li>
<li><p>Proxy-Authenticate： 代理服务器响应浏览器，要求其提供代理身份验证信息。Proxy-Authorization：浏览器响应代理服务器的身份验证请求，提供自己的身份信息。</p>
</li>
<li><p>Range：浏览器（比如 Flashget 多线程下载时）告诉 WEB 服务器自己想取对象的哪部分。例如：Range: bytes&#x3D;1173546-</p>
</li>
<li><p>Referer：浏览器向 WEB 服务器表明自己是从哪个 网页&#x2F;URL 获得&#x2F;点击 当前请求中的网址&#x2F;URL。例如：Referer：<a target="_blank" rel="noopener" href="http://www.sina.com/">http://www.sina.com/</a></p>
</li>
<li><p>Server: WEB 服务器表明自己是什么软件及版本等信息。例如：Server：Apache&#x2F;2.0.61 (Unix)</p>
</li>
<li><p>User-Agent: 浏览器表明自己的身份（是哪种浏览器）。例如：User-Agent：Mozilla&#x2F;5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.8.1.14) Gecko&#x2F;20080404 Firefox&#x2F;2、0、0、14</p>
</li>
<li><p>Transfer-Encoding: WEB 服务器表明自己对本响应消息体（不是消息体里面的对象）作了怎样的编码，比如是否分块（chunked）。例如：Transfer-Encoding: chunked</p>
</li>
<li><p>Vary: WEB服务器用该头部的内容告诉 Cache 服务器，在什么条件下才能用本响应所返回的对象响应后续的请求。假如源WEB服务器在接到第一个请求消息时，其响应消息的头部为：Content- Encoding: gzip; Vary: Content-Encoding那么 Cache 服务器会分析后续请求消息的头部，检查其 Accept-Encoding，是否跟先前响应的 Vary 头部值一致，即是否使用相同的内容编码方法，这样就可以防止 Cache 服务器用自己 Cache 里面压缩后的实体响应给不具备解压能力的浏览器。例如：Vary：Accept-Encoding</p>
</li>
<li><p>Via： 列出从客户端到 OCS 或者相反方向的响应经过了哪些代理服务器，他们用什么协议（和版本）发送的请求。当客户端请求到达第一个代理服务器时，该服务器会在自己发出的请求里面添 加 Via 头部，并填上自己的相关信息，当下一个代理服务器收到第一个代理服务器的请求时，会在自己发出的请求里面复制前一个代理服务器的请求的Via 头部，并把自己的相关信息加到后面，以此类推，当 OCS 收到最后一个代理服务器的请求时，检查 Via 头部，就知道该请求所经过的路由。例如：Via：1.0 236.D0707195.sina.com.cn:80 (squid&#x2F;2.6.STABLE13)</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">通过Service拉起进程，同时开始Service的全过程分析学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-17 15:27:26" itemprop="dateCreated datePublished" datetime="2017-03-17T15:27:26+08:00">2017-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:35:00" itemprop="dateModified" datetime="2022-05-11T14:35:00+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>我们通过提供一个对外部的Service拉起相关的进程和服务，这样能够确保我们有一个进程能够一直在后台，从而进行相关的后台操作。那么通过Service去启动所在进程都做了哪些事情，我们做个深入的分析和探讨。</p>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><p>一般来说，我们在Activity中开启一个服务的代码如下</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">    Intent intent = <span class="keyword">new</span> <span class="constructor">Intent()</span>;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">12</span>)</span><br><span class="line">        intent.add<span class="constructor">Flags(0x00000020)</span>; <span class="comment">// Intent.FLAG_INCLUDE_STOPPED_PACKAGES</span></span><br><span class="line">    intent.set<span class="constructor">Action(<span class="string">&quot;com.vanda.intent.action.FRIEND&quot;</span>)</span>;</span><br><span class="line">    intent.set<span class="constructor">ClassName(<span class="string">&quot;com.vanda&quot;</span>, <span class="string">&quot;com.vanda.bridge&quot;</span>)</span>;</span><br><span class="line">    intent.put<span class="constructor">Extra(<span class="string">&quot;source&quot;</span>, <span class="params">getPackageName</span>()</span>);</span><br><span class="line">    start<span class="constructor">Service(<span class="params">intent</span>)</span>;</span><br><span class="line">&#125; catch (Throwable tr) &#123;</span><br><span class="line">    <span class="comment">// No such service or security error or oom error.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码是一个APP调起另一个APP中的Service进程，这属于跨进程之间的通信范畴，接下来，我们来分析startService是如何工作的。</p>
<h4 id="Android进程间通信"><a href="#Android进程间通信" class="headerlink" title="Android进程间通信"></a>Android进程间通信</h4><p>Android系统是基于Linux内核的，而Linux内核继承和兼容了丰富的Unix系统进程间通信（IPC（Inter process communication））机制。有传统的管道（Pipe）、信号（Signal）和跟踪（Trace），这三项通信手段只能用于父进程与子进程之间，或者兄弟进程之间；后来又增加了命令管道（Named Pipe），使得进程间通信不再局限于父子进程或者兄弟进程之间；为了更好地支持商业应用中的事务处理，在AT&amp;T的Unix系统V中，又增加了三种称为“System V IPC”的进程间通信机制，分别是报文队列（Message）、共享内存（Share Memory）和信号量（Semaphore）；后来BSD Unix对“System V IPC”机制进行了重要的扩充，提供了一种称为插口（Socket）的进程间通信机制。</p>
<p>Android系统没有采用上述提到的各种进程间通信机制，而是采用Binder机制。在Android系统的Binder机制中，由一些系统组件组成，分别是Client、Server、Service Manager和Binder驱动程序，其中Client、Server和Service Manager运行在用户空间，Binder驱动程序运行内核空间。Binder就是一种把这四个组件粘合在一起的粘结剂了，其中，核心组件便是Binder驱动程序了，Service Manager提供了辅助管理的功能，Client和Server正是在Binder驱动和Service Manager提供的基础设施上，进行Client-Server之间的通信。Service Manager和Binder驱动已经在Android平台中实现好，开发者只要按照规范实现自己的Client和Server组件就可以了。</p>
<p><img src="/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/img/Binder.png"></p>
<ol>
<li><p>Client、Server和Service Manager实现在用户空间中，Binder驱动程序实现在内核空间中</p>
</li>
<li><p>Binder驱动程序和Service Manager在Android平台中已经实现，开发者只需要在用户空间实现自己的Client和Server</p>
</li>
<li><p>Binder驱动程序提供设备文件&#x2F;dev&#x2F;binder与用户空间交互，Client、Server和Service Manager通过open和ioctl文件操作函数与Binder驱动程序进行通信</p>
</li>
<li><p>Client和Server之间的进程间通信通过Binder驱动程序间接实现</p>
</li>
<li><p>Service Manager是一个守护进程，用来管理Server，并向Client提供查询Server接口的能力<br> （感谢老罗说的那么多）</p>
</li>
</ol>
<h4 id="Java层的ServiceManager"><a href="#Java层的ServiceManager" class="headerlink" title="Java层的ServiceManager"></a>Java层的ServiceManager</h4><p>Service Manager（我觉得是C&#x2F;C++层）是一个守护进程，用来管理Server，并向Client提供查询Server接口的能力，我们看下类图构成：</p>
<p><img src="/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/img/ServiceManager.jpg"></p>
<ol>
<li><p>ServiceManager提供了外部查询的和添加Service的方法，最为核心的是具备实现IServiceManager的ServiceManagerNative类。</p>
</li>
<li><p>ServiceManagerNative需要一个实现IBinder的对象，这个对象通过BinderInternal.getContextObject()获得一个C层的BinderProxy对象，这是系统中全局的”context object”。</p>
</li>
<li><p>ServiceManagerNative通过一个代理类ServiceManagerProxy，ServiceManagerProxy类实现了IServiceManager接口，IServiceManager提供了getService和addService两个成员函数来管理系统中的Service。从ServiceManagerProxy类的构造函数可以看出，它需要一个BinderProxy对象的IBinder接口来作为参数。因此，要获取Service Manager的Java远程接口ServiceManagerProxy，首先要有一个BinderProxy对象。再来看一下是通过什么路径来获取Service Manager的Java远程接口ServiceManagerProxy的。这个主角就是ServiceManager了，ServiceManager类有一个静态成员函getIServiceManager，它的作用就是用来获取Service Manager的Java远程接口了，而这个函数又是通过ServiceManagerNative来获取Service Manager的Java远程接口的。</p>
</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title">getIServiceManager</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sServiceManager != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sServiceManager;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Find the service manager</span></span><br><span class="line">    sServiceManager = ServiceManagerNative.asInterface(BinderInternal.getContextObject());</span><br><span class="line">    <span class="keyword">return</span> sServiceManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在C&#x2F;C++层将对象进行了转换，结果是sServiceManager &#x3D; ServiceManagerNative.asInterface(new BinderProxy()); 那么我们看下ServiceManagerNative.asInterface做了什么事情</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title function_">asInterface</span><span class="params">(IBinder obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">IServiceManager</span> <span class="variable">in</span> <span class="operator">=</span></span><br><span class="line">        (IServiceManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceManagerProxy</span>(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的静态方法中看出，如果当地查询不到IServiceManager，in为null ,obj是一个BinderProxy对象,那么就会以BinderProxy对象为参数创建一个ServiceManagerProxy对象。实质上等价的代码为<br>sServiceManager &#x3D; new ServiceManagerProxy(new BinderProxy());<br>ServiceManager就是这为了这句代码写的，就是在Java层，我们拥有了一个Service Manager远程接口ServiceManagerProxy，而这个ServiceManagerProxy对象在JNI层有一个句柄值为0的BpBinder对象与之通过gBinderProxyOffsets关联起来。这样获取Service Manager的Java远程接口ServiceManagerProxy的过程就完成了。</p>
<p>我们简单的看下C层做了些什么</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; ProcessState::get<span class="constructor">ContextObject(<span class="params">const</span> <span class="params">sp</span>&lt;IBinder&gt;&amp; <span class="params">caller</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    return get<span class="constructor">StrongProxyForHandle(0)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">static jobject android_os_BinderInternal_getContextObject(JNIEnv* env, jobject clazz)</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::self()-&gt;getContextObject(NULL);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> javaObjectForIBinder(env, b);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">jobject javaObjectForIBinder(JNIEnv* env, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; <span class="keyword">val</span>)</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">val</span> == NULL) <span class="keyword">return</span> NULL;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">val</span>-&gt;checkSubclass(&amp;gBinderOffsets)) &#123;</span><br><span class="line">        <span class="comment">// One of our own!</span></span><br><span class="line">        jobject <span class="keyword">object</span> = static_cast&lt;JavaBBinder*&gt;(<span class="keyword">val</span>.<span class="keyword">get</span>())-&gt;<span class="keyword">object</span>();</span><br><span class="line">        LOGDEATH(<span class="string">&quot;objectForBinder %p: it&#x27;s our own %p!\n&quot;</span>, <span class="keyword">val</span>.<span class="keyword">get</span>(), <span class="keyword">object</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">object</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// For the rest of the function we will hold this lock, to serialize</span></span><br><span class="line">    <span class="comment">// looking/creation of Java proxies for native Binder proxies.</span></span><br><span class="line">    AutoMutex _l(mProxyLock);</span><br><span class="line">    <span class="comment">// Someone else&#x27;s...  do we know about it?</span></span><br><span class="line">    jobject <span class="keyword">object</span> = (jobject)<span class="keyword">val</span>-&gt;findObject(&amp;gBinderProxyOffsets);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">object</span> != NULL) &#123;</span><br><span class="line">        jobject res = jniGetReferent(env, <span class="keyword">object</span>);</span><br><span class="line">        <span class="keyword">if</span> (res != NULL) &#123;</span><br><span class="line">            ALOGV(<span class="string">&quot;objectForBinder %p: found existing %p!\n&quot;</span>, <span class="keyword">val</span>.<span class="keyword">get</span>(), res);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">        LOGDEATH(<span class="string">&quot;Proxy object %p of IBinder %p no longer in working set!!!&quot;</span>, <span class="keyword">object</span>, <span class="keyword">val</span>.<span class="keyword">get</span>());</span><br><span class="line">        android_atomic_dec(&amp;gNumProxyRefs);</span><br><span class="line">        <span class="keyword">val</span>-&gt;detachObject(&amp;gBinderProxyOffsets);</span><br><span class="line">        env-&gt;DeleteGlobalRef(<span class="keyword">object</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">object</span> = env-&gt;NewObject(gBinderProxyOffsets.mClass, gBinderProxyOffsets.mConstructor);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">object</span> != NULL) &#123;</span><br><span class="line">        LOGDEATH(<span class="string">&quot;objectForBinder %p: created new proxy %p !\n&quot;</span>, <span class="keyword">val</span>.<span class="keyword">get</span>(), <span class="keyword">object</span>);</span><br><span class="line">        <span class="comment">// The proxy holds a reference to the native object.</span></span><br><span class="line">        env-&gt;SetIntField(<span class="keyword">object</span>, gBinderProxyOffsets.mObject, (int)<span class="keyword">val</span>.<span class="keyword">get</span>());</span><br><span class="line">        <span class="keyword">val</span>-&gt;incStrong((void*)javaObjectForIBinder);</span><br><span class="line">        <span class="comment">// The native object needs to hold a weak reference back to the</span></span><br><span class="line">        <span class="comment">// proxy, so we can retrieve the same proxy if it is still active.</span></span><br><span class="line">        jobject refObject = env-&gt;NewGlobalRef(</span><br><span class="line">                env-&gt;GetObjectField(<span class="keyword">object</span>, gBinderProxyOffsets.mSelf));</span><br><span class="line">        <span class="keyword">val</span>-&gt;attachObject(&amp;gBinderProxyOffsets, refObject,</span><br><span class="line">                jnienv_to_javavm(env), proxy_cleanup);</span><br><span class="line">        <span class="comment">// Also remember the death recipients registered on this proxy</span></span><br><span class="line">        sp&lt;DeathRecipientList&gt; drl = new DeathRecipientList;</span><br><span class="line">        drl-&gt;incStrong((void*)javaObjectForIBinder);</span><br><span class="line">        env-&gt;SetIntField(<span class="keyword">object</span>, gBinderProxyOffsets.mOrgue, reinterpret_cast&lt;jint&gt;(drl.<span class="keyword">get</span>()));</span><br><span class="line">        <span class="comment">// Note that a new object reference has been created.</span></span><br><span class="line">        android_atomic_inc(&amp;gNumProxyRefs);</span><br><span class="line">        incRefsCreated(env);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">object</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回一个句柄值为0的BpBinder对象<br>sp<IBinder> b &#x3D; new BpBinder(0);<br>然后将这个BpBinder对象转换成一个BinderProxy，这样Java层代理类就获得这个对象。<br>说了这么一大坨就是为了方便我们之后获取Binder填好坑。</IBinder></p>
<h4 id="关联startService相关类图"><a href="#关联startService相关类图" class="headerlink" title="关联startService相关类图"></a>关联startService相关类图</h4><p>不难发现startService可以有多个入口调用，原因看如下类图：</p>
<p><img src="/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/img/startService.png"></p>
<ol>
<li><p>Activity、Application、Service都是继承ContextWrapper，其中Service拥有Applcation实例。</p>
</li>
<li><p>在ContextWrapper类中，实现了startService函数。在ContextWrapper类中，有一个成员变量mBase，它是一个ContextImpl实例。</p>
</li>
<li><p>ContextImpl类和ContextWrapper类一样继承于Context类，ContextWrapper类的startService函数最终过调用ContextImpl类的startService函数来实现。这种类设计方法在设计模式里面，就称之为装饰模式（Decorator），或者包装模式（Wrapper）。</p>
</li>
<li><p>在ContextImpl类的startService类，最终又调用了ActivityManagerProxy类的startService来实现启动服务的操作</p>
</li>
</ol>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ComponentName startServiceCommon(Intent service, UserHandle user) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        validateServiceIntent(service);</span><br><span class="line">        service.prepareToLeaveProcess();</span><br><span class="line">        ComponentName <span class="literal">cn</span> = ActivityManagerNative.getDefault().startService(</span><br><span class="line">            mMainThread.getApplicationThread(), service,</span><br><span class="line">            service.resolveTypeIfNeeded(getContentResolver()), user.getIdentifier());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">cn</span> != <span class="built_in">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">cn</span>.getPackageName().<span class="keyword">equals</span>(<span class="string">&quot;!&quot;</span>)) &#123;</span><br><span class="line">                throw <span class="literal">new</span> SecurityException(</span><br><span class="line">                        <span class="string">&quot;Not allowed to start service &quot;</span> + service</span><br><span class="line">                        + <span class="string">&quot; without permission &quot;</span> + <span class="literal">cn</span>.getClassName());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">cn</span>.getPackageName().<span class="keyword">equals</span>(<span class="string">&quot;!!&quot;</span>)) &#123;</span><br><span class="line">                throw <span class="literal">new</span> SecurityException(</span><br><span class="line">                        <span class="string">&quot;Unable to start service &quot;</span> + service</span><br><span class="line">                        + <span class="string">&quot;: &quot;</span> + <span class="literal">cn</span>.getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">cn</span>;</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合ServiceManager和类图我们可以知道ActivityManagerProxy是一个Binder对象的远程接口了，ServiceManagerProxy远程对象是C层的ServiceManager，而ActivityManagerProxy这个Binder远程对象就是ActivityManagerService了。在手机启动时会初始化这个Binder，我们看下源码：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> SystemServer &#123;</span><br><span class="line">    <span class="keyword">private</span> static final String TAG = <span class="string">&quot;SystemServer&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    public static final <span class="built_in">int</span> FACTORY_TEST_OFF = <span class="number">0</span>;</span><br><span class="line">    public static final <span class="built_in">int</span> FACTORY_TEST_LOW_LEVEL = <span class="number">1</span>;</span><br><span class="line">    public static final <span class="built_in">int</span> FACTORY_TEST_HIGH_LEVEL = <span class="number">2</span>;</span><br><span class="line"> </span><br><span class="line">    static Timer timer;</span><br><span class="line">    static final long SNAPSHOT_INTERVAL = <span class="number">60</span><span class="operator"> * </span><span class="number">60</span><span class="operator"> * </span><span class="number">1000</span>; <span class="comment">// 1hr</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// The earliest supported time.  We pick one day into 1970, to</span></span><br><span class="line">    <span class="comment">// give any timezone code room without going into negative time.</span></span><br><span class="line">    <span class="keyword">private</span> static final long EARLIEST_SUPPORTED_TIME = <span class="number">86400</span><span class="operator"> * </span><span class="number">1000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called to initialize native system services.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> static native void native<span class="constructor">Init()</span>;</span><br><span class="line"> </span><br><span class="line">    public static void main(String<span class="literal">[]</span> args) &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * In case the runtime switched since last boot (such as when</span></span><br><span class="line"><span class="comment">         * the old runtime was removed in an OTA), set the system</span></span><br><span class="line"><span class="comment">         * property so that it is in sync. We can&#x27;t do this in</span></span><br><span class="line"><span class="comment">         * libnativehelper&#x27;s JniInvocation::Init code where we already</span></span><br><span class="line"><span class="comment">         * had to fallback to a different runtime because it is</span></span><br><span class="line"><span class="comment">         * running as root and we need to be the system user to set</span></span><br><span class="line"><span class="comment">         * the property. http://b/11463182</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">SystemProperties</span>.</span></span>set(<span class="string">&quot;persist.sys.dalvik.vm.lib&quot;</span>,</span><br><span class="line">                             <span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.vm<span class="constructor">Library()</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span> &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line">            <span class="comment">// If a device&#x27;s clock is before 1970 (before 0), a lot of</span></span><br><span class="line">            <span class="comment">// APIs crash dealing with negative numbers, notably</span></span><br><span class="line">            <span class="comment">// java.io.File#setLastModified, so instead we fake it and</span></span><br><span class="line">            <span class="comment">// hope that time from cell towers or NTP fixes it</span></span><br><span class="line">            <span class="comment">// shortly.</span></span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>w(TAG, <span class="string">&quot;System clock is before 1970; setting to 1970.&quot;</span>);</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">SystemClock</span>.</span></span>set<span class="constructor">CurrentTimeMillis(EARLIEST_SUPPORTED_TIME)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>is<span class="constructor">Enabled()</span>) &#123;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>start<span class="literal">()</span>;</span><br><span class="line">            timer = <span class="keyword">new</span> <span class="constructor">Timer()</span>;</span><br><span class="line">            timer.schedule(<span class="keyword">new</span> <span class="constructor">TimerTask()</span> &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run<span class="literal">()</span> &#123;</span><br><span class="line">                    <span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>write<span class="constructor">Snapshot(<span class="string">&quot;system_server&quot;</span>, <span class="params">null</span>)</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Mmmmmm... more memory!</span></span><br><span class="line">        dalvik.system.<span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.clear<span class="constructor">GrowthLimit()</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// The system server has to run all of the time, so it needs to be</span></span><br><span class="line">        <span class="comment">// as efficient as possible with its memory usage.</span></span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.set<span class="constructor">TargetHeapUtilization(0.8f)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Environment</span>.</span></span>set<span class="constructor">UserRequired(<span class="params">true</span>)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>load<span class="constructor">Library(<span class="string">&quot;android_servers&quot;</span>)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>i(TAG, <span class="string">&quot;Entered the Android system server!&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Initialize native services.</span></span><br><span class="line">        native<span class="constructor">Init()</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// This used to be its own separate thread, but now it is</span></span><br><span class="line">        <span class="comment">// just the loop we run on the main thread.</span></span><br><span class="line">        ServerThread thr = <span class="keyword">new</span> <span class="constructor">ServerThread()</span>;</span><br><span class="line">        thr.init<span class="constructor">AndLoop()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ServerThread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;SystemServer&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENCRYPTING_STATE</span> <span class="operator">=</span> <span class="string">&quot;trigger_restart_min_framework&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENCRYPTED_STATE</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    ContentResolver mContentResolver;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reportWtf</span><span class="params">(String msg, Throwable e)</span> &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;***********************************************&quot;</span>);</span><br><span class="line">        Log.wtf(TAG, <span class="string">&quot;BOOT FAILURE &quot;</span> + msg, e);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initAndLoop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">            context = ActivityManagerService.main(factoryTest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;************ Failure starting bootstrap service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            ActivityManagerService.setSystemProcess();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;************ Failure starting core service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>系统启动时，会通过ActivityManagerService.main()创建出实例，通过ActivityManagerService.setSystemProcess();将服务添加到Service Manager中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title class_">ActivityManagerNative</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Context <span class="title function_">main</span><span class="params">(<span class="type">int</span> factoryTest)</span> &#123;</span><br><span class="line">        <span class="type">AThread</span> <span class="variable">thr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AThread</span>();</span><br><span class="line">        thr.start();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">synchronized</span> (thr) &#123;</span><br><span class="line">                <span class="keyword">while</span> (thr.mService == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        thr.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="type">ActivityManagerService</span> <span class="variable">m</span> <span class="operator">=</span> thr.mService;</span><br><span class="line">        mSelf = m;</span><br><span class="line">     </span><br><span class="line">        ...</span><br><span class="line"> </span><br><span class="line">        m.startRunning(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setSystemProcess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ActivityManagerService</span> <span class="variable">m</span> <span class="operator">=</span> mSelf;</span><br><span class="line"> </span><br><span class="line">                ServiceManager.addService(Context.ACTIVITY_SERVICE, m, <span class="literal">true</span>);</span><br><span class="line">                ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                <span class="string">&quot;Unable to find android system package&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就把ActivityManagerService这个Binder添加到Service Manager中，之后通信的时候，需要通过代理去获取它。这样ActivityManagerService就启动了。</p>
<ol>
<li><p>现在知道ActivityManagerProxy.startService是通过ActivityManagerService的startService</p>
</li>
<li><p>ActivityManagerProxy的mBinder持有ActivityManagerService Binder的引用，执行接口赋予的功能</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/17/%E7%A0%94%E7%A9%B6Notification/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/17/%E7%A0%94%E7%A9%B6Notification/" class="post-title-link" itemprop="url">研究Notification时想知道的进程间通信Binder机制在应用程序框架层的Java接口源代码分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-17 15:20:55" itemprop="dateCreated datePublished" datetime="2017-03-17T15:20:55+08:00">2017-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:35:00" itemprop="dateModified" datetime="2022-05-11T14:35:00+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="问题来源"><a href="#问题来源" class="headerlink" title="问题来源"></a>问题来源</h4><p>在调研notification时，这里涉及多个进程间的通信。并且在调研push通知开关状态时，涉及到framework的源码分析。所有，对系统想做一个系统的分析学习。</p>
<p>在framework&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;SystemServer.java中</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> SystemServer &#123;<span class="operator"></span></span><br><span class="line"><span class="operator"> </span></span><br><span class="line"><span class="operator"> </span></span><br><span class="line"><span class="operator">...</span></span><br><span class="line"><span class="operator"></span>...</span><br><span class="line">    <span class="keyword">private</span> static native void native<span class="constructor">Init()</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    public static void main(String<span class="literal">[]</span> args) &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">SystemProperties</span>.</span></span>set(<span class="string">&quot;persist.sys.dalvik.vm.lib&quot;</span>,</span><br><span class="line"> </span><br><span class="line">                             <span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.vm<span class="constructor">Library()</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span> &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>w(TAG, <span class="string">&quot;System clock is before 1970; setting to 1970.&quot;</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">SystemClock</span>.</span></span>set<span class="constructor">CurrentTimeMillis(EARLIEST_SUPPORTED_TIME)</span>;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>is<span class="constructor">Enabled()</span>) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>start<span class="literal">()</span>;</span><br><span class="line"> </span><br><span class="line">            timer = <span class="keyword">new</span> <span class="constructor">Timer()</span>;</span><br><span class="line"> </span><br><span class="line">            timer.schedule(<span class="keyword">new</span> <span class="constructor">TimerTask()</span> &#123;</span><br><span class="line"> </span><br><span class="line">                @Override</span><br><span class="line"> </span><br><span class="line">                public void run<span class="literal">()</span> &#123;</span><br><span class="line"> </span><br><span class="line">                    <span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>write<span class="constructor">Snapshot(<span class="string">&quot;system_server&quot;</span>, <span class="params">null</span>)</span>;</span><br><span class="line"> </span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">            &#125;, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Mmmmmm... more memory!</span></span><br><span class="line"> </span><br><span class="line">        dalvik.system.<span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.clear<span class="constructor">GrowthLimit()</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// The system server has to run all of the time, so it needs to be</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">// as efficient as possible with its memory usage.</span></span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.set<span class="constructor">TargetHeapUtilization(0.8f)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Environment</span>.</span></span>set<span class="constructor">UserRequired(<span class="params">true</span>)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>load<span class="constructor">Library(<span class="string">&quot;android_servers&quot;</span>)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>i(TAG, <span class="string">&quot;Entered the Android system server!&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Initialize native services.</span></span><br><span class="line"> </span><br><span class="line">        native<span class="constructor">Init()</span>;</span><br><span class="line">        <span class="comment">// This used to be its own separate thread, but now it is</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">// just the loop we run on the main thread.</span></span><br><span class="line"> </span><br><span class="line">        ServerThread thr = <span class="keyword">new</span> <span class="constructor">ServerThread()</span>;</span><br><span class="line"> </span><br><span class="line">        thr.init<span class="constructor">AndLoop()</span>;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>这里存在一个java的main函数的入口，这个是初始化应用层相关服务的，我们分析initAndLoop，这个方法里面包含初始化各种系统的Service，而这些都是通过ServiceManager去做的。</p>
<p>我们需要获取的ServiceManager的Java远程接口是一个ServiceManagerProxy对象的IServiceManager接口。ServiceManagerProxy类图结构：</p>
<p><img src="/2017/03/17/%E7%A0%94%E7%A9%B6Notification/img/ClassDiagram1.png"></p>
<p>从上图可以知道ServiceManagerProxy类实现了IServiceManager接口，IServiceManager提供了getService和addService两个成员方法来管理系统中的Service。在ServiceManagerProxy类的构造函数可以得知需要一个BinderProxy对象的IBinder接口来作为参数。因此，要获取ServiceManager的Java远程接口ServiceManagerProxy，首先要有一个BinderProxy对象。BinderProxy对象是如何获得的？</p>
<p>我们先看看ServiceManager里面做了些什么</p>
<p><img src="/2017/03/17/%E7%A0%94%E7%A9%B6Notification/img/Main.png"></p>
<p>我想知道这些Service是如何去通信的，我们看下在ServiceManager中的代码</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @hide */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ServiceManager</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">String</span> TAG = <span class="string">&quot;ServiceManager&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IServiceManager sServiceManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">HashMap</span>&lt;<span class="built_in">String</span>, IBinder&gt; sCache = <span class="keyword">new </span><span class="class title_">HashMap</span>&lt;<span class="built_in">String</span>, IBinder&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title function_">getIServiceManager</span>() &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (sServiceManager != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> sServiceManager;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Find the service manager</span></span><br><span class="line">        sServiceManager = ServiceManagerNative.<span class="property">asInterface</span>(BinderInternal.<span class="property">getContextObject</span>());</span><br><span class="line">        <span class="keyword">return</span> sServiceManager;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面贴出了ServiceManager的一个静态方法<br>getIServiceManager<br>这个方法是获取Java远程接口，getIServiceManager内部是通过方法<br>ServiceManagerNative.asInterface(BinderInternal.getContextObject())<br>去获取远程接口。在调用ServiceManagerNative.asInterface方法之前是需要传入一个参数，这个参数是<br>BinderInternal.getContextObject()返回的值。我们看下这个方法到底是什么鬼：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * Private and debugging Binder APIs.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * @see IBinder</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinderInternal</span> &#123;</span><br><span class="line">  </span><br><span class="line">...</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * Return the global &quot;context object&quot; of the system.  This is usually</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * an implementation of IServiceManager, which you can use to find</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * other services.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">native</span> IBinder getContextObject();</span><br><span class="line">  </span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BinderInternal.getContextObject是一个JNI方法，返回的值是IBinder类型，在framework搜索这个方法的JNI实现</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static jobject android<span class="constructor">_os_BinderInternal_getContextObject(JNIEnv<span class="operator">*</span> <span class="params">env</span>, <span class="params">jobject</span> <span class="params">clazz</span>)</span></span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::self<span class="literal">()</span>-&gt;get<span class="constructor">ContextObject(NULL)</span>;</span><br><span class="line"> </span><br><span class="line">    return java<span class="constructor">ObjectForIBinder(<span class="params">env</span>, <span class="params">b</span>)</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是调用ProcessState::self函数，self函数是ProcessState的静态成员函数，它的作用是返回一个全局唯一的ProcessState实例变量，就是单例模式了，这个变量名为gProcess。如果gProcess尚未创建，就会执行创建操作，在ProcessState的构造函数中，会通过open文件操作函数打开设备文件&#x2F;dev&#x2F;binder，并且返回来的设备文件描述符保存在成员变量mDriverFD中。<br>接着调用gProcess-&gt;getContextObject函数来获得一个句柄值为0的Binder引用，即BpBinder了,相似的代码：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; b <span class="operator">=</span> new BpBinder(<span class="number">0</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>我们在看看ServiceManagerNative.asInterface里面的代码</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * Native implementation of the service manager.  Most clients will only</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * care about getDefault() and possibly asInterface().</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * @hide</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="title">implements</span> <span class="title">IServiceManager</span></span></span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * Cast a Binder object into a service manager interface, generating</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * a proxy if needed.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"> </span><br><span class="line">    static public <span class="type">IServiceManager</span> asInterface(<span class="type">IBinder</span> obj)</span><br><span class="line"> </span><br><span class="line">    &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="type">IServiceManager</span> in = (<span class="type">IServiceManager</span>)obj.queryLocalInterface(descriptor);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">ServiceManagerProxy</span>(obj);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在静态方法asInterface里面需要一个IBinder的参数，就是一个代理对象，如果当地不存在描述的IServiceManager那么就通过这个BinderProxy去创建一个。</p>
<p>那我们在创建AIDL文件时，系统到底做了什么？</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/16/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/02/16/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/" class="post-title-link" itemprop="url">下载模块多线程实现之路</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-02-16 16:22:10" itemprop="dateCreated datePublished" datetime="2017-02-16T16:22:10+08:00">2017-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:35:00" itemprop="dateModified" datetime="2022-05-11T14:35:00+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>  春节过后，渐渐进入了工作的状态。在这些天中，主动提出要优化公司产品的下载模块多线程，目前产品是多任务单线程下载模式，这样一旦网络不行的情况下，下载会变的异常或者缓慢。加入文件的多线程下载是每个下载模块的标配了，之前也没有接触这块，所以也算是给自己一个挑战吧。</p>
<h4 id="对下载模块的Api使用"><a href="#对下载模块的Api使用" class="headerlink" title="对下载模块的Api使用"></a>对下载模块的Api使用</h4><ol>
<li>一个模块简单易用是最基本的要求</li>
<li>配置简单</li>
</ol>
<h4 id="分析梳理现有的模块和思路"><a href="#分析梳理现有的模块和思路" class="headerlink" title="分析梳理现有的模块和思路"></a>分析梳理现有的模块和思路</h4><p>大致的任务启动分析路径</p>
<p>![](.&#x2F;%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF&#x2F;img&#x2F;FlowchartDiagram下载模块流程图.png %}</p>
<h4 id="多线程下载原理"><a href="#多线程下载原理" class="headerlink" title="多线程下载原理"></a>多线程下载原理</h4><ol>
<li>多线程下载是将文件分成多段，然后从分割段开始下载，多线程需要服务器支持断点续传特性。</li>
<li>文件存储和IO，关于文件存储写入的问题也有很多方案，目前采用的方案是预创建整个文件大小，然后利用文件的seek找到对应指针的位置。</li>
<li>对于每个任务我们会有一张表记录每个任务中的线程下载记录，然后同步数据从而实现多线程的文件下载，每个任务ID对应其任务的线程。</li>
<li>多线程不可避免会出现线程同步问题，基本做法是当前线程需要知道兄弟线程下载的状态，我们定义了一组线程间状态读取接口，同步线程数组锁，询问兄弟线程isCompleteForOthers</li>
<li>为了更好的承接上层业务我们封装了业务层，使接入成本降低</li>
</ol>
<p>实现多线程核心类图构成：</p>
<p><img src="/2017/02/16/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/img/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%B1%BB%E5%9B%BE.png"></p>
<h4 id="文件IO"><a href="#文件IO" class="headerlink" title="文件IO"></a>文件IO</h4><p>对于文件IO这块，我们使用了Okio做为文件IO的底层工具，使用RandomAccessFile来实现文件的seek，从而实现文件的断点操作。为了最大化的加快文件的写入操作，我们加入了文件的预创建过程。</p>
<p><img src="/2017/02/16/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/img/Thread-write.png"></p>
<h4 id="IO性能测试"><a href="#IO性能测试" class="headerlink" title="IO性能测试"></a>IO性能测试</h4><p>这里的测试数据是将内存中的10MB的数据写入到磁盘的平均时间</p>
<table>
<thead>
<tr>
<th>FileOutputStream</th>
<th>BufferedOutputStream</th>
<th>RandomAccessFile</th>
<th>BufferedSink</th>
</tr>
</thead>
<tbody><tr>
<td>2983</td>
<td>2461</td>
<td>2369</td>
<td>2369</td>
</tr>
<tr>
<td>2493</td>
<td>5073</td>
<td>2430</td>
<td>2393</td>
</tr>
<tr>
<td>2780</td>
<td>2460</td>
<td>2421</td>
<td>2389</td>
</tr>
<tr>
<td>2492</td>
<td>2966</td>
<td>2427</td>
<td>2361</td>
</tr>
<tr>
<td>2870</td>
<td>2501</td>
<td>2570</td>
<td>2365</td>
</tr>
<tr>
<td>2490</td>
<td>3011</td>
<td>2430</td>
<td>2372</td>
</tr>
<tr>
<td>2963</td>
<td>2559</td>
<td>2400</td>
<td>2361</td>
</tr>
<tr>
<td>2493</td>
<td>2446</td>
<td>2438</td>
<td>2346</td>
</tr>
<tr>
<td>2615</td>
<td>4811</td>
<td>2400</td>
<td>2367</td>
</tr>
<tr>
<td>2518</td>
<td>3010</td>
<td>2398</td>
<td>2344</td>
</tr>
</tbody></table>
<p>平均值：</p>
<table>
<thead>
<tr>
<th>2669.7</th>
<th>3129.8</th>
<th>2428.3</th>
<th>2366.7</th>
</tr>
</thead>
</table>
<p>这里的测试环境是有一个文件输入流，一个文件的输出流，然后每次读取相同的BUFFER_SIZE &#x3D; 1024 * 8       来测试IO性能</p>
<table>
<thead>
<tr>
<th>FileOutputStream</th>
<th>BufferedOutputStream</th>
<th>RandomAccessFile</th>
<th>BufferedSink</th>
</tr>
</thead>
<tbody><tr>
<td>2144</td>
<td>2162</td>
<td>2265</td>
<td>2313</td>
</tr>
<tr>
<td>2447</td>
<td>3991</td>
<td>2205</td>
<td>2313</td>
</tr>
<tr>
<td>2211</td>
<td>2241</td>
<td>2196</td>
<td>2309</td>
</tr>
<tr>
<td>2474</td>
<td>2276</td>
<td>2191</td>
<td>2293</td>
</tr>
<tr>
<td>2230</td>
<td>2446</td>
<td>2184</td>
<td>2338</td>
</tr>
<tr>
<td>3305</td>
<td>2305</td>
<td>2201</td>
<td>2329</td>
</tr>
<tr>
<td>4772</td>
<td>2191</td>
<td>2827</td>
<td>2271</td>
</tr>
<tr>
<td>2418</td>
<td>2304</td>
<td>2795</td>
<td>2294</td>
</tr>
<tr>
<td>2319</td>
<td>2204</td>
<td>2166</td>
<td>2279</td>
</tr>
<tr>
<td>2316</td>
<td>2261</td>
<td>2797</td>
<td>2244</td>
</tr>
</tbody></table>
<p>平均值：</p>
<table>
<thead>
<tr>
<th>2663.6</th>
<th>2438.1</th>
<th>2382.7</th>
<th>2298.3</th>
</tr>
</thead>
</table>
<p>可以从上面的数据看出，使用Okio文件写入非常稳定。</p>
<h4 id="预创建文件"><a href="#预创建文件" class="headerlink" title="预创建文件"></a>预创建文件</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> KBSIZE = <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> MBSIZE1 = <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> MBSIZE10 = <span class="number">1024</span>L * <span class="number">1024</span> * <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> createFile(<span class="keyword">File</span> <span class="keyword">file</span>, <span class="keyword">long</span> fileLength, <span class="keyword">final</span> ValueCallback valueCallback) &#123;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">file</span>.exists()) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> ret = <span class="keyword">file</span>.createNewFile();</span><br><span class="line">            <span class="keyword">if</span> (!ret) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> batchSize = <span class="number">0</span>;</span><br><span class="line">        batchSize = fileLength;</span><br><span class="line">        <span class="keyword">if</span> (fileLength &gt; KBSIZE) &#123;</span><br><span class="line">            batchSize = KBSIZE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fileLength &gt; MBSIZE1) &#123;</span><br><span class="line">            batchSize = MBSIZE1;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fileLength &gt; MBSIZE10) &#123;</span><br><span class="line">            batchSize = MBSIZE10;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">count</span> = fileLength / batchSize;</span><br><span class="line">        <span class="keyword">long</span> last = fileLength % batchSize;</span><br><span class="line"></span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(<span class="keyword">file</span>);</span><br><span class="line">        FileChannel fileChannel = fos.getChannel();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; <span class="keyword">count</span>; i++) &#123;</span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocate((<span class="keyword">int</span>) batchSize);</span><br><span class="line">            fileChannel.<span class="keyword">write</span>(buffer);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">3</span> == <span class="number">0</span> &amp;&amp; valueCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">float</span> x = i;</span><br><span class="line">                <span class="keyword">float</span> y = <span class="keyword">count</span>;</span><br><span class="line">                <span class="keyword">int</span> progress = (<span class="keyword">int</span>) ((x / y) * <span class="number">100</span>);</span><br><span class="line">                valueCallback.onReceiveValue(progress);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate((<span class="keyword">int</span>) last);</span><br><span class="line">        fileChannel.<span class="keyword">write</span>(buffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valueCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            valueCallback.onReceiveValue(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                fos.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="测试用例图"><a href="#测试用例图" class="headerlink" title="测试用例图"></a>测试用例图</h4><p><img src="/2017/02/16/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/img/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97Test.png"></p>
<p>开始一个任务，上层任务保留了文件的基本特性，使用方式：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void start<span class="constructor">Task(String <span class="params">url</span>, String <span class="params">contentDisposition</span>, String <span class="params">mimetype</span>)</span> &#123;</span><br><span class="line">        String mT = <span class="module-access"><span class="module"><span class="identifier">MimeUtils</span>.</span></span>guess<span class="constructor">MimeTypeFromExtension(MimeUtils.<span class="params">getFileExtensionFromFileName</span>(MimeUtils.<span class="params">guessFileName</span>(<span class="params">url</span>, <span class="params">contentDisposition</span>, <span class="params">mimetype</span>)</span>));</span><br><span class="line">        ProDownloadRequest request = <span class="keyword">new</span> ProDownloadRequest.<span class="constructor">Builder()</span></span><br><span class="line">                .url(url)</span><br><span class="line">                .title(<span class="module-access"><span class="module"><span class="identifier">MimeUtils</span>.</span></span>guess<span class="constructor">FileName(<span class="params">url</span>, <span class="params">contentDisposition</span>, <span class="params">mimetype</span>)</span>)</span><br><span class="line">                .<span class="built_in">ref</span><span class="constructor">Url(<span class="params">url</span>)</span></span><br><span class="line">                .mime<span class="constructor">Type(StringUtils.<span class="params">isEmpty</span>(<span class="params">mT</span>)</span> ? mimetype : mT)</span><br><span class="line">                .build<span class="literal">()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">ProDownloadManager</span>.</span></span>get<span class="constructor">Instance()</span>.create<span class="constructor">Task(<span class="params">request</span>)</span>.add<span class="constructor">OnStateChangeListener(<span class="params">new</span> OnStateChangeListener()</span> &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void on<span class="constructor">StateChange(ProDownloadTask <span class="params">task</span>, <span class="params">int</span> <span class="params">status</span>, <span class="params">long</span> <span class="params">sofar</span>, <span class="params">long</span> <span class="params">total</span>)</span> &#123;</span><br><span class="line">                <span class="comment">//your code</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start<span class="literal">()</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/08/2017%E6%88%91%E7%9A%84%E8%AE%A1%E5%88%92%EF%BC%8C%E8%87%AA%E6%88%91%E6%88%90%E9%95%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/02/08/2017%E6%88%91%E7%9A%84%E8%AE%A1%E5%88%92%EF%BC%8C%E8%87%AA%E6%88%91%E6%88%90%E9%95%BF/" class="post-title-link" itemprop="url">2017我的计划，自我成长</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-02-08 15:00:46" itemprop="dateCreated datePublished" datetime="2017-02-08T15:00:46+08:00">2017-02-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2017-08-23 15:55:16" itemprop="dateModified" datetime="2017-08-23T15:55:16+08:00">2017-08-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>去年浪费了许多时间，很多自己想要做的事情偷懒没有做，或者总因为工作忙的原因而搁置。我是一个不甘安逸、不服输的人。2017刚开始，我需要有一个自己的目标，这个目标并不是要在工作中有多少突破，而是我希望自己更好的规划自己的时间，留出一部分时间做自己想要去做的事情。       </p>
<h4 id="几天的一个人的日子"><a href="#几天的一个人的日子" class="headerlink" title="几天的一个人的日子"></a>几天的一个人的日子</h4><p>   初八回广州，一个人，第一次感觉到了孤单，什么也不想做，什么也不去想。甚至我陪一直着一只流浪猫玩。经过几天的，我开始想起自己当初想要的日子，人生需要计划，需要去实践，更需要恒心。</p>
<h4 id="多写写自己的博客"><a href="#多写写自己的博客" class="headerlink" title="多写写自己的博客"></a>多写写自己的博客</h4><p>   在工作中，很多东西都没能仔细深探究，总是徘徊在完成任务。现在自己逐渐突破了这个，对于一个项目我都会去查看其细节，然后写自己的分析，记录下来。</p>
<h4 id="多花时间看书"><a href="#多花时间看书" class="headerlink" title="多花时间看书"></a>多花时间看书</h4><p>   之前的工作习惯，都会不定时看书，现在看书的频率很低。这里给自己一个定一个目标，看完一本一位博主写的Android开发总结，并自己也写下自己的分析理解。</p>
<h4 id="少玩游戏，最好不玩"><a href="#少玩游戏，最好不玩" class="headerlink" title="少玩游戏，最好不玩"></a>少玩游戏，最好不玩</h4><p>   我自己比较贪玩，经常会玩游戏而忘记一切，不服输的态度让我一晚就停不下来，现在自己玩游戏也渐渐很少了。多用这些时间看看电影，出去和朋友聊聊天。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/12/%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%92%8C%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/01/12/%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%92%8C%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">二维码实现和优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-01-12 14:42:03" itemprop="dateCreated datePublished" datetime="2017-01-12T14:42:03+08:00">2017-01-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 11:47:06" itemprop="dateModified" datetime="2022-05-11T11:47:06+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>由于项目需要，我对接二维码模块，经过自己的优化，目前效果还不错，网上给出的方案大多数都是复制过来的，没有经过深度思考。所以我决定纪录下来自己优化的地方，供以后自己参考。</p>
<h4 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h4><p><a target="_blank" rel="noopener" href="https://github.com/10045125/QrCode">github-vanda-伍中联-QrCode</a></p>
<h4 id="二维码模块"><a href="#二维码模块" class="headerlink" title="二维码模块"></a>二维码模块</h4><p>   二维码这块经过了初步的封装处理，没有Activity，没有Fragment，只有View，最终使用二维码的形式如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title class_">QrCodeView</span> mQrCodeView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="built_in">void</span> <span class="title function_">onCreate</span>(<span class="params">Bundle savedInstanceState</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onCreate</span>(savedInstanceState);</span><br><span class="line"></span><br><span class="line">    mQrCodeView = <span class="keyword">new</span> <span class="title class_">QrCodeView</span>(<span class="variable language_">this</span>, <span class="literal">null</span>);</span><br><span class="line">    mQrCodeView.<span class="title function_">registerResultCallback</span>(<span class="variable language_">this</span>);</span><br><span class="line">    mQrCodeView.<span class="title function_">setText</span>(<span class="title function_">getString</span>(R.<span class="property">string</span>.<span class="property">qrcode_desc</span>));</span><br><span class="line"></span><br><span class="line">    <span class="title function_">setContentView</span>(mQrCodeView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onPause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onPause</span>();</span><br><span class="line">    <span class="keyword">if</span> (mQrCodeView != <span class="literal">null</span>) &#123;</span><br><span class="line">        mQrCodeView.<span class="title function_">onPause</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onResume</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onResume</span>();</span><br><span class="line">    <span class="keyword">if</span> (mQrCodeView != <span class="literal">null</span>) &#123;</span><br><span class="line">        mQrCodeView.<span class="title function_">onResume</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onDestroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">onDestroy</span>();</span><br><span class="line">    <span class="keyword">if</span> (mQrCodeView != <span class="literal">null</span>) &#123;</span><br><span class="line">        mQrCodeView.<span class="title function_">onDestroy</span>();</span><br><span class="line">        mQrCodeView = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onResultCallback</span>(<span class="params">Result result</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mQrCodeView != <span class="literal">null</span>) &#123;</span><br><span class="line">            mQrCodeView.<span class="title function_">onPause</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> android.<span class="property">support</span>.<span class="property">v7</span>.<span class="property">app</span>.<span class="property">AlertDialog</span>.<span class="title class_">Builder</span>(<span class="variable language_">this</span>).<span class="title function_">setTitle</span>(result.<span class="title function_">getText</span>())</span><br><span class="line">                .<span class="title function_">setCancelable</span>(<span class="literal">true</span>)</span><br><span class="line">                .<span class="title function_">setOnDismissListener</span>(<span class="keyword">new</span> <span class="title class_">DialogInterface</span>.<span class="title class_">OnDismissListener</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">onDismiss</span>(<span class="params">DialogInterface dialogInterface</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mQrCodeView != <span class="literal">null</span>) &#123;</span><br><span class="line">                            mQrCodeView.<span class="title function_">onResume</span>();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).<span class="title function_">create</span>().<span class="title function_">show</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>二维码使用了zxing库，我保留了二维码和条形码的和一些常用的格式</li>
<li>大多数项目要求是竖屏进行扫描，本优化是针对竖屏下的优化</li>
</ol>
<h4 id="相机的拍摄图像的原始数据图像"><a href="#相机的拍摄图像的原始数据图像" class="headerlink" title="相机的拍摄图像的原始数据图像"></a>相机的拍摄图像的原始数据图像</h4><p>相机回调的原始数据图像是横着的。回调代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPreviewFrame</span><span class="params">(<span class="type">byte</span>[] data, Camera camera)</span> &#123;</span><br><span class="line">    <span class="type">Point</span> <span class="variable">cameraResolution</span> <span class="operator">=</span> configManager.getCameraResolution();</span><br><span class="line">    <span class="keyword">if</span> (!useOneShotPreviewCallback) &#123;</span><br><span class="line">        camera.setPreviewCallback(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (previewHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> previewHandler.obtainMessage(previewMessage, cameraResolution.x,</span><br><span class="line">                cameraResolution.y, data);</span><br><span class="line">        message.sendToTarget();</span><br><span class="line">        previewHandler = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Got preview callback, but no handler for it&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>byte[] data这个是预览图中的相机的原始数据，这个数据是比较大的，原始图像如下：</p>
<p><img src="/2017/01/12/%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%92%8C%E4%BC%98%E5%8C%96/img/out.jpg"></p>
<p>这个是原始图像，这个图像是横着的，然后我们需要对这张图片做出相应的处理。</p>
<h4 id="如何处理相机获取来的图片"><a href="#如何处理相机获取来的图片" class="headerlink" title="如何处理相机获取来的图片"></a>如何处理相机获取来的图片</h4><p>我Google了很多关于二维码竖屏下的实现方案，给出网上一大片的实现方案（这种方案没有仔细思考，也反映了国内程序员们的急躁）：</p>
<ol>
<li>图片是横着的，那么就需要将相机图像摆正</li>
<li>显示在手机屏幕上摆正只是相机显示，最终回调的图片数据还是横着的，所以还需要转换图像为竖屏的（这个数据量是比较大的）</li>
<li>根据二维码框对应手机屏幕位置找到图片相对位置</li>
<li>找到对应的位置进行裁剪</li>
<li>交给解码库解码</li>
</ol>
<p>我针对以上的点做出代码上的说明：</p>
<ol>
<li>图片是横着的，那么就需要将相机图像摆正，需要找到正确的相机方向，这段代码就是找到相机方向</li>
</ol>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reads, one time, values from the camera that are needed by the app.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">void init<span class="constructor">FromCameraParameters(OpenCamera <span class="params">camera</span>)</span> &#123;</span><br><span class="line">  Camera.Parameters parameters = camera.get<span class="constructor">Camera()</span>.get<span class="constructor">Parameters()</span>;</span><br><span class="line">  WindowManager manager = (WindowManager) context.get<span class="constructor">SystemService(Context.WINDOW_SERVICE)</span>;</span><br><span class="line">  Display display = manager.get<span class="constructor">DefaultDisplay()</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="built_in">int</span> displayRotation = display.get<span class="constructor">Rotation()</span>;</span><br><span class="line">  <span class="built_in">int</span> cwRotationFromNaturalToDisplay;</span><br><span class="line">  switch (displayRotation) &#123;</span><br><span class="line">    case Surface.ROTATION_0:</span><br><span class="line">      cwRotationFromNaturalToDisplay = <span class="number">0</span>;</span><br><span class="line">      break;</span><br><span class="line">    case Surface.ROTATION_90:</span><br><span class="line">      cwRotationFromNaturalToDisplay = <span class="number">90</span>;</span><br><span class="line">      break;</span><br><span class="line">    case Surface.ROTATION_180:</span><br><span class="line">      cwRotationFromNaturalToDisplay = <span class="number">180</span>;</span><br><span class="line">      break;</span><br><span class="line">    case Surface.ROTATION_270:</span><br><span class="line">      cwRotationFromNaturalToDisplay = <span class="number">270</span>;</span><br><span class="line">      break;</span><br><span class="line">    default:</span><br><span class="line">      <span class="comment">// Have seen this return incorrect values like -90</span></span><br><span class="line">      <span class="keyword">if</span> (displayRotation % <span class="number">90</span><span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">        cwRotationFromNaturalToDisplay = (<span class="number">360</span> + displayRotation) % <span class="number">360</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        throw <span class="keyword">new</span> <span class="constructor">IllegalArgumentException(<span class="string">&quot;Bad rotation: &quot;</span> + <span class="params">displayRotation</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Display at: &quot;</span> + cwRotationFromNaturalToDisplay);</span><br><span class="line"> </span><br><span class="line">  <span class="built_in">int</span> cwRotationFromNaturalToCamera = camera.get<span class="constructor">Orientation()</span>;</span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Camera at: &quot;</span> + cwRotationFromNaturalToCamera);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Still not 100% sure about this. But acts like we need to flip this:</span></span><br><span class="line">  <span class="keyword">if</span> (camera.get<span class="constructor">Facing()</span><span class="operator"> == </span>CameraFacing.FRONT) &#123;</span><br><span class="line">    cwRotationFromNaturalToCamera = (<span class="number">360</span> - cwRotationFromNaturalToCamera) % <span class="number">360</span>;</span><br><span class="line">    <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Front camera overriden to: &quot;</span> + cwRotationFromNaturalToCamera);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);</span></span><br><span class="line"><span class="comment">  String overrideRotationString;</span></span><br><span class="line"><span class="comment">  if (camera.getFacing() == CameraFacing.FRONT) &#123;</span></span><br><span class="line"><span class="comment">    overrideRotationString = prefs.getString(Config.KEY_FORCE_CAMERA_ORIENTATION_FRONT, null);</span></span><br><span class="line"><span class="comment">  &#125; else &#123;</span></span><br><span class="line"><span class="comment">    overrideRotationString = prefs.getString(Config.KEY_FORCE_CAMERA_ORIENTATION, null);</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">  if (overrideRotationString != null &amp;&amp; !&quot;-&quot;.equals(overrideRotationString)) &#123;</span></span><br><span class="line"><span class="comment">    Log.i(TAG, &quot;Overriding camera manually to &quot; + overrideRotationString);</span></span><br><span class="line"><span class="comment">    cwRotationFromNaturalToCamera = Integer.parseInt(overrideRotationString);</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"> </span><br><span class="line">  cwRotationFromDisplayToCamera =</span><br><span class="line">      (<span class="number">360</span> + cwRotationFromNaturalToCamera - cwRotationFromNaturalToDisplay) % <span class="number">360</span>;</span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Final display orientation: &quot;</span> + cwRotationFromDisplayToCamera);</span><br><span class="line">  <span class="keyword">if</span> (camera.get<span class="constructor">Facing()</span><span class="operator"> == </span>CameraFacing.FRONT) &#123;</span><br><span class="line">    <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Compensating rotation for front camera&quot;</span>);</span><br><span class="line">    cwNeededRotation = (<span class="number">360</span> - cwRotationFromDisplayToCamera) % <span class="number">360</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cwNeededRotation = cwRotationFromDisplayToCamera;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Clockwise rotation from display to camera: &quot;</span> + cwNeededRotation);</span><br><span class="line"> </span><br><span class="line">  Point theScreenResolution = <span class="keyword">new</span> <span class="constructor">Point()</span>;</span><br><span class="line">  display.get<span class="constructor">Size(<span class="params">theScreenResolution</span>)</span>;</span><br><span class="line">  screenResolution = theScreenResolution;</span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Screen resolution in current orientation: &quot;</span> + screenResolution);</span><br><span class="line">  cameraResolution = <span class="module-access"><span class="module"><span class="identifier">CameraConfigurationUtils</span>.</span></span>find<span class="constructor">BestPreviewSizeValue(<span class="params">parameters</span>, <span class="params">screenResolution</span>)</span>;</span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Camera resolution: &quot;</span> + cameraResolution);</span><br><span class="line">  bestPreviewSize = <span class="module-access"><span class="module"><span class="identifier">CameraConfigurationUtils</span>.</span></span>find<span class="constructor">BestPreviewSizeValue(<span class="params">parameters</span>, <span class="params">screenResolution</span>)</span>;</span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Best available preview size: &quot;</span> + bestPreviewSize);</span><br><span class="line"> </span><br><span class="line">  boolean isScreenPortrait = screenResolution.x &lt; screenResolution.y;</span><br><span class="line">  boolean isPreviewSizePortrait = bestPreviewSize.x &lt; bestPreviewSize.y;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (isScreenPortrait<span class="operator"> == </span>isPreviewSizePortrait) &#123;</span><br><span class="line">    previewSizeOnScreen = bestPreviewSize;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    previewSizeOnScreen = <span class="keyword">new</span> <span class="constructor">Point(<span class="params">bestPreviewSize</span>.<span class="params">y</span>, <span class="params">bestPreviewSize</span>.<span class="params">x</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Preview size on screen: &quot;</span> + previewSizeOnScreen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置相机的参数</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void set<span class="constructor">DesiredCameraParameters(OpenCamera <span class="params">camera</span>, <span class="params">boolean</span> <span class="params">safeMode</span>)</span> &#123;</span><br><span class="line">  Camera theCamera = camera.get<span class="constructor">Camera()</span>;</span><br><span class="line">  Camera.Parameters parameters = theCamera.get<span class="constructor">Parameters()</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(TAG, <span class="string">&quot;Setting preview size: &quot;</span> + cameraResolution);</span><br><span class="line">  parameters.set<span class="constructor">PreviewSize(<span class="params">cameraResolution</span>.<span class="params">x</span>, <span class="params">cameraResolution</span>.<span class="params">y</span>)</span>;</span><br><span class="line">  set<span class="constructor">Flash(<span class="params">parameters</span>)</span>;</span><br><span class="line">  set<span class="constructor">Zoom(<span class="params">parameters</span>)</span>;</span><br><span class="line">  theCamera.set<span class="constructor">DisplayOrientation(<span class="params">cwNeededRotation</span>)</span>;</span><br><span class="line">  theCamera.set<span class="constructor">Parameters(<span class="params">parameters</span>)</span>;</span><br><span class="line"> </span><br><span class="line">  Camera.Size afterSize = parameters.get<span class="constructor">PreviewSize()</span>;</span><br><span class="line">  <span class="keyword">if</span> (afterSize != null<span class="operator"> &amp;&amp; </span>(bestPreviewSize.x != afterSize.width<span class="operator"> || </span>bestPreviewSize.y != afterSize.height)) &#123;</span><br><span class="line">    <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>w(TAG, <span class="string">&quot;Camera said it supported preview size &quot;</span> + bestPreviewSize.x + <span class="character">&#x27;x&#x27;</span> + bestPreviewSize.y +</span><br><span class="line">        <span class="string">&quot;, but after setting it, preview size is &quot;</span> + afterSize.width + <span class="character">&#x27;x&#x27;</span> + afterSize.height);</span><br><span class="line">    bestPreviewSize.x = afterSize.width;</span><br><span class="line">    bestPreviewSize.y = afterSize.height;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就能够正确的显示相机拍摄的图片。</p>
<ol start="2">
<li>显示在手机屏幕上摆正只是相机显示，最终回调的图片数据还是横着的，所以还需要转换图像为竖屏的（这个数据量是比较大的），这个在竖屏中绝大都是进行数据转换（横屏图像数据转换成竖屏），代码如下:</li>
</ol>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Decode the data within the viewfinder rectangle, and time how long it took. For efficiency,</span></span><br><span class="line"><span class="comment">   * reuse the same reader objects from one decode to the next.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param data   The YUV preview frame.</span></span><br><span class="line"><span class="comment">   * @param width  The width of the preview frame.</span></span><br><span class="line"><span class="comment">   * @param height The height of the preview frame.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">decode</span><span class="params">(<span class="type">byte</span>[] data, <span class="type">int</span> width, <span class="type">int</span> height)</span> </span>&#123;</span><br><span class="line">    <span class="type">long</span> start = System.<span class="built_in">currentTimeMillis</span>();</span><br><span class="line">    Result rawResult = null;</span><br><span class="line">    Handler handler = mIScanCallback.<span class="built_in">getScanHandler</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (null == mRotatedData) &#123;</span><br><span class="line">        mRotatedData = <span class="keyword">new</span> <span class="type">byte</span>[width * height];</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mRotatedData.length &lt; width * height) &#123;</span><br><span class="line">          mRotatedData = <span class="keyword">new</span> <span class="type">byte</span>[width * height];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      Arrays.<span class="built_in">fill</span>(mRotatedData, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; height; y++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; width; x++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (x + y * width &gt;= data.length) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          mRotatedData[x * height + height - y - <span class="number">1</span>] = data[x + y * width];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">int</span> tmp = width; <span class="comment">// Here we are swapping, that&#x27;s the difference to #11</span></span><br><span class="line">      width = height;</span><br><span class="line">      height = tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> byte[] data的数据长度在3110400，长度百万级别，那么将图片数据转换成竖屏需要大概在56ms （三星S6+）。</p>
<ol start="3">
<li>根据二维码框对应手机屏幕位置找到图片相对位置，通过以上步骤，我们将图片竖直了，接下来就是需要进行进行坐标映射，通过屏幕的扫描框映射到图片的具体框选坐标，然后裁剪数据:</li>
</ol>
<p><img src="/2017/01/12/%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%92%8C%E4%BC%98%E5%8C%96/img/out1.jpg"></p>
<p>相对坐标代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Like &#123;<span class="doctag">@link</span> #getFramingRect&#125; but coordinates are in terms of the preview frame,</span></span><br><span class="line"><span class="comment">     * not UI / screen.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> Rect&#125; expressing barcode scan area in terms of the preview size</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Rect <span class="title function_">getFramingRectInPreview</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (framingRectInPreview == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Rect</span> <span class="variable">framingRect</span> <span class="operator">=</span> getFramingRect();</span><br><span class="line">            <span class="keyword">if</span> (framingRect == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Rect</span> <span class="variable">rect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rect</span>(framingRect);</span><br><span class="line">            <span class="type">Point</span> <span class="variable">cameraResolution</span> <span class="operator">=</span> configManager.getCameraResolution();</span><br><span class="line">            <span class="type">Point</span> <span class="variable">screenResolution</span> <span class="operator">=</span> configManager.getScreenResolution();</span><br><span class="line">            <span class="keyword">if</span> (cameraResolution == <span class="literal">null</span> || screenResolution == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Called early, before init even finished</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            rect.left = rect.left * cameraResolution.y / screenResolution.x;</span><br><span class="line">            rect.right = rect.right * cameraResolution.y / screenResolution.x;</span><br><span class="line">            rect.top = rect.top * cameraResolution.x / screenResolution.y;</span><br><span class="line">            rect.bottom = rect.bottom * cameraResolution.x / screenResolution.y;</span><br><span class="line"> </span><br><span class="line">            framingRectInPreview = rect;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> framingRectInPreview;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码是计算图片二维码框的位置，然后进行裁剪。</p>
<h4 id="针对上面步骤的优化"><a href="#针对上面步骤的优化" class="headerlink" title="针对上面步骤的优化"></a>针对上面步骤的优化</h4><p>总结下面几点：</p>
<ol>
<li>图片横着先不进行数据转换</li>
<li>将手机屏幕的扫码框先进行横着图片的坐标映射</li>
<li>主动裁剪出数据区域</li>
<li>将二维码区域数据裁剪</li>
</ol>
<p>针对第一点，代码如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decode the data within the viewfinder rectangle, and time how long it took. For efficiency,</span></span><br><span class="line"><span class="comment">     * reuse the same reader objects from one decode to the next.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data   The YUV preview frame.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> width  The width of the preview frame.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> height The height of the preview frame.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">decode</span><span class="params">(<span class="keyword">byte</span>[] data, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        Result rawResult = <span class="keyword">null</span>;</span><br><span class="line">        Handler <span class="keyword">handler</span> = mIScanCallback.getScanHandler();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PlanarYUVLuminanceSource source = mIScanCallback.buildLuminanceSource(data, width, height);</span><br><span class="line">            <span class="keyword">if</span> (source != <span class="keyword">null</span>) &#123;</span><br><span class="line">                BinaryBitmap bitmap = <span class="keyword">new</span> BinaryBitmap(<span class="keyword">new</span> GlobalHistogramBinarizer(source));<span class="comment">//</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    rawResult = multiFormatReader.decodeWithState(bitmap);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ReaderException re) &#123;</span><br><span class="line">                    <span class="comment">// continue</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    multiFormatReader.reset();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (rawResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t log the barcode contents for security.</span></span><br><span class="line">                <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;Found barcode in &quot;</span> + (end - start) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">handler</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Message message = Message.obtain(<span class="keyword">handler</span>, DECODE_SUCCEEDED, rawResult);</span><br><span class="line">                    <span class="comment">//为了提高扫码速度,去除这里的生成bitmap的操作</span></span><br><span class="line"><span class="comment">//                    Bundle bundle = new Bundle();</span></span><br><span class="line"><span class="comment">//                    bundleThumbnail(source, bundle);</span></span><br><span class="line"><span class="comment">//                    message.setData(bundle);</span></span><br><span class="line">                    message.sendToTarget();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">handler</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Message message = Message.obtain(<span class="keyword">handler</span>, DECODE_FAILED);</span><br><span class="line">                    message.sendToTarget();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">handler</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Message message = Message.obtain(<span class="keyword">handler</span>, DECODE_FAILED);</span><br><span class="line">                message.sendToTarget();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>映射横屏下的扫码框的坐标，代码如下：</li>
</ol>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Like &#123;@link #getFramingRect&#125; but coordinates are in terms of the preview frame,</span></span><br><span class="line"><span class="comment"> * not UI / screen.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;@link Rect&#125; expressing barcode scan area in terms of the preview size</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Rect <span class="title function_">getFramingRectInPreview</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (framingRectInPreview == <span class="literal">null</span>) &#123;</span><br><span class="line">        Rect framingRect = <span class="title function_">getFramingRect</span>();</span><br><span class="line">        <span class="keyword">if</span> (framingRect == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Rect <span class="built_in">rect</span> = <span class="keyword">new </span><span class="class title_">Rect</span>(framingRect);</span><br><span class="line">        Point cameraResolution = configManager.<span class="property">getCameraResolution</span>();</span><br><span class="line">        Point screenResolution = configManager.<span class="property">getScreenResolution</span>();</span><br><span class="line">        <span class="keyword">if</span> (cameraResolution == <span class="literal">null</span> || screenResolution == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Called early, before init even finished</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="type">int</span> left, top, right, bottom;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//坐标转换, 我们二维码扫描是竖屏,图像是横屏,所以需要计算二维码所处的相对坐标</span></span><br><span class="line">        left = <span class="built_in">rect</span>.<span class="property">top</span> * cameraResolution.<span class="property">x</span> / screenResolution.<span class="property">y</span>;</span><br><span class="line">        top = <span class="built_in">rect</span>.<span class="property">left</span> * cameraResolution.<span class="property">y</span> / screenResolution.<span class="property">x</span>;</span><br><span class="line">        right = left + <span class="built_in">rect</span>.<span class="property">height</span>() * cameraResolution.<span class="property">x</span> / screenResolution.<span class="property">y</span>;</span><br><span class="line">        bottom = top + <span class="built_in">rect</span>.<span class="property">width</span>() * cameraResolution.<span class="property">y</span> / screenResolution.<span class="property">x</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="comment">//对应一些相机在竖屏下需要旋转270 才能够正常图像,但是图像是横屏的,这个图像也是调转的,所以也需要转换</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">getCWNeededRotation</span>() == <span class="number">270</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="built_in">width</span> = right - left;</span><br><span class="line">            left = cameraResolution.<span class="property">x</span> - left - <span class="built_in">width</span>;</span><br><span class="line">            right = left + <span class="built_in">width</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="built_in">rect</span>.<span class="property">left</span> = left;</span><br><span class="line">        <span class="built_in">rect</span>.<span class="property">top</span> = top;</span><br><span class="line">        <span class="built_in">rect</span>.<span class="property">right</span> = right;</span><br><span class="line">        <span class="built_in">rect</span>.<span class="property">bottom</span> = bottom;</span><br><span class="line"> </span><br><span class="line">        framingRectInPreview = <span class="built_in">rect</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> framingRectInPreview;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>裁剪映射图片扫码框的数据区域，代码如下：</li>
</ol>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] mOriginData;</span><br><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] mRotatedData;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A factory method to build the appropriate LuminanceSource object based on the format</span></span><br><span class="line"><span class="comment"> * of the preview buffers, as described by Camera.Parameters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param data   A preview frame.</span></span><br><span class="line"><span class="comment"> * @param width  The width of the image.</span></span><br><span class="line"><span class="comment"> * @param height The height of the image.</span></span><br><span class="line"><span class="comment"> * @return A PlanarYUVLuminanceSource instance.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PlanarYUVLuminanceSource <span class="title">buildLuminanceSource</span><span class="params">(<span class="type">byte</span>[] data, <span class="type">int</span> width, <span class="type">int</span> height)</span> </span>&#123;</span><br><span class="line">    Rect rect = <span class="built_in">getFramingRectInPreview</span>();</span><br><span class="line">    <span class="keyword">if</span> (rect == null) &#123;</span><br><span class="line">        <span class="keyword">return</span> null;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> previewH = rect.<span class="built_in">height</span>();</span><br><span class="line">    <span class="type">int</span> previewW = rect.<span class="built_in">width</span>();</span><br><span class="line">    <span class="type">int</span> size = previewH * previewW;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (null == mOriginData) &#123;</span><br><span class="line">        mOriginData = <span class="keyword">new</span> <span class="type">byte</span>[size];</span><br><span class="line">        mRotatedData = <span class="keyword">new</span> <span class="type">byte</span>[size];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mOriginData.length &lt; size) &#123;</span><br><span class="line">            mOriginData = <span class="keyword">new</span> <span class="type">byte</span>[size];</span><br><span class="line">            mRotatedData = <span class="keyword">new</span> <span class="type">byte</span>[size];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> inputOffset = rect.top * width + rect.left;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// If the width matches the full width of the underlying data, perform a single copy.</span></span><br><span class="line">    <span class="keyword">if</span> (width == previewW) &#123;</span><br><span class="line">        System.<span class="built_in">arraycopy</span>(data, inputOffset, mOriginData, <span class="number">0</span>, size);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Otherwise copy one cropped row at a time.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; previewH; y++) &#123;</span><br><span class="line">        <span class="type">int</span> outputOffset = y * previewW;</span><br><span class="line">        System.<span class="built_in">arraycopy</span>(data, inputOffset, mOriginData, outputOffset, previewW);</span><br><span class="line">        inputOffset += width;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> y = <span class="number">0</span>; y &lt; previewH; y++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; previewW; x++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x + y * previewW &gt;= mOriginData.length) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mRotatedData[x * previewH + previewH - y - <span class="number">1</span>] = mOriginData[x + y * previewW];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> tmp = previewW; <span class="comment">// Here we are swapping, that&#x27;s the difference to #11</span></span><br><span class="line">    previewW = previewH;</span><br><span class="line">    previewH = tmp;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Go ahead and assume it&#x27;s YUV rather than die.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">PlanarYUVLuminanceSource</span>(mRotatedData, previewW, previewH, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">            previewW, previewH, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个步骤是，先裁剪出横屏的二维码区域数据，然后在旋转90度，数据交换的大小为419904，处理时间在6ms (三星S6+)，这里扫码框是相对比较大的，是屏幕宽度的0.6，扫码框越小越快。</p>
<h4 id="其他点的优化"><a href="#其他点的优化" class="headerlink" title="其他点的优化"></a>其他点的优化</h4><p>二维码的对焦速度也影响扫码速度，生成bitmap也需要时间。针对这2点，我也做出了一些优化：</p>
<ol>
<li>相比之前，官方是使用一个AsyncTask,然后使用线程Sleep的方式来控制对焦时间，AsyncTask本身是一个线程池，显然是比较浪费也不优雅的方式；修改方案是服用本身存在的CaptureHandler，在开始生成预览图（requestPreviewFrame(decodeThread.getHandler(), DECODE)）之前发起对焦。</li>
<li>识别成功后，会生出一个bitmap，这个较耗大概18ms</li>
</ol>
<p>针对上面2点，做出代码上的解释：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对焦成功后的回调，和下次对焦的消息，这样完全不需要官方给出的AsyncTask，来对焦</span></span><br><span class="line">public void on<span class="constructor">AutoFocus(<span class="params">boolean</span> <span class="params">success</span>, Camera <span class="params">camera</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (autoFocusHandler != null) &#123;</span><br><span class="line">        Message message = autoFocusHandler.obtain<span class="constructor">Message(<span class="params">autoFocusMessage</span>, <span class="params">success</span>)</span>;</span><br><span class="line">        autoFocusHandler.send<span class="constructor">MessageDelayed(<span class="params">message</span>, AUTOFOCUS_INTERVAL_MS)</span>;</span><br><span class="line">        autoFocusHandler = null;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(TAG, <span class="string">&quot;Got auto-focus callback, but no handler for it&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不生成bitmap</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (rawResult != null) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t log the barcode contents for security.</span></span><br><span class="line">                long <span class="keyword">end</span> = <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span>;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(TAG, <span class="string">&quot;Found barcode in &quot;</span> + (<span class="keyword">end</span> - start) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (handler != null) &#123;</span><br><span class="line">                    Message message = <span class="module-access"><span class="module"><span class="identifier">Message</span>.</span></span>obtain(handler, DECODE_SUCCEEDED, rawResult);</span><br><span class="line">                    <span class="comment">//为了提高扫码速度,去除这里的生成bitmap的操作</span></span><br><span class="line"><span class="comment">//                    Bundle bundle = new Bundle();</span></span><br><span class="line"><span class="comment">//                    bundleThumbnail(source, bundle);</span></span><br><span class="line"><span class="comment">//                    message.setData(bundle);</span></span><br><span class="line">                    message.send<span class="constructor">ToTarget()</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (handler != null) &#123;</span><br><span class="line">                    Message message = <span class="module-access"><span class="module"><span class="identifier">Message</span>.</span></span>obtain(handler, DECODE_FAILED);</span><br><span class="line">                    message.send<span class="constructor">ToTarget()</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>以上就是现阶段的优化，当然还有存在的继续优化的空间。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/30/Android%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E4%B9%8BOOM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/30/Android%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E4%B9%8BOOM/" class="post-title-link" itemprop="url">Android内存优化之OOM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2016-06-30 18:16:45 / Modified: 18:39:05" itemprop="dateCreated datePublished" datetime="2016-06-30T18:16:45+08:00">2016-06-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <link href="http://kevinburke.bitbucket.org/markdowncss/markdown.css" rel="stylesheet">

<blockquote>
<p>Android的内存优化是性能优化中很重要的一部分，而避免OOM又是内存优化中比较核心的一点，这是一篇关于内存优化中如何避免OOM的总结性概要文章，内容大多都是和OOM有关的实践总结概要。理解错误或是偏差的地方，还请多包涵指正，谢谢！</p>
</blockquote>
<p>###(一) Android的内存管理机制</p>
<p>Google在Android的官网上有这样一篇文章，初步介绍了Android是如何管理应用的进程与内存分配：<a target="_blank" rel="noopener" href="http://developer.android.com/training/articles/memory.html">http://developer.android.com/training/articles/memory.html</a> Android系统的Dalvik虚拟机扮演了常规的内存垃圾自动回收的角色，Android系统没有为内存提供交换区，它使用paging与memory-mapping(mmapping)的机制来管理内存，下面简要概述一些Android系统中重要的内存管理基础概念。</p>
<p>####1）共享内存</p>
<p>Android系统通过下面几种方式来实现共享内存：</p>
<ul>
<li>Android应用的进程都是从一个叫做Zygote的进程fork出来的。Zygote进程在系统启动并且载入通用的framework的代码与资源之后开始启动。为了启动一个新的程序进程，系统会fork Zygote进程生成一个新的进程，然后在新的进程中加载并运行应用程序的代码。这使得大多数的RAM pages被用来分配给framework的代码，同时使得RAM资源能够在应用的所有进程之间进行共享。<br>大多数static的数据被mmapped到一个进程中。这不仅仅使得同样的数据能够在进程间进行共享，而且使得它能够在需要的时候被paged out。常见的static数据包括Dalvik Code，app resources，so文件等。<br>大多数情况下，Android通过显式的分配共享内存区域(例如ashmem或者gralloc)来实现动态RAM区域能够在不同进程之间进行共享的机制。例如，Window Surface在App与Screen Compositor之间使用共享的内存，Cursor Buffers在Content Provider与Clients之间共享内存。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/24/Android-Studio-no-debuggable-application/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/24/Android-Studio-no-debuggable-application/" class="post-title-link" itemprop="url">Android Studio no debuggable application</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-24 10:47:18" itemprop="dateCreated datePublished" datetime="2016-06-24T10:47:18+08:00">2016-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:35:00" itemprop="dateModified" datetime="2022-05-11T14:35:00+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在Android调试的时候我们经常会遇到no debuggable application，这里说下我自己的解决办法，以便以后查找。</p>
<p><code>通过AndroidStudio中 Tools-&gt;Android-&gt;Enable ADB Integration active. 之后需等待一会，可能adb会重启，之后就会发现那个框框正常显示你已启动的app</code></p>
<p>这个时候可能还会遇到依然是no debuggable application，我的解决办法是找到下拉通知栏中的<code>正在通过USB</code>，如图：</p>
<p><img src="/2016/06/24/Android-Studio-no-debuggable-application/img/img1.png"></p>
<p>进入到选择对话框，选择一个试试。</p>
<p><img src="/2016/06/24/Android-Studio-no-debuggable-application/img/img2.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/21/%E5%BC%80%E6%BA%90%E5%BA%93FileDownloader%E7%9A%84%E7%AE%80%E8%A6%81%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/21/%E5%BC%80%E6%BA%90%E5%BA%93FileDownloader%E7%9A%84%E7%AE%80%E8%A6%81%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">开源库FileDownloader的简要原理分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-21 17:34:42" itemprop="dateCreated datePublished" datetime="2016-06-21T17:34:42+08:00">2016-06-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 11:48:49" itemprop="dateModified" datetime="2022-05-11T11:48:49+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近一直在着手处理文件下载相关的东西，介于没有足够的精力重头开始写，github发现一个文件下载库，其设计还是非常不错的，这里就简要的分析下其结构构成。非常感谢这位小伙伴的开源精神，作者的<a target="_blank" rel="noopener" href="https://github.com/lingochamp/FileDownloader">Jacksgong github</a>,博客<a target="_blank" rel="noopener" href="http://blog.dreamtobe.cn/">Jacksgong blog</a></p>
<h2 id="框架的模块构成"><a href="#框架的模块构成" class="headerlink" title="框架的模块构成"></a>框架的模块构成</h2><h4 id="一个下载框架主要需要包含以下几个模块："><a href="#一个下载框架主要需要包含以下几个模块：" class="headerlink" title="一个下载框架主要需要包含以下几个模块："></a>一个下载框架主要需要包含以下几个模块：</h4><ol>
<li>网络请求和文件流模块</li>
<li>消息回调机制</li>
<li>跨进程间通信模块</li>
<li>信息存储模块</li>
<li>异常处理模块</li>
</ol>
<p>以下是我对下载框架的一个类图结构分析，这部分主要涉及的是独立进程中文件下载需要处理的任务 和 提供远程接口端的类图，暂时没有涉及上层逻辑结构。</p>
<p><img src="/2016/06/21/%E5%BC%80%E6%BA%90%E5%BA%93FileDownloader%E7%9A%84%E7%AE%80%E8%A6%81%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/img/FileDownloader1.png"></p>
<p>首先跨进程间的通信方式是采用：</p>
<ol>
<li>通过Binder来实现远程调用(IPC)：这种方式是Android的最大特色之一，让你调用远程Service的接口，就像调用本地对象一样，实现非常灵活，写起来也相对复杂。</li>
<li>在FileDownloadService里面handler（IFileDownloadServiceHandler）持有实现一个IFileDownloadIPCService.Stub接口的Binder，并且在onBind()中返回此Binder对象</li>
<li>同时在实现IFileDownloadServiceHandler接口的FDServiceSeparateHandler类中拥有了文件下载的远程消息的回调，同时在这个handler中封装了对文件下载管理操作类FileDownloadMgr，远程接口IFileDownloadIPCService中的实现都交由FileDownloadMgr来实现和管理，Service所有操作都委托交由FDServiceSeparateHandler来处理，FDServiceSeparateHandler也实现了MessageReceiver来处理进程间的消息回调，其真正处理回调处理是由IFileDownloadIPCCallback远程接口来实现。</li>
<li>文件的下载中拥有文件下载的线程池FileDownloadThreadPool，线程池中的单个子单元是由一个Runnable构成，在FileDownloadRunnable中有下载文件的相关信息以及相关的操作，在这里我们可以看出，在执行Runnable的线程中是单个的，Runnable中涉及网络请求和数据流的传输都在Runnable中完成，文件的读写操作是堵塞的，Runnable中的文件下载的相关状态信息是通过MessageSnapshotFlow.getImpl().inflow(MessageSnapshotTaker.take(status, model, this))发出的，消息发出交由FDServiceSeparateHandler的receive(MessageSnapshot snapShot),随之RemoteCallbackList<IFileDownloadIPCCallback> callbackList将发起进程间回调通信，来完成通知下载状态的更新，通过以上的步骤来完成Service与其他进程的通信。</IFileDownloadIPCCallback></li>
<li>文件的下载状态都会记录到指定的数据库中，以便支持完善的下载进度和断点续传功能。</li>
</ol>
<p>Service代理以及和Service所在进程的通信：</p>
<ol>
<li>FileDownloadServiceProxy实现了IFileDownloadServiceProxy接口，其接口真正的实现是由FileDownloadServiceUIGuard来处理，在FileDownloadServiceUIGuard中提供了进程间通信需要的CALLBACK和INTERFACE</li>
<li>BaseFileServiceUIGuard抽象类中实现了ServiceConnection，在onServiceConnected中完成registerCallback，将registerCallback实现交给子类FileDownloadServiceUIGuard，在onServiceConnected中返回了IBinder</li>
<li>通过IFileDownloadIPCService.Stub.asInterface取得远程接口对象，之后通过这个获取的远程接口实现注册相关的操作，同时通过这个远程的接口实现进程间的通信。</li>
<li>在FileDownloadServiceUIGuard中提供了远程接口注册时需要的IFileDownloadIPCService.Stub接口的Binder。</li>
<li>FileDownloadServiceUIGuard继承了BaseFileServiceUIGuard，所以FileDownloadServiceUIGuard必须实现FileDownloadServiceProxy接口。同时在BaseFileServiceUIGuard中已经拥有IFileDownloadIPCService的远程接口，<br>所以FileDownloadServiceProxy接口实现是通过获得的远程接口去实现的，同时这个就是我们说的跨进程通信的方式。</li>
<li>那么现在还有一个比较重要的点，现在怎样把文件下载进度信息交给其他进程呢？不难发现我们注册了一个CallBack的Binder。client端与server不在一个进程，server是无法得知client解注册时传入的回调接口是哪一个（client调用解注册时，是通过binder传输到server端，所以解注册时的回调接口是新创建的，而不是注册时的回调接口）。为了解决这个问题，android提供了RemoteCallbackList这个类来专门管理remote回调的注册与解注册。</li>
<li>通过上述分析，client和Service通信以及Service和client的通信，client和Service通信通过onServiceConnected中返回的IBinder，进而取得远程接口，实现client和Service通信。Service和client通信通过RemoteCallbackList，通过client获取的远程接口，同时通过这个远程接口回调注册，实现Service与client的通信。</li>
<li>经过上述的分析，我们已经能够知道所有的连接通信逻辑都已经由FileDownloadServiceProxy委托代理。</li>
</ol>
<h2 id="上层逻辑类图结构逻辑分析"><a href="#上层逻辑类图结构逻辑分析" class="headerlink" title="上层逻辑类图结构逻辑分析"></a>上层逻辑类图结构逻辑分析</h2><p>上层的结构逻辑主要是对远程结构代理的封装，由外部组装必要的数据以及外部等待下载状态的更新。类图结构如下：</p>
<p><img src="/2016/06/21/%E5%BC%80%E6%BA%90%E5%BA%93FileDownloader%E7%9A%84%E7%AE%80%E8%A6%81%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/img/FileDownloader2.png"></p>
<p>client的结构构成：</p>
<ol>
<li>每一个下载任务对应一个单独的FileDownloadTask，其和Service的跨进程通信通过FileDownloadServiceProxy进行关联</li>
<li>Service和client的下载状态的回调是通过MessageReceiver接口来实现的，其正确的流程是Service进程中的Runnable下载文件状态   -&gt;  MessageSnapshotFlow.getImpl().inflow()(Service进程)   -&gt; FDServiceSeparateHandler(实现了MessageReceiver接口)   -&gt; FDServiceSeparateHandler的receive()调用RemoteCallbackList<IFileDownloadIPCCallback> callbackList来完成Service和client的通信。</IFileDownloadIPCCallback></li>
<li>FileDownloader是统一收敛、数据组装、状态查询的直接外部入口类，其内部核心处理还是通过FileDownloadTask来构建任务、FileDownloadServiceProxy来处理跨进程数据通信。</li>
</ol>
<p>通过以上的分析介绍，我们能够知道，其下载其实主要就是通信模块的构建，也就是我们常说的外壳，外壳保证了通信逻辑，我们先构建出来通信外壳模块，将网络连接和文件下载抽象独立出来。外壳保证通信的准确性，下载内核保证了数据的准确性。<br>同时通过对以上框架的分析，我们需要做到将下载核抽象出来，这样能够更灵活的配置下载核，同时也给下载核更多的发挥空间。</p>
<p>简单的创建demo任务：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">final BaseDownloadTask task = <span class="module-access"><span class="module"><span class="identifier">FileDownloader</span>.</span></span>get<span class="constructor">Impl()</span>.create(url)</span><br><span class="line">        .set<span class="constructor">Path(<span class="params">path</span>)</span></span><br><span class="line">        .set<span class="constructor">CallbackProgressTimes(100)</span></span><br><span class="line">        .set<span class="constructor">Listener(<span class="params">taskDownloadListener</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>这样就完成了一个任务下载，任务的状态信息回调在监听中处理就OK了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/18/%E5%A6%82%E4%BD%95%E6%8A%8A%E4%B8%80%E4%BB%B6%E4%BA%8B%E6%83%85%E5%81%9A%E5%A5%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/18/%E5%A6%82%E4%BD%95%E6%8A%8A%E4%B8%80%E4%BB%B6%E4%BA%8B%E6%83%85%E5%81%9A%E5%A5%BD/" class="post-title-link" itemprop="url">如何把一件事情做好</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2016-06-18 18:23:40 / Modified: 17:17:52" itemprop="dateCreated datePublished" datetime="2016-06-18T18:23:40+08:00">2016-06-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>自从自己开始体系的完成一个产品需求的时候，从中学到了很多，也发现了很多自己不足的地方。自己的本意本来是想把事情做的更好，所以需要不断的发现自己在哪点上做的不够好。</p>
<p>以前做事，之前是在一家公司，因为自己要独立完成整个App包括测试。所以在大部分时间都是在写代码，进行功能测试。那种感觉真的很好，对待一个产品就像对待自己的小孩一样，你就会想要把她完成的更好。同时大家也会交流，虽然很累但是很满足。</p>
<p>自从来到UC，我慢慢的接触了大产品的开发流程，但是我习惯了之前天马行空的工作方式，所以我一直在思考如何把事情做的更好。</p>
<p>最近完成一个需求，我尽量按照自己规定的路子走，很理想的把功能模块完善的很好。整理了完善的文档，我就想将需求的实现的思路纪录下来，方便后来人更快的熟悉功能模块的开发思路。</p>
<p>渐渐的我学会了稳重的处理手上的需求，急躁和慌张不能给你带来任何的积极的效果，自己需要做的就是安心的做好手头上的事情。</p>
<p>我觉得人应该学会感恩，尤其是那些愿意说你的人。</p>
<ul>
<li>在这里我特别感谢组里的丹琦妹子，虽然说你每次都给我找茬。但是每次的说我做的不好的地方我都默默的会记在心里，我下次肯定努力克服。</li>
<li>也要感谢我组内的强哥，强哥每次都会和我很细致的讨论一个问题。甚至帮我理清思路，虽然我的代码写的不是那么优雅，但我一直在路上啊^_^</li>
</ul>
<p>我们成长路上会遇到很多人，也会遇到很多事。不要抱怨、不要排斥，我们应该心存一颗感恩的心，即使别人骂你、别人说你。别人说你、骂你说明别人希望你更好，那么我们为啥不说声感谢呢！然后收拾心情好好整理自己，重新改善自己。</p>
<p>我觉得只要自己在进步、在改进，即使事情做的不是那么如意，我们也要为自己的上进而鼓掌。</p>
<blockquote>
<p>当感恩成为习惯 </p>
<p>欢乐似水流远 </p>
<p>日子尽管过得平凡 </p>
<p>充实之感实在, </p>
<p>当感恩成为习惯</p>
<p>生活不愿慢怠</p>
<p>修我行为</p>
<p>炼我意识</p>
<p>和谐永远培栽 </p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">伍中联</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
