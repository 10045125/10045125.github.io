<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="珍惜在生命中遇到的每一个人">
<meta property="og:type" content="website">
<meta property="og:title" content="伍中联(Vanda)的博客">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="伍中联(Vanda)的博客">
<meta property="og:description" content="珍惜在生命中遇到的每一个人">
<meta property="og:locale">
<meta property="article:author" content="伍中联">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"default","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>伍中联(Vanda)的博客</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">伍中联(Vanda)的博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">当一切理所当然就没有你什么事了 当你说：“这个好麻烦，那么不要犹豫，主动出击”</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>About</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="伍中联"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">伍中联</p>
  <div class="site-description" itemprop="description">珍惜在生命中遇到的每一个人</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/10045125" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;10045125" rel="noopener" target="_blank"><i class="fab zhonglian-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/zhonglian.wzl@gmail.com" title="E-Mail → zhonglian.wzl@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/30/2018%E9%9C%80%E8%A6%81%E5%AD%A6%E4%B9%A0%E7%9A%84%E4%BA%8B%E6%83%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/01/30/2018%E9%9C%80%E8%A6%81%E5%AD%A6%E4%B9%A0%E7%9A%84%E4%BA%8B%E6%83%85/" class="post-title-link" itemprop="url">2018需要学习的事情</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-01-30 21:09:24" itemprop="dateCreated datePublished" datetime="2018-01-30T21:09:24+08:00">2018-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 11:42:22" itemprop="dateModified" datetime="2022-05-11T11:42:22+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="2017回顾"><a href="#2017回顾" class="headerlink" title="2017回顾"></a>2017回顾</h4><h5 id="理解业务-gt-技术的持续投入"><a href="#理解业务-gt-技术的持续投入" class="headerlink" title="理解业务 -&gt; 技术的持续投入"></a>理解业务 -&gt; 技术的持续投入</h5><p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;2017自己对业务和技术的理解更多了，做夸克的一年多的时间里，里面有太多值得回忆。对技术的持续追求，对产品的理解，从业务更好的理解技术，以及从技术功能点对业务的反向思考，给夸克带来许多实用的功能。需要做到用户喜欢用这个功能，自己需要深入的体验挖掘用户的潜在需求，然后在技术上能不能够实现，如果能实现，方案是怎样的，会存在什么问题，以及问题的解决方案等。</p>
<h5 id="业务-gt-抽离SDK"><a href="#业务-gt-抽离SDK" class="headerlink" title="业务 -&gt; 抽离SDK"></a>业务 -&gt; 抽离SDK</h5><p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;在夸克的这一年来，经过我手头的项目已经很多。从早期对国内UC的代码耦合杂乱就提出要在夸克里面避免糟糕的代码，夸克需要模块解耦，功能内敛、使用单一简单、接口清晰明确。<br><br>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;夸克的加解密SDK、升级SDK、二维码SDK、QuarkDownloader SDK、分享SDK、翻译SDK、OCR SDK。这些SDK我在夸克中完成的，都有很明显的特性，功能解耦、接口清晰、使用简单。在业务功能的抽象分解上自己做到了。目前多个SDK应用在其他产品上面。</p>
<h5 id="应用架构"><a href="#应用架构" class="headerlink" title="应用架构"></a>应用架构</h5><p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 夸克浏览器在架构方面并没有完全参照国内UC，反而是知道国内UC架构的不足作出了优化（我对比了多个产品先的架构，都是照搬国内UC的架构），夸克的老大还是很有思想的，我们做出了MVC + feature MVP功能架构，避免了Controller承载业务造成业务重度耦合的情况，目前UC系的产品都是单Activity模式，通过自己的WindowManager来管理窗口，然后建立自己的一套MsgDispather，通过id映射Controller的机制来驱动feature来实现对应的业务，当然这种也存在一些问题，不过有点大于缺点吧！</p>
<p>大致梳理下架构图</p>
<p><img src="/./2018%E9%9C%80%E8%A6%81%E5%AD%A6%E4%B9%A0%E7%9A%84%E4%BA%8B%E6%83%85/images/Quark.png"></p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;在夸克的一年是辛苦的一年也是收获的一年，收获了自己对业务和技术的理解、收获了自己对应用架构、SDK、底层技术实现和优化的经验。同时自己具备了独当一面的能力，能够有序的拆解业务，推进业务的进展，感谢UC的老大给予的信任。</p>
<h4 id="2018技术学习"><a href="#2018技术学习" class="headerlink" title="2018技术学习"></a>2018技术学习</h4><p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;给自己定几个目标吧</p>
<blockquote>
<ol>
<li>研究JVM的内存管理机制</li>
<li>学习研究我们常用的集合类的实现原理，比如HashMap、ArrayList等</li>
<li>学习研究跨进程通信的详细细节，AIDL的实现原理</li>
<li>学习直播相关的知识（RTMP协议格式，建立连接的过程、传输过程、解码过程等），以前自己就是做过这个的，加深理解吧</li>
</ol>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/30/%E5%A4%B8%E5%85%8B%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/01/30/%E5%A4%B8%E5%85%8B%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">夸克浏览器下载模块功能介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2018-01-30 21:05:59 / Modified: 21:06:40" itemprop="dateCreated datePublished" datetime="2018-01-30T21:05:59+08:00">2018-01-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="下载支撑"><a href="#下载支撑" class="headerlink" title="下载支撑"></a>下载支撑</h4><p>   QuarkDownloader SDK 支撑夸克浏览器中几乎所有的下载任务。</p>
<blockquote>
<ol>
<li>功能支撑</li>
<li>业务支撑</li>
</ol>
</blockquote>
<h4 id="功能支撑"><a href="#功能支撑" class="headerlink" title="功能支撑"></a>功能支撑</h4><blockquote>
<ol>
<li>设置自动中断任务</li>
<li>更新链接</li>
<li>开放线程调节</li>
<li>外部调用夸克浏览器下载</li>
</ol>
</blockquote>
<h4 id="业务支撑"><a href="#业务支撑" class="headerlink" title="业务支撑"></a>业务支撑</h4><blockquote>
<ol>
<li>so 升级下载</li>
<li>图片下载</li>
<li>CMS资源下载</li>
<li>视频缓存</li>
<li>内核回调的文件下载</li>
</ol>
</blockquote>
<h4 id="下载特性"><a href="#下载特性" class="headerlink" title="下载特性"></a>下载特性</h4><blockquote>
<p>读写分离／非分离 <br><br>全局一个线程写文件<br><br>任意线程<br><br>网络库定制<br><br>IO可定制（网络IO和文件IO）<br><br>设置自动中断<br><br>按需启动<br><br>更新链接<br><br>进程核心统计接口<br><br>通知栏抽象接口<br><br>静默／非静默任务 <br></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/" class="post-title-link" itemprop="url">薛业乔-作品</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-05 15:31:19" itemprop="dateCreated datePublished" datetime="2017-09-05T15:31:19+08:00">2017-09-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:16:02" itemprop="dateModified" datetime="2022-05-11T14:16:02+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="Koala-Mimi-表情"><a href="#Koala-Mimi-表情" class="headerlink" title="Koala Mimi 表情"></a>Koala Mimi 表情</h4><p><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/img/WechatIMG21.jpeg"></p>
<h4 id="手绘作品"><a href="#手绘作品" class="headerlink" title="手绘作品"></a>手绘作品</h4><p><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E6%89%8B%E7%BB%98/%E6%8B%87%E6%8C%87%E5%85%AC%E4%B8%BB.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E6%89%8B%E7%BB%98/%E4%BA%BA%E7%89%A9.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E6%89%8B%E7%BB%98/%E4%BA%BA%E7%89%A9%E6%89%8B%E7%BB%98.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E6%89%8B%E7%BB%98/%E6%89%8B%E7%BB%98%E7%BB%83%E4%B9%A0.jpeg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E6%89%8B%E7%BB%98/CG%E8%A7%92%E8%89%B2%E8%AE%BE%E5%AE%9A.jpeg"></p>
<h4 id="小七鸭"><a href="#小七鸭" class="headerlink" title="小七鸭"></a>小七鸭</h4><p><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E5%B0%8F%E4%B8%83%E9%B8%AD/%E5%B0%8F%E4%B8%83%E9%B8%AD1.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E5%B0%8F%E4%B8%83%E9%B8%AD/%E5%B0%8F%E4%B8%83%E9%B8%AD2.jpeg"></p>
<h4 id="Logo设计"><a href="#Logo设计" class="headerlink" title="Logo设计"></a>Logo设计</h4><p><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/logo/%E9%A4%90%E5%8E%85%E7%9A%84logo%E5%92%8C%E6%B5%B7%E6%8A%A5_%E5%B9%B3%E9%9D%A2_%E5%93%81%E7%89%8C"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/logo/%E9%9B%80%E7%8E%B2%E7%8F%91.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/logo/logo.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/logo/newid.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/logo/newid2.jpg"></p>
<h4 id="H5"><a href="#H5" class="headerlink" title="H5"></a>H5</h4><p><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/H5/%E7%94%B5%E4%BF%A1%E4%BA%91%E5%A0%A43.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/H5/%E7%BE%8E%E9%A6%A5%E9%A2%9CH5"></p>
<h4 id="平面广告"><a href="#平面广告" class="headerlink" title="平面广告"></a>平面广告</h4><p>![](.&#x2F;%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81&#x2F;平面广告&#x2F;4G进企业—— wifi进厂区  稿件三.jpg)<br>![](.&#x2F;%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81&#x2F;平面广告&#x2F;4G进企业—— wifi进厂区  稿件三02.jpg)<br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E5%B9%B3%E9%9D%A2%E5%B9%BF%E5%91%8A/%E5%B9%BF%E5%91%8A.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E5%B9%B3%E9%9D%A2%E5%B9%BF%E5%91%8A/%E5%85%A8%E6%B0%91%E5%8D%874G%E7%BF%BC%E8%B5%B7%E7%8E%A94G.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E5%B9%B3%E9%9D%A2%E5%B9%BF%E5%91%8A/%E4%B8%93%E5%8C%BA%E6%8C%82%E7%89%8C%E5%9C%BA%E6%99%AF%E5%9B%BE1%EF%BC%88%E5%8E%BB%E6%8E%89%E5%B7%A6%E4%B8%8A%E8%A7%92%E5%8F%8A%E5%8F%B3%E4%B8%8B%E8%A7%92%E7%9A%84%E6%B0%B4%E5%8D%B0%EF%BC%89.jpg"><br><img src="/2017/09/05/%E8%96%9B%E4%B8%9A%E4%B9%94-%E4%BD%9C%E5%93%81/%E5%B9%B3%E9%9D%A2%E5%B9%BF%E5%91%8A/%E4%B8%93%E5%8C%BA%E6%8C%82%E7%89%8C%E5%9C%BA%E6%99%AF%E5%9B%BE2.jpg"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/09/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/06/09/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">下载模块功能介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-09 23:38:25" itemprop="dateCreated datePublished" datetime="2017-06-09T23:38:25+08:00">2017-06-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:35:00" itemprop="dateModified" datetime="2022-05-11T14:35:00+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="下载组件优势"><a href="#下载组件优势" class="headerlink" title="下载组件优势"></a>下载组件优势</h4><ol>
<li>易接入、易用性</li>
<li>扩展性好（网络库扩展、文件IO扩展、调节线程数、众多可选参数）</li>
<li>网络和文件IO优化，体现下载速度较快</li>
<li>读写分离</li>
<li>无任何第三方依赖</li>
<li>通知栏的简易对接</li>
<li>下载组件的执行逻辑</li>
</ol>
<h4 id="Demo地址"><a href="#Demo地址" class="headerlink" title="Demo地址"></a>Demo地址</h4><p><a target="_blank" rel="noopener" href="http://www.coolapk.com/apk/com.vanda_adm.vanda">http://www.coolapk.com/apk/com.vanda_adm.vanda</a></p>
<h4 id="开源地址"><a href="#开源地址" class="headerlink" title="开源地址"></a>开源地址</h4><p><a target="_blank" rel="noopener" href="http://gitlab.alibaba-inc.com/uc-mobile-open/QuarkDownloader">http://gitlab.alibaba-inc.com/uc-mobile-open/QuarkDownloader</a></p>
<h4 id="易接入"><a href="#易接入" class="headerlink" title="易接入"></a>易接入</h4><h6 id="如何接入"><a href="#如何接入" class="headerlink" title="如何接入"></a>如何接入</h6><p>在QuarkDownloader设计的时候，就易用性、低的接入成本经过了考虑，我们先看看App如何接入QuarkDownloader。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">VandaApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void onCreate() &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line"><span class="type">String</span> defaultDownloadPath = <span class="type">PathConfig</span>.getDownloadRootPath();</span><br><span class="line"><span class="type">QuarkDownloader</span>.init(<span class="type">VandaApplication</span>.<span class="keyword">this</span>, defaultDownloadPath, <span class="keyword">new</span> <span class="type">OkhttpNetworkConnect</span>.<span class="type">Creator</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>这里是给配置下载进程所需要的上下文参数，这些初始化是不耗时操作。这样就已经配置好了下载所必要的环境。</p>
<p>如果不需要外接网络库，则如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QuarkDownloader.<span class="keyword">init</span>(VandaApplication.<span class="keyword">this</span>, defaultDownloadPath);</span><br></pre></td></tr></table></figure>

<p>该方式使用系统内置网络库（URLConnection）</p>
<h6 id="使用下载组件来下载文件"><a href="#使用下载组件来下载文件" class="headerlink" title="使用下载组件来下载文件"></a>使用下载组件来下载文件</h6><p>启动一个下载任务：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void start<span class="constructor">Task(String <span class="params">url</span>, String <span class="params">title</span>)</span> &#123;</span><br><span class="line">             QuarkDownloadRequest request = <span class="keyword">new</span> QuarkDownloadRequest</span><br><span class="line">             .<span class="constructor">Builder()</span></span><br><span class="line">             .url(url)</span><br><span class="line">             .title(title)</span><br><span class="line">             .build<span class="literal">()</span>;</span><br><span class="line"></span><br><span class="line">     <span class="module-access"><span class="module"><span class="identifier">QuarkDownloader</span>.</span></span>get<span class="constructor">Instance()</span>.create<span class="constructor">Task(<span class="params">request</span>)</span>.add<span class="constructor">OnStateChangeListener(<span class="params">new</span> OnStateChangeListener()</span> &#123;</span><br><span class="line">         @Override</span><br><span class="line">         public void on<span class="constructor">StateChange(QuarkDownloadTask <span class="params">task</span>, <span class="params">int</span> <span class="params">status</span>, <span class="params">long</span> <span class="params">sofar</span>, <span class="params">long</span> <span class="params">total</span>)</span> &#123;</span><br><span class="line">             <span class="comment">//your code</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;).start<span class="literal">()</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这样就建立一个下载任务，你只要在回调中处理你自己的逻辑就OK了。这里的例子只是下载组件最基本的启动方式，下载组件还提供了众多的参数，以及支持众多的场景。</p>
<h4 id="扩展性好"><a href="#扩展性好" class="headerlink" title="扩展性好"></a>扩展性好</h4><h6 id="网络库扩展、IO扩展"><a href="#网络库扩展、IO扩展" class="headerlink" title="网络库扩展、IO扩展"></a>网络库扩展、IO扩展</h6><p>下载组件能够支持外部网络库接入，这也就说明，下载组件可以支持更多的下载协议，下载组件只关心数据读取、数据的存储。</p>
<p>下载组件抽象了一组接口，外部可以提供自己的网络库实现，如下代码： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">NetworkConnection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">NO_RESPONSE_CODE</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据的请求方式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">RequestWays</span> &#123;</span><br><span class="line">        POST,</span><br><span class="line">        GET,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加请求头部信息，这个会被添加到网络库中的请求的header中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addHeader</span><span class="params">(String name, String value)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求头部信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">getRequestHeaderFields</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应头部信息，这个下载组件会获取一些必要的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">getResponseHeaderFields</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取制定name的value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">getResponseHeaderField</span><span class="params">(String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行网络请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(RequestWays requestWays, Map&lt;String, String&gt; postBody)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取网络请求的响应code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getResponseCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载完成或出现异常需要处理的回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">ending</span><span class="params">()</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载组件提供了一组内存映射的输入流，提高文件的IO效率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputStream</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">outputStream</span><span class="params">(OutputStream outputStream)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取制定输入流中的字节数的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> byteCount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">read</span><span class="params">(<span class="type">long</span> byteCount)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将读取的数据写入到磁盘</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">emit</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放文件操作相关</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> etag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> offset</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">dispatchAddResumeOffset</span><span class="params">(String etag, <span class="type">long</span> offset)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 网络输入流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    InputStream <span class="title function_">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Okhttp实现"><a href="#Okhttp实现" class="headerlink" title="Okhttp实现"></a>Okhttp实现</h6><p>下载组件进行了抽象接口，来实现最大化的定制需求，方便业务自己的需求。为了更为方便的说明问题，我们列举一个使用Okhttp来实现网络库和IO操作的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">class</span> <span class="title class_">OkhttpNetworkConnect</span> <span class="keyword">implements</span> <span class="title class_">NetworkConnection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Request.Builder mRequestBuilder;</span><br><span class="line">    <span class="keyword">private</span> Call mCall;</span><br><span class="line">    <span class="keyword">private</span> Response mResponse;</span><br><span class="line">    <span class="keyword">private</span> String mUrl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">BufferedSink</span> <span class="variable">mSink</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">BufferedSource</span> <span class="variable">mSource</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Buffer</span> <span class="variable">mBuffer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OkhttpNetworkConnect</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        mRequestBuilder = <span class="keyword">new</span> <span class="title class_">Request</span>.Builder();</span><br><span class="line">        <span class="built_in">this</span>.mUrl = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addHeader</span><span class="params">(String name, String value)</span> &#123;</span><br><span class="line">        mRequestBuilder.addHeader(name, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchAddResumeOffset</span><span class="params">(String etag, <span class="type">long</span> offset)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> mResponse.body().byteStream();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">getRequestHeaderFields</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">getResponseHeaderFields</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getResponseHeaderField</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mResponse.header(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(FileDownloadConnection.RequestWays requestWays, Map&lt;String, String&gt; postBody)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        mRequestBuilder.cacheControl(CacheControl.FORCE_NETWORK);</span><br><span class="line"></span><br><span class="line">        FormBody.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FormBody</span>.Builder();</span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requestWays == RequestWays.POST &amp;&amp; postBody != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : postBody.entrySet()) &#123;</span><br><span class="line">                builder.addEncoded(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            requestBody = builder.build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mRequestBuilder.cacheControl(CacheControl.FORCE_NETWORK);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// start download----------------</span></span><br><span class="line">        <span class="comment">// Step 3, init request</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> requestWays == RequestWays.POST ? mRequestBuilder.url(mUrl).post(requestBody).build() : mRequestBuilder.url(mUrl).get().build();</span><br><span class="line">        mCall = OkHttpProxy.getInstance().newCall(request);</span><br><span class="line">        mResponse = mCall.execute();</span><br><span class="line">        mSource = mResponse.body().source();</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">&quot;vanda&quot;</span>, <span class="string">&quot;head = &quot;</span> + mResponse.headers().toString() + <span class="string">&quot;  mSource = &quot;</span> + mSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getResponseCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> mResponse.code();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ending</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mResponse != <span class="literal">null</span>) &#123;</span><br><span class="line">            mResponse.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outputStream</span><span class="params">(OutputStream outputStream)</span> &#123;</span><br><span class="line">        mSink = Okio.buffer(Okio.sink(outputStream));</span><br><span class="line">        mBuffer = mSink.buffer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">read</span><span class="params">(<span class="type">long</span> byteCount)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> mSource.read(mBuffer, byteCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">emit</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        mSink.emit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">         <span class="keyword">if</span> (mSource != <span class="literal">null</span>) &#123;</span><br><span class="line">             mSource.close();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (mSink != <span class="literal">null</span>) &#123;</span><br><span class="line">             mSink.close();</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Creator</span> <span class="keyword">implements</span> <span class="title class_">NetworkConnectionCreator</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Creator</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> NetworkConnection <span class="title function_">create</span><span class="params">(String originUrl)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OkhttpNetworkConnect</span>(originUrl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>   如上代码就实现了Okhttp网络库的接入，接口实现也比较简单。我们注意到网络库涉及到网络IO这块，一些网络库在网络库IO有自己的实现，典型的例子是Okhttp使用了自身的Okio，所以在网络IO上我们把操作权交给了业务方，这样能够获取更为高效的网络IO性能。在文件IO上我们提供了内部已经计算好文件range和seek的OutputStream，业务方可以对其进行包装或者直接使用都能够获取更为高效的文件IO，至于为什么高效后面我会说到。</p>
<h4 id="网络IO读取策略"><a href="#网络IO读取策略" class="headerlink" title="网络IO读取策略"></a>网络IO读取策略</h4><p>一般来说我们利用空间和换取时间的策略，来提高网络IO的使用率，也就是说，我们使用内存空间来提高网络IO效率。如下图：</p>
<p><img src="/2017/06/09/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/img/NetIo.png"></p>
<p>如上图，我们使用读取segment，一个segment有一个固定大小，下载组件中抽离了Okio的核心逻辑，组合成QuarkOkio，每次进行emit数据时必须满足上述条件，使用segment来存储数据，这样有3个好处：</p>
<ol>
<li>每次读取segment时可以提供任务进度回调，而这个时候并没有进行文件IO操作，我们把数据保存在内存中</li>
<li>segment是一个双向链式结构，并且提供SegmentPool来缓存segment，避免系统GC和申请byte时的zero-fill。，这些数据块使用链表进行管理，这可以仅通过移动“指针”就进行数据的管理，而不用真正去处理数据，而且对扩容来说也十分方便。</li>
<li>它对数据进行了分块处理，这样在大数据IO的时候可以以块为单位进行IO，这可以提高IO的吞吐率。</li>
</ol>
<p>同时我们下载组件提供了多线程下载机制，结合QuarkOkio数据缓存机制，能够最大程度利用网络IO，从而使网络IO最大化。</p>
<h4 id="文件IO策略"><a href="#文件IO策略" class="headerlink" title="文件IO策略"></a>文件IO策略</h4><h5 id="内置众多文件IO方式，可以扩展"><a href="#内置众多文件IO方式，可以扩展" class="headerlink" title="内置众多文件IO方式，可以扩展"></a>内置众多文件IO方式，可以扩展</h5><p>QuarkDownloader组件比对过Java里面的文件IO性能，我们先列举性能最优的IO，MappedByteBuffer，下载组件中有一个IO类IOChannel，这个类中继承了OutputStream，利用MappedByteBuffer来完成文件的IO，现在我们来说说这个和普通的IO有和不同。</p>
<h6 id="简单介绍下传统IO的方式"><a href="#简单介绍下传统IO的方式" class="headerlink" title="简单介绍下传统IO的方式"></a>简单介绍下传统IO的方式</h6><p>IO，就是数据不停地搬入搬出缓冲区而已（使用了缓冲区）。比如，用户程序发起读操作，导致“ syscall read ”系统调用，就会把数据搬入到buffer中。用户发起写操作，导致 “syscall write ”系统调用，将会把buffer中的数据搬出去(发送到网络中或者写入到磁盘文件)</p>
<p>普通的IO处理的流程图：</p>
<p><img src="/2017/06/09/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/img/NormalIO.png"></p>
<ol>
<li>将数据从磁盘读数据到内核缓冲区，由DMA来完成</li>
<li>然后内核将内核缓冲区的数据拷贝到用户空间的用户进程</li>
<li>这样完成了数据的读</li>
</ol>
<p>一般Java应用程序读取数据代码如下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line"><span class="keyword">long</span> len;</span><br><span class="line"><span class="keyword">while</span>((len = inputStream.<span class="keyword">read</span>(b))&gt;=<span class="number">0</span>) &#123;        </span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当执行到read()方法时，底层执行了很多操作的：</p>
<ol>
<li>内核给磁盘控制器发指令：我要读磁盘上的某块磁盘块上的数据。</li>
<li>在DMA的控制下，把磁盘上的数据读入到内核缓冲区。</li>
<li>内核把数据从内核缓冲区拷贝到用户缓冲区。</li>
</ol>
<p>从上面几步我们可以分析出：</p>
<ol>
<li>就操作系统而言，JVM只是一个用户进程，处于用户态空间中。而处于用户态空间的进程是不能直接操作底层硬件的。而IO操作就需要操作底层的硬件，比如磁盘。因此，IO操作必须得借助内核的帮助才能完成(中断，trap)，即：会有用户态到内核态的切换。</li>
<li>对于磁盘块的读取而言，每次访问磁盘读数据时，并不是读任意大小的数据的，而是每次读一个磁盘块或者若干个磁盘块(这是因为访问磁盘操作代价是很大的，而且我们也相信局部性原理) 因此，就需要有一个“中间缓冲区”–即内核缓冲区。先把数据从磁盘读到内核缓冲区中，然后再把数据从内核缓冲区搬到用户缓冲区。</li>
</ol>
<h6 id="内存映射"><a href="#内存映射" class="headerlink" title="内存映射"></a>内存映射</h6><p>   内存映射IO，也即JAVA NIO中提到的内存映射文件或者说 直接内存，示例图如下：</p>
<p><img src="/2017/06/09/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/img/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84.png"></p>
<p>从上图可以看出：内核空间的 buffer 与 用户空间的 buffer 都映射到同一块 物理内存区域。</p>
<p>它的主要特点如下：</p>
<ol>
<li><p>对文件的操作不需要再发read 或者 write 系统调用了</p>
</li>
<li><p>当用户进程访问“内存映射文件”地址时，自动产生缺页错误，然后由底层的OS负责将磁盘上的数据送到内存。</p>
</li>
</ol>
<p>这就是是JAVA NIO中提到的内存映射缓冲区（Memory-Mapped-Buffer）它类似于JAVA NIO中的直接缓冲区(Directed Buffer)。MemoryMappedBuffer可以通过java.nio.channels.FileChannel.java(通道)的 map方法创建。</p>
<p>使用内存映射缓冲区来操作文件，它比普通的IO操作读文件要快得多。甚至比使用文件通道(FileChannel)操作文件 还要快。因为，使用内存映射缓冲区操作文件时，没有显示的系统调用(read,write)，而且OS还会自动缓存一些文件页(memory page)</p>
<p><img src="/2017/06/09/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/img/%E9%80%BB%E8%BE%91%E5%86%85%E5%AD%98.png"></p>
<p>既然建立内存映射没有进行实际的数据拷贝，那么进程又怎么能最终直接通过内存操作访问到硬盘上的文件呢？那就要看内存映射之后的几个相关的过程了。<br> <br>mmap()会返回一个指针ptr，它指向进程逻辑地址空间中的一个地址，这样以后，进程无需再调用read或write对文件进行读写，而只需要通过ptr就能够操作文件。但是ptr所指向的是一个逻辑地址，要操作其中的数据，必须通过MMU将逻辑地址转换成物理地址。<br> <br>前面讲过，建立内存映射并没有实际拷贝数据，这时，MMU在地址映射表中是无法找到与ptr相对应的物理地址的，也就是MMU失败，将产生一个缺页中断，缺页中断的中断响应函数会在swap中寻找相对应的页面，如果找不到（也就是该文件从来没有被读入内存的情况），则会通过mmap()建立的映射关系，从硬盘上将文件读取到物理内存中。<br> <br>如果在拷贝数据时，发现物理内存不够用，则会通过虚拟内存机制（swap）将暂时不用的物理页面交换到硬盘上。</p>
<p>总结来说，内存映射文件是将硬盘上文件的位置与进程逻辑地址空间中一块大小相同的区域之间一一对应， 建立内存映射由mmap()系统调用将文件直接映射到用户空间，mmap()中没有进行数据拷贝，真正的数据拷贝是在缺页中断处理时进行的，mmap()会返回一个指针ptr，它指向进程逻辑地址空间中的一个地址，要操作其中的数据时即第一次访问ptr指向的内存区域，必须通过MMU将逻辑地址转换成物理地址，MMU在地址映射表中是无法找到与ptr相对应的物理地址的，也就是MMU失败，将产生一个缺页中断，缺页中断的中断响应函数会通过mmap()建立的映射关系，从硬盘上将文件读取到物理内存中，这个过程只进行了一次数据拷贝。因此，内存映射的效率要比read&#x2F;write调用效率高。</p>
<p>通过以上的 网络IO 和 文件IO 的策略，加上我们多线程并发处理，在下载速度上能够有一个较快的下载速度，尤其是在处理高速网络下载能力。</p>
<h4 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h4><p>QuarkDownloader实现了读写分离，同时提供了可选方式。全局一个线程来完成文件的写入。为了结合外部网络库的自身网络IO情况，内部保留了网络库的网络IO和文件IO的结合方式，典型的就是Okhttp的Okio</p>
<h4 id="无任何第三方依赖"><a href="#无任何第三方依赖" class="headerlink" title="无任何第三方依赖"></a>无任何第三方依赖</h4><p>QuarkDownloader下载组件剔除了所有的依赖，目前下载组件没有任何第三方依赖，当然我们需要JDK在1.4以上。</p>
<h4 id="通知栏接入和自定义"><a href="#通知栏接入和自定义" class="headerlink" title="通知栏接入和自定义"></a>通知栏接入和自定义</h4><p>QuarkDownloader提供了通知栏的高度自定义化接口，同时支持任务是否要显示在通知栏，在下载组件内部有静默任务和非静默任务，非静默任务通过注册的通知栏接口产生回调。我们来看看如何实现自己的通知栏。</p>
<p>QuarkDownloader抽象了一个通知栏通用接口：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnShowNotification</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 暂停或者移除任务时，处理通知栏</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">pauseOrRemove</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 显示通知栏和更新通知栏</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> status              </span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> baseDownloadTask</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> status, <span class="keyword">final</span> BaseDownloadTask baseDownloadTask)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 取消通知栏</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>非静默任务会根据接口的实现来回调通知栏。</p>
<h6 id="如何接入通知栏"><a href="#如何接入通知栏" class="headerlink" title="如何接入通知栏"></a>如何接入通知栏</h6><p>我们提供一组自定义的通知栏显示：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> DownloadNotificationManager implements QuarkDownloadNotificationManager.OnShowNotification &#123;</span><br><span class="line"></span><br><span class="line">    public static final <span class="built_in">int</span> DOWNLOAD_NOTIFICATION_ID = <span class="number">0x1213</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static final String PATTERN = <span class="string">&quot;mm&#x27;:&#x27;ss&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static final long ONE_HOUR = <span class="number">60</span><span class="operator"> * </span><span class="number">60</span><span class="operator"> * </span><span class="number">1000</span>; </span><br><span class="line">    <span class="keyword">private</span> static final long TIME_INTERVAL = <span class="number">5</span><span class="operator"> * </span><span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    public static final String OPEN_TYPE = <span class="string">&quot;open_type&quot;</span>;</span><br><span class="line">    public static final String OPEN_TYPE_ENTER_DOWNLOAD_INTERFACE = <span class="string">&quot;enter_download_interface&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static final String FORMAT_M = <span class="string">&quot;%#.1fM/s&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static final String FORMAT_K = <span class="string">&quot;%dK/s&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static final String FORMAT_NOTIFICATION_CONTENT = <span class="string">&quot;%s%s%s%s/%s%s%s%s%s&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static final String FORMAT_SPLITE = <span class="string">&quot;  |  &quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static final String FORMAT_PERCENT = <span class="string">&quot;%&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static final String STRING_ONE_HOUR = <span class="string">&quot;&gt;1 hour&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static final String STRING_UNKNOWN = <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static final String STRING_POINT = <span class="string">&quot;. &quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SimpleDateFormat mStringDateFormat;</span><br><span class="line">    <span class="keyword">private</span> Date mDate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> long mCurDownloadId = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> long mCurDownloadTime = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mDownloadingCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    NotificationCompat.Builder mBuilder;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;Long&gt; mListId = <span class="keyword">new</span> ArrayList&lt;&gt;<span class="literal">()</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="constructor">DownloadNotificationManager()</span> &#123;</span><br><span class="line">        mStringDateFormat = <span class="keyword">new</span> <span class="constructor">SimpleDateFormat(PATTERN)</span>;</span><br><span class="line">        mDate = <span class="keyword">new</span> <span class="constructor">Date()</span>;</span><br><span class="line"></span><br><span class="line">        Intent<span class="literal">[]</span> intents = <span class="keyword">new</span> Intent<span class="literal">[<span class="number">4</span>]</span>;</span><br><span class="line">        intents<span class="literal">[<span class="number">0</span>]</span> = <span class="keyword">new</span> <span class="constructor">Intent(ContextManager.<span class="params">getApplicationContext</span>()</span>, <span class="module-access"><span class="module"><span class="identifier">MainActivity</span>.</span></span><span class="keyword">class</span>);</span><br><span class="line">        intents<span class="literal">[<span class="number">0</span>]</span>.put<span class="constructor">Extra(OPEN_TYPE, OPEN_TYPE_ENTER_DOWNLOAD_INTERFACE)</span>;</span><br><span class="line">        PendingIntent pendingIntent<span class="literal">[]</span> = <span class="keyword">new</span> PendingIntent<span class="literal">[<span class="number">4</span>]</span>;</span><br><span class="line">        pendingIntent<span class="literal">[<span class="number">0</span>]</span> = <span class="module-access"><span class="module"><span class="identifier">PendingIntent</span>.</span></span>get<span class="constructor">Activity(ContextManager.<span class="params">getApplicationContext</span>()</span>, <span class="number">0</span>, intents<span class="literal">[<span class="number">0</span>]</span>, PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line"></span><br><span class="line">        mBuilder = <span class="keyword">new</span> NotificationCompat.</span><br><span class="line">                <span class="constructor">Builder(FileDownloadHelper.<span class="params">getAppContext</span>()</span>);</span><br><span class="line"></span><br><span class="line">        mBuilder.set<span class="constructor">Ongoing(<span class="params">true</span>)</span></span><br><span class="line">                .set<span class="constructor">Lights(0, 0, 0)</span> <span class="comment">//不需要显示灯光</span></span><br><span class="line">                .set<span class="constructor">Priority(NotificationCompat.PRIORITY_MAX)</span></span><br><span class="line">                .set<span class="constructor">ContentIntent(<span class="params">pendingIntent</span>[0])</span></span><br><span class="line">                .set<span class="constructor">When(0)</span></span><br><span class="line">                .set<span class="constructor">AutoCancel(<span class="params">true</span>)</span></span><br><span class="line">                .set<span class="constructor">SmallIcon(R.<span class="params">drawable</span>.<span class="params">small_icon</span>)</span></span><br><span class="line">                .set<span class="constructor">LargeIcon(BitmapFactory.<span class="params">decodeResource</span>(ContextManager.<span class="params">getApplicationContext</span>()</span>.get<span class="constructor">Resources()</span>, <span class="module-access"><span class="module"><span class="identifier">R</span>.</span></span>drawable.ic_logo));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> NotificationManager manager;</span><br><span class="line"></span><br><span class="line">    public NotificationManager get<span class="constructor">Manager()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (manager<span class="operator"> == </span>null) &#123;</span><br><span class="line">            manager = (NotificationManager) <span class="module-access"><span class="module"><span class="identifier">FileDownloadHelper</span>.</span></span>get<span class="constructor">AppContext()</span>.</span><br><span class="line">                    get<span class="constructor">SystemService(Context.NOTIFICATION_SERVICE)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        return manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static long mTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> static long INTERVAL = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void show(final <span class="built_in">int</span> status, final BaseDownloadTask baseDownloadTask) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="module-access"><span class="module"><span class="identifier">SystemUtils</span>.</span></span>isOpenNotification<span class="operator"> || </span>(<span class="module-access"><span class="module"><span class="identifier">SystemUtils</span>.</span></span>isFg<span class="operator"> &amp;&amp; </span>!<span class="module-access"><span class="module"><span class="identifier">SystemUtils</span>.</span></span>isShowNotificationMainUi)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        long <span class="keyword">end</span> = <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span>;</span><br><span class="line">        long interval = <span class="keyword">end</span> - mTime;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (interval &lt; INTERVAL<span class="operator"> &amp;&amp; </span>status<span class="operator"> == </span>QuarkDownloadTask.STATUS_PROGRESS) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        mTime = <span class="keyword">end</span>;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">ThreadManager</span>.</span></span>post(ThreadManager.THREAD_BACKGROUND, <span class="keyword">new</span> <span class="constructor">Runnable()</span> &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run<span class="literal">()</span> &#123;</span><br><span class="line">                show<span class="constructor">InBackgroundThread(<span class="params">status</span>, <span class="params">baseDownloadTask</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> void show<span class="constructor">InBackgroundThread(<span class="params">int</span> <span class="params">status</span>, BaseDownloadTask <span class="params">baseDownloadTask</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (baseDownloadTask<span class="operator"> == </span>null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (status != <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>completed<span class="operator"> &amp;&amp; </span>status != <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>error<span class="operator"> &amp;&amp; </span>status != <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>paused) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCurDownloadId<span class="operator"> == </span>-<span class="number">1</span>) &#123;</span><br><span class="line">                mCurDownloadTime = <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span>;</span><br><span class="line">                mCurDownloadId = baseDownloadTask.get<span class="constructor">Id()</span>;</span><br><span class="line">                mListId.add(mCurDownloadId);</span><br><span class="line">                mDownloadingCount = <span class="module-access"><span class="module"><span class="identifier">QuarkDownloader</span>.</span></span>get<span class="constructor">Instance()</span>.get<span class="constructor">DownloadingTaskCount()</span>.length;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mListId.contains((long) baseDownloadTask.get<span class="constructor">Id()</span>)<span class="operator"> &amp;&amp; </span>mCurDownloadId != baseDownloadTask.get<span class="constructor">Id()</span><span class="operator"> &amp;&amp; </span>((<span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span> - mCurDownloadTime) &lt; TIME_INTERVAL)) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mCurDownloadId != baseDownloadTask.get<span class="constructor">Id()</span><span class="operator"> &amp;&amp; </span>(<span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span> - mCurDownloadTime) &gt;= TIME_INTERVAL) &#123;</span><br><span class="line">                mCurDownloadTime = <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCurDownloadId = baseDownloadTask.get<span class="constructor">Id()</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mListId.contains(mCurDownloadId)) &#123;</span><br><span class="line">            mListId.add(mCurDownloadId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        switch (status) &#123;</span><br><span class="line">            case <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>pending:</span><br><span class="line">                mDownloadingCount = <span class="module-access"><span class="module"><span class="identifier">QuarkDownloader</span>.</span></span>get<span class="constructor">Instance()</span>.get<span class="constructor">DownloadingTaskCount()</span>.length;</span><br><span class="line">                break;</span><br><span class="line">            case <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>started:</span><br><span class="line">                mDownloadingCount = <span class="module-access"><span class="module"><span class="identifier">QuarkDownloader</span>.</span></span>get<span class="constructor">Instance()</span>.get<span class="constructor">DownloadingTaskCount()</span>.length;</span><br><span class="line">                break;</span><br><span class="line">            case <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>progress:</span><br><span class="line">                break;</span><br><span class="line">            case <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>retry:</span><br><span class="line">                break;</span><br><span class="line">            case <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>error:</span><br><span class="line">                <span class="keyword">if</span> (mListId.contains(mCurDownloadId)) &#123;</span><br><span class="line">                    mListId.remove(mCurDownloadId);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>paused:</span><br><span class="line">                <span class="keyword">if</span> (mListId.contains(mCurDownloadId)) &#123;</span><br><span class="line">                    mListId.remove(mCurDownloadId);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>completed:</span><br><span class="line">                <span class="keyword">if</span> (mListId.contains(mCurDownloadId)) &#123;</span><br><span class="line">                    mListId.remove(mCurDownloadId);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case <span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>warn:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mListId.size<span class="literal">()</span> != mDownloadingCount) &#123;</span><br><span class="line">            mDownloadingCount = <span class="module-access"><span class="module"><span class="identifier">QuarkDownloader</span>.</span></span>get<span class="constructor">Instance()</span>.get<span class="constructor">DownloadingTaskCount()</span>.length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String speed;</span><br><span class="line">        long sp = baseDownloadTask.get<span class="constructor">Speed()</span>;</span><br><span class="line">        <span class="keyword">if</span> (sp &gt; <span class="number">1024</span>) &#123;</span><br><span class="line">            speed = <span class="module-access"><span class="module"><span class="identifier">String</span>.</span></span>format(Locale.CHINESE, FORMAT_M, (<span class="built_in">float</span>) sp<span class="operator"> / </span>(<span class="built_in">float</span>) <span class="number">1024</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            speed = <span class="module-access"><span class="module"><span class="identifier">String</span>.</span></span>format(Locale.CHINESE, FORMAT_K, sp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        long sofar = baseDownloadTask.get<span class="constructor">LargeFileSoFarBytes()</span>;</span><br><span class="line">        long total = baseDownloadTask.get<span class="constructor">LargeFileTotalBytes()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> progress = total &lt;= <span class="number">0</span> ? <span class="number">0</span> : (<span class="built_in">int</span>) ((sofar<span class="operator"> / </span>(<span class="built_in">float</span>) total)<span class="operator"> * </span><span class="number">100</span>);</span><br><span class="line">        String title;</span><br><span class="line">        String content;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (((status<span class="operator"> == </span><span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>completed<span class="operator"> &amp;&amp; </span><span class="module-access"><span class="module"><span class="identifier">QuarkDownloader</span>.</span></span>get<span class="constructor">Instance()</span>.is<span class="constructor">Idle()</span>)<span class="operator"> || </span>status<span class="operator"> == </span><span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>error<span class="operator"> || </span>status<span class="operator"> == </span><span class="module-access"><span class="module"><span class="identifier">FileDownloadStatus</span>.</span></span>paused)<span class="operator"> &amp;&amp; </span>mListId.size<span class="literal">()</span><span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">int</span><span class="literal">[]</span> completeAndPauseCount = <span class="module-access"><span class="module"><span class="identifier">QuarkDownloader</span>.</span></span>get<span class="constructor">Instance()</span>.get<span class="constructor">CompleteAndPauseCount()</span>;</span><br><span class="line">            title = <span class="module-access"><span class="module"><span class="identifier">FileDownloadHelper</span>.</span></span>get<span class="constructor">AppContext()</span>.get<span class="constructor">String(R.<span class="params">string</span>.<span class="params">app_name</span>)</span> + <span class="string">&quot; &quot;</span> + <span class="module-access"><span class="module"><span class="identifier">FileDownloadHelper</span>.</span></span>get<span class="constructor">AppContext()</span>.get<span class="constructor">String(R.<span class="params">string</span>.<span class="params">download</span>)</span>;</span><br><span class="line">            content = (completeAndPauseCount<span class="literal">[<span class="number">1</span>]</span> &gt; <span class="number">0</span> ? <span class="module-access"><span class="module"><span class="identifier">FileDownloadHelper</span>.</span></span>get<span class="constructor">AppContext()</span>.get<span class="constructor">String(R.<span class="params">string</span>.<span class="params">download_notification_task</span>)</span> + <span class="string">&quot; &quot;</span> + completeAndPauseCount<span class="literal">[<span class="number">1</span>]</span> + FORMAT_SPLITE : <span class="string">&quot;&quot;</span>) + <span class="module-access"><span class="module"><span class="identifier">FileDownloadHelper</span>.</span></span>get<span class="constructor">AppContext()</span>.get<span class="constructor">String(R.<span class="params">string</span>.<span class="params">download_notification_complete</span>)</span> + <span class="string">&quot; &quot;</span> + completeAndPauseCount<span class="literal">[<span class="number">0</span>]</span>;</span><br><span class="line">            mDownloadingCount = <span class="number">0</span>;</span><br><span class="line">            mBuilder.set<span class="constructor">Ongoing(<span class="params">false</span>)</span>;</span><br><span class="line">            mBuilder.set<span class="constructor">Progress(0, 0, <span class="params">false</span>)</span>;</span><br><span class="line">            notify(title, content, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">int</span> index = mDownloadingCount &gt; <span class="number">1</span> ? get<span class="constructor">Index(<span class="params">mListId</span>, <span class="params">baseDownloadTask</span>.<span class="params">getId</span>()</span>) : -<span class="number">1</span>;</span><br><span class="line">            title = (index &gt; <span class="number">0</span> ? index + STRING_POINT : <span class="string">&quot;&quot;</span>) + baseDownloadTask.get<span class="constructor">Filename()</span>;</span><br><span class="line">            long timeLeft = sp &lt;= <span class="number">0</span> ? (total - sofar) : (total - sofar)<span class="operator"> / </span>sp;</span><br><span class="line">            mDate.set<span class="constructor">Time(<span class="params">timeLeft</span>)</span>;</span><br><span class="line">            String timeTips = timeLeft &gt;= ONE_HOUR ? STRING_ONE_HOUR : mStringDateFormat.format(mDate);</span><br><span class="line">            content = <span class="module-access"><span class="module"><span class="identifier">String</span>.</span></span>format(FORMAT_NOTIFICATION_CONTENT, total &lt;= <span class="number">0</span> ? STRING_UNKNOWN : progress + <span class="string">&quot;&quot;</span>, FORMAT_PERCENT, FORMAT_SPLITE, <span class="module-access"><span class="module"><span class="identifier">QuarkFileUtlis</span>.</span></span>format<span class="constructor">Size(<span class="params">sofar</span>)</span>, <span class="module-access"><span class="module"><span class="identifier">QuarkFileUtlis</span>.</span></span>format<span class="constructor">Size(<span class="params">total</span>)</span>, FORMAT_SPLITE, speed, FORMAT_SPLITE, total &lt;= <span class="number">0</span> ? STRING_UNKNOWN : timeTips);</span><br><span class="line">            mBuilder.set<span class="constructor">Ongoing(<span class="params">true</span>)</span>;</span><br><span class="line">            mBuilder.set<span class="constructor">Progress(1000, (<span class="params">int</span>)</span> ((sofar<span class="operator"> / </span>(<span class="built_in">float</span>) total)<span class="operator"> * </span><span class="number">1000</span>), total &lt;= <span class="number">0</span>);</span><br><span class="line">            notify(title, content, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static <span class="built_in">int</span> get<span class="constructor">Index(List&lt;Long&gt; <span class="params">list</span>, <span class="params">int</span> <span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">list</span><span class="operator"> == </span>null<span class="operator"> || </span><span class="built_in">list</span>.size<span class="literal">()</span><span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">            return -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">list</span>.size<span class="literal">()</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">list</span>.get(i)<span class="operator"> == </span>id) &#123;</span><br><span class="line">                return i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean pause<span class="constructor">OrRemove()</span> &#123;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">ThreadManager</span>.</span></span>post(ThreadManager.THREAD_BACKGROUND, <span class="keyword">new</span> <span class="constructor">Runnable()</span> &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run<span class="literal">()</span> &#123;</span><br><span class="line">                pause<span class="constructor">InBackgroundThread()</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        return <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> void pause<span class="constructor">InBackgroundThread()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mListId<span class="operator"> == </span>null<span class="operator"> || </span>mListId.size<span class="literal">()</span><span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">int</span><span class="literal">[]</span> completeAndPauseCount = <span class="module-access"><span class="module"><span class="identifier">QuarkDownloader</span>.</span></span>get<span class="constructor">Instance()</span>.get<span class="constructor">CompleteAndPauseCount()</span>;</span><br><span class="line">            String title = <span class="module-access"><span class="module"><span class="identifier">FileDownloadHelper</span>.</span></span>get<span class="constructor">AppContext()</span>.get<span class="constructor">String(R.<span class="params">string</span>.<span class="params">app_name</span>)</span> + <span class="string">&quot; &quot;</span> + <span class="module-access"><span class="module"><span class="identifier">FileDownloadHelper</span>.</span></span>get<span class="constructor">AppContext()</span>.get<span class="constructor">String(R.<span class="params">string</span>.<span class="params">download</span>)</span>;</span><br><span class="line">            String content = (completeAndPauseCount<span class="literal">[<span class="number">1</span>]</span> &gt; <span class="number">0</span> ? <span class="module-access"><span class="module"><span class="identifier">FileDownloadHelper</span>.</span></span>get<span class="constructor">AppContext()</span>.get<span class="constructor">String(R.<span class="params">string</span>.<span class="params">download_notification_task</span>)</span> + <span class="string">&quot; &quot;</span> + completeAndPauseCount<span class="literal">[<span class="number">1</span>]</span> + <span class="string">&quot; | &quot;</span> : <span class="string">&quot;&quot;</span>) + <span class="module-access"><span class="module"><span class="identifier">FileDownloadHelper</span>.</span></span>get<span class="constructor">AppContext()</span>.get<span class="constructor">String(R.<span class="params">string</span>.<span class="params">download_notification_complete</span>)</span> + <span class="string">&quot; &quot;</span> + completeAndPauseCount<span class="literal">[<span class="number">0</span>]</span>;</span><br><span class="line">            mDownloadingCount = <span class="number">0</span>;</span><br><span class="line">            mBuilder.set<span class="constructor">Ongoing(<span class="params">false</span>)</span>;</span><br><span class="line">            mBuilder.set<span class="constructor">Progress(0, 0, <span class="params">false</span>)</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (completeAndPauseCount<span class="literal">[<span class="number">0</span>]</span><span class="operator"> == </span><span class="number">0</span><span class="operator"> &amp;&amp; </span>completeAndPauseCount<span class="literal">[<span class="number">1</span>]</span><span class="operator"> == </span><span class="number">0</span>) &#123;</span><br><span class="line">                cancel<span class="literal">()</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                notify(title, content, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> void notify(String title, String content, boolean isShowFileDownloadProcess) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">                mBuilder.set<span class="constructor">ContentTitle(<span class="params">content</span>)</span></span><br><span class="line">                        .set<span class="constructor">SubText(<span class="params">title</span>)</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mBuilder.set<span class="constructor">ContentTitle(<span class="params">title</span>)</span></span><br><span class="line">                        .set<span class="constructor">ContentText(<span class="params">content</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mBuilder.set<span class="constructor">Number(<span class="params">mDownloadingCount</span>)</span>;</span><br><span class="line">            Notification notification = mBuilder.get<span class="constructor">Notification()</span>;</span><br><span class="line">            <span class="built_in">int</span> smallIconId = <span class="module-access"><span class="module"><span class="identifier">ContextManager</span>.</span></span>get<span class="constructor">ApplicationContext()</span>.get<span class="constructor">Resources()</span>.get<span class="constructor">Identifier(<span class="string">&quot;right_icon&quot;</span>, <span class="string">&quot;id&quot;</span>, <span class="params">android</span>.R.<span class="params">class</span>.<span class="params">getPackage</span>()</span>.get<span class="constructor">Name()</span>);</span><br><span class="line">            <span class="keyword">if</span> (smallIconId != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (notification.contentView != null) &#123;</span><br><span class="line">                    notification.contentView.set<span class="constructor">ViewVisibility(<span class="params">smallIconId</span>, View.INVISIBLE)</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (notification.bigContentView != null) &#123;</span><br><span class="line">                        notification.bigContentView.set<span class="constructor">ViewVisibility(<span class="params">smallIconId</span>, View.INVISIBLE)</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isShowFileDownloadProcess) &#123;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">QuarkDownloader</span>.</span></span>get<span class="constructor">Instance()</span>.notify<span class="constructor">Notification(DOWNLOAD_NOTIFICATION_ID, <span class="params">notification</span>)</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                get<span class="constructor">Manager()</span>.notify(DOWNLOAD_NOTIFICATION_ID, notification);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.print<span class="constructor">StackTrace()</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void cancel<span class="literal">()</span> &#123;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">ThreadManager</span>.</span></span>remove<span class="constructor">Runnable(<span class="params">mCancleRunnable</span>)</span>;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">ThreadManager</span>.</span></span>post(ThreadManager.THREAD_BACKGROUND, mCancleRunnable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Runnable mCancleRunnable = <span class="keyword">new</span> <span class="constructor">Runnable()</span> &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run<span class="literal">()</span> &#123;</span><br><span class="line">            get<span class="constructor">Manager()</span>.cancel(DOWNLOAD_NOTIFICATION_ID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的实现，业务方可以根据自己的业务需求自己来做出实现，这样非常灵活，QuarkDownloader只是把通知栏的抽象起来，提供给外部统一的处理入口。</p>
<p>接下来，我们只要初始化这个实现，就能够轻松的实现通知栏：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DownloadNotificationManager mDownloadNotificationManager = <span class="keyword">new</span> <span class="constructor">DownloadNotificationManager()</span>;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">QuarkDownloadNotificationManager</span>.</span></span>get<span class="constructor">Instance()</span>.set<span class="constructor">OnShowNotification(<span class="params">mDownloadNotificationManager</span>)</span>;</span><br><span class="line">                </span><br></pre></td></tr></table></figure>

<p>那么这样你的应用就拥有自己的通知栏。</p>
<h4 id="下载组件的执行逻辑"><a href="#下载组件的执行逻辑" class="headerlink" title="下载组件的执行逻辑"></a>下载组件的执行逻辑</h4><p>这里我画了下下载组件的大致流程图：</p>
<p><img src="/2017/06/09/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/img/%E4%B8%8B%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%9B%BE.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/04/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%9D%A5%E6%8F%90%E4%BE%9BIO%E6%95%88%E7%8E%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/06/04/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%9D%A5%E6%8F%90%E4%BE%9BIO%E6%95%88%E7%8E%87/" class="post-title-link" itemprop="url">下载模块使用文件内存映射来提供IO效率</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-04 17:36:51" itemprop="dateCreated datePublished" datetime="2017-06-04T17:36:51+08:00">2017-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:12:39" itemprop="dateModified" datetime="2022-05-11T14:12:39+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="简单介绍下传统IO的方式"><a href="#简单介绍下传统IO的方式" class="headerlink" title="简单介绍下传统IO的方式"></a>简单介绍下传统IO的方式</h4><p>IO，其实意味着：数据不停地搬入搬出缓冲区而已（使用了缓冲区）。比如，用户程序发起读操作，导致“ syscall read ”系统调用，就会把数据搬入到 一个buffer中；用户发起写操作，导致 “syscall write ”系统调用，将会把一个 buffer 中的数据 搬出去(发送到网络中 or 写入到磁盘文件)</p>
<p>普通的IO处理的流程图：</p>
<p><img src="/2017/06/04/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%9D%A5%E6%8F%90%E4%BE%9BIO%E6%95%88%E7%8E%87/img/NormalIO.png"></p>
<ol>
<li>将数据从磁盘读数据到内核缓冲区，由DMA来完成</li>
<li>然后内核将内核缓冲区的数据拷贝到用户空间的用户进程</li>
<li>这样完成了数据的读</li>
</ol>
<p>一般Java应用程序读取数据代码如下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line"><span class="keyword">long</span> len;</span><br><span class="line"><span class="keyword">while</span>((len = inputStream.<span class="keyword">read</span>(b))&gt;=<span class="number">0</span>) &#123;        </span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当执行到read()方法时，底层执行了很多操作的：</p>
<ol>
<li>内核给磁盘控制器发指令：我要读磁盘上的某块磁盘块上的数据。</li>
<li>在DMA的控制下，把磁盘上的数据读入到内核缓冲区。</li>
<li>内核把数据从内核缓冲区拷贝到用户缓冲区。</li>
</ol>
<p>从上面几步我们可以分析出：</p>
<ol>
<li><p>就操作系统而言，JVM只是一个用户进程，处于用户态空间中。而处于用户态空间的进程是不能直接操作底层硬件的。而IO操作就需要操作底层的硬件，比如磁盘。因此，IO操作必须得借助内核的帮助才能完成(中断，trap)，即：会有用户态到内核态的切换。</p>
</li>
<li><p>对于磁盘块的读取而言，每次访问磁盘读数据时，并不是读任意大小的数据的，而是每次读一个磁盘块或者若干个磁盘块(这是因为访问磁盘操作代价是很大的，而且我们也相信局部性原理) 因此，就需要有一个“中间缓冲区”–即内核缓冲区。先把数据从磁盘读到内核缓冲区中，然后再把数据从内核缓冲区搬到用户缓冲区。<br><br><br>这也是为什么我们总感觉到第一次read操作很慢，而后续的read操作却很快的原因吧。因为，对于后续的read操作而言，它所需要读的数据很可能已经在内核缓冲区了，此时只需将内核缓冲区中的数据拷贝到用户缓冲区即可，并未涉及到底层的读取磁盘操作，当然就快了。如果数据不可用，process将会被挂起，并需要等待内核从磁盘上把数据取到内核缓冲区中。</p>
</li>
<li><p>DMA为什么不直接将磁盘上的数据读入到用户缓冲区呢？一方面是 ⓑ中提到的内核缓冲区作为一个中间缓冲区。用来“适配”用户缓冲区的“任意大小”和每次读磁盘块的固定大小。另一方面则是，用户缓冲区位于用户态空间，而DMA读取数据这种操作涉及到底层的硬件，硬件一般是不能直接访问用户态空间的（OS的原因吧）<br><br>综上，由于DMA不能直接访问用户空间(用户缓冲区)，普通IO操作需要将数据来回地在 用户缓冲区 和 内核缓冲区移动，这在一定程序上影响了IO的速度。那有没有相应的解决方案呢？</p>
</li>
</ol>
<h4 id="内存映射"><a href="#内存映射" class="headerlink" title="内存映射"></a>内存映射</h4><p>   内存映射IO，也即JAVA NIO中提到的内存映射文件或者说 直接内存，示例图如下：</p>
<p><img src="/2017/06/04/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%9D%A5%E6%8F%90%E4%BE%9BIO%E6%95%88%E7%8E%87/img/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84.png"></p>
<p>从上图可以看出：内核空间的 buffer 与 用户空间的 buffer 都映射到同一块 物理内存区域。</p>
<p>它的主要特点如下：</p>
<ol>
<li><p>对文件的操作不需要再发read 或者 write 系统调用了—The user process sees the file data asmemory, so there is no need to issue read() or write() system calls.</p>
</li>
<li><p>当用户进程访问“内存映射文件”地址时，自动产生缺页错误，然后由底层的OS负责将磁盘上的数据送到内存。</p>
</li>
</ol>
<p>这就是是JAVA NIO中提到的内存映射缓冲区（Memory-Mapped-Buffer）它类似于JAVA NIO中的直接缓冲区(Directed Buffer)。MemoryMappedBuffer可以通过java.nio.channels.FileChannel.java(通道)的 map方法创建。</p>
<p>使用内存映射缓冲区来操作文件，它比普通的IO操作读文件要快得多。甚至比使用文件通道(FileChannel)操作文件 还要快。因为，使用内存映射缓冲区操作文件时，没有显示的系统调用(read,write)，而且OS还会自动缓存一些文件页(memory page)</p>
<h4 id="操作系统的内存区域分布"><a href="#操作系统的内存区域分布" class="headerlink" title="操作系统的内存区域分布"></a>操作系统的内存区域分布</h4><p>内存映射文件和之前说的 标准IO操作最大的不同之处就在于它虽然最终也是要从磁盘读取数据，但是它并不需要将数据读取到OS内核缓冲区，而是直接将进程的用户私有地址空间中的一部分区域与文件对象建立起映射关系，就好像直接从内存中读、写文件一样，速度当然快了。</p>
<p>为了说清楚这个，我们以Linux操作系统为例子，看下图：</p>
<p><img src="/2017/06/04/%E4%B8%8B%E8%BD%BD%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%9D%A5%E6%8F%90%E4%BE%9BIO%E6%95%88%E7%8E%87/img/OS_map_file.jpg"></p>
<p> Linux中的进程虚拟存储器，即进程的虚拟地址空间，如果你的机子是 32 位，那么就有  2^32 &#x3D; 4G的虚拟地址空间，我们可以看到图中有一块区域： “Memory mapped region for shared libraries” ，这段区域就是在内存映射文件的时候将某一段的虚拟地址和文件对象的某一部分建立起映射关系，此时并没有拷贝数据到内存中去，而是当进程代码第一次引用这段代码内的虚拟地址时，触发了缺页异常，这时候OS根据映射关系直接将文件的相关部分数据拷贝到进程的用户私有空间中去，当有操作第N页数据的时候重复这样的OS页面调度程序操作。注意啦，原来内存映射文件的效率比标准IO高的重要原因就是因为少了把数据拷贝到OS内核缓冲区这一步（可能还少了native堆中转这一步）。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">File</span> <span class="keyword">file</span> = <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">&quot;vanda.apk&quot;</span>);  </span><br><span class="line">FileInputStream in = <span class="keyword">new</span> FileInputStream(<span class="keyword">file</span>);  </span><br><span class="line">FileChannel channel = in.getChannel();  </span><br><span class="line">MappedByteBuffer buff = channel.map(FileChannel.MapMode.READ_ONLY, <span class="number">0</span>,channel.<span class="keyword">size</span>());  </span><br></pre></td></tr></table></figure>

<p>这样就获取到了内存映射MappedByteBuffer。</p>
<p>总结来说：</p>
<p>内存映射文件是将硬盘上文件的位置与进程逻辑地址空间中一块大小相同的区域之间一一对应， 建立内存映射由mmap()系统调用将文件直接映射到用户空间，mmap()中没有进行数据拷贝，真正的数据拷贝是在缺页中断处理时进行的，mmap()会返回一个指针ptr，它指向进程逻辑地址空间中的一个地址，要操作其中的数据时即第一次访问ptr指向的内存区域，必须通过MMU将逻辑地址转换成物理地址，MMU在地址映射表中是无法找到与ptr相对应的物理地址的，也就是MMU失败，将产生一个缺页中断，缺页中断的中断响应函数会通过mmap()建立的映射关系，从硬盘上将文件读取到物理内存中，这个过程只进行了一次数据拷贝。因此，内存映射的效率要比read&#x2F;write调用效率高。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/09/%E5%A4%9A%E8%B0%A2%E5%A4%A7%E5%AE%B6%E7%9A%84%E6%94%AF%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/04/09/%E5%A4%9A%E8%B0%A2%E5%A4%A7%E5%AE%B6%E7%9A%84%E6%94%AF%E6%8C%81/" class="post-title-link" itemprop="url">多谢大家的支持</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-04-09 21:32:16" itemprop="dateCreated datePublished" datetime="2017-04-09T21:32:16+08:00">2017-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 11:45:09" itemprop="dateModified" datetime="2022-05-11T11:45:09+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>多谢大家的支持，本软件长期维护，如果你觉得好用，或者有更好的意见和建议，欢迎告知。</p>
<p>开发一款软件需要时间和精力，你的小小心意是我继续的动力，谢谢你们！</p>
<h4 id="支付宝捐赠-（长按保存图片）："><a href="#支付宝捐赠-（长按保存图片）：" class="headerlink" title="支付宝捐赠 （长按保存图片）："></a>支付宝捐赠 （长按保存图片）：</h4><p><img src="/2017/04/09/%E5%A4%9A%E8%B0%A2%E5%A4%A7%E5%AE%B6%E7%9A%84%E6%94%AF%E6%8C%81/img/zhifubao.png"></p>
<h4 id="微信捐赠-（长按保存图片）："><a href="#微信捐赠-（长按保存图片）：" class="headerlink" title="微信捐赠 （长按保存图片）："></a>微信捐赠 （长按保存图片）：</h4><p><img src="/2017/04/09/%E5%A4%9A%E8%B0%A2%E5%A4%A7%E5%AE%B6%E7%9A%84%E6%94%AF%E6%8C%81/img/wechat.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/30/%E4%B8%8B%E8%BD%BD%E5%A4%B1%E8%B4%A5%E7%9A%84%E6%B5%8B%E8%AF%95%E9%93%BE%E6%8E%A5%E5%9C%B0%E5%9D%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/30/%E4%B8%8B%E8%BD%BD%E5%A4%B1%E8%B4%A5%E7%9A%84%E6%B5%8B%E8%AF%95%E9%93%BE%E6%8E%A5%E5%9C%B0%E5%9D%80/" class="post-title-link" itemprop="url">下载失败的测试链接地址</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-30 15:29:25" itemprop="dateCreated datePublished" datetime="2017-03-30T15:29:25+08:00">2017-03-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2017-11-13 20:51:18" itemprop="dateModified" datetime="2017-11-13T20:51:18+08:00">2017-11-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <table>
<thead>
<tr>
<th>地址</th>
<th>备注</th>
<th>所属情况</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://aq.qq.com/cn2/manage/mbtoken/3g_token_download?source_id=2886">https://aq.qq.com/cn2/manage/mbtoken/3g_token_download?source_id=2886</a></td>
<td>不可续传</td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://cn.club.vmall.com/forum.php?mod=attachment&amp;aid=MjkzMzgwOXxiODViYzM3MnwxNDg5NTEyMzcxfDcxMjE1OTh8NTc4MjA3Mw==">http://cn.club.vmall.com/forum.php?mod=attachment&amp;aid=MjkzMzgwOXxiODViYzM3MnwxNDg5NTEyMzcxfDcxMjE1OTh8NTc4MjA3Mw%3D%3D</a></td>
<td>不可续传</td>
<td></td>
</tr>
<tr>
<td>学科网</td>
<td></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://g.onegreen.net/Index.html">http://g.onegreen.net/Index.html</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td>微盘下载</td>
<td></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://www.rmdown.com/link.php?hash=1717dd391fab49680e22806924fd918be3d85f3bca2">http://www.rmdown.com/link.php?hash=1717dd391fab49680e22806924fd918be3d85f3bca2</a></td>
<td>chunked类型</td>
<td></td>
</tr>
<tr>
<td>pdfdo 上的文件下载</td>
<td>chunk类型</td>
<td>传输结束后返回异常</td>
</tr>
<tr>
<td>网易邮箱附件</td>
<td>chunk类型</td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://a.byfen.com/update.html">http://a.byfen.com/update.html</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://forum.xda-developers.com/devdb/project/dl/?id=23698">https://forum.xda-developers.com/devdb/project/dl/?id=23698</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://download.mql5.com/cdn/web/metaquotes.software.corp/mt4/metatrader4.apk?utm_campaign=www.metatrader4.com">https://download.mql5.com/cdn/web/metaquotes.software.corp/mt4/metatrader4.apk?utm_campaign=www.metatrader4.com</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.metatrader4.com/en/download">https://www.metatrader4.com/en/download</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://s3.amazonaws.com/psiphon/web/mjr4-p23r-puwl/PsiphonAndroid.apk">https://s3.amazonaws.com/psiphon/web/mjr4-p23r-puwl/PsiphonAndroid.apk</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>种子文件</td>
<td></td>
<td></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://www.46eh.com/html/article/670350.html">http://www.46eh.com/html/article/670350.html</a></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/22/HTTP%E5%8D%8F%E8%AE%AE%E5%A4%B4%E9%83%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/22/HTTP%E5%8D%8F%E8%AE%AE%E5%A4%B4%E9%83%A8/" class="post-title-link" itemprop="url">HTTP协议头部</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-22 21:42:09" itemprop="dateCreated datePublished" datetime="2017-03-22T21:42:09+08:00">2017-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:35:00" itemprop="dateModified" datetime="2022-05-11T14:35:00+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="什么是Keep-Alive模式？"><a href="#什么是Keep-Alive模式？" class="headerlink" title="什么是Keep-Alive模式？"></a>什么是Keep-Alive模式？</h4><p>我们知道HTTP协议采用“请求-应答”模式，当使用普通模式，即非KeepAlive模式时，每个请求&#x2F;应答客户和服务器都要新建一个连接，完成 之后立即断开连接（HTTP协议为无连接的协议）；当使用Keep-Alive模式（又称持久连接、连接重用）时，Keep-Alive功能使客户端到服 务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive功能避免了建立或者重新建立连接。</p>
<p><img src="/./HTTP%E5%8D%8F%E8%AE%AE%E5%A4%B4%E9%83%A8/img/http.png"></p>
<p>http 1.0中默认是关闭的，需要在http头加入”Connection: Keep-Alive”，才能启用Keep-Alive；http 1.1中默认启用Keep-Alive，如果加入”Connection: close “，才关闭。目前大部分浏览器都是用http1.1协议，也就是说默认都会发起Keep-Alive的连接请求了，所以是否能完成一个完整的Keep- Alive连接就看服务器设置情况。</p>
<h4 id="启用Keep-Alive的优点"><a href="#启用Keep-Alive的优点" class="headerlink" title="启用Keep-Alive的优点"></a>启用Keep-Alive的优点</h4><p>从上面的分析来看，启用Keep-Alive模式肯定更高效，性能更高。因为避免了建立&#x2F;释放连接的开销。下面是RFC 2616 上的总结：</p>
<ol>
<li><p>By opening and closing fewer TCP connections, CPU time is saved in routers and hosts (clients, servers, proxies, gateways, tunnels, or caches), and memory used for TCP protocol control blocks can be saved in hosts.</p>
</li>
<li><p>HTTP requests and responses can be pipelined on a connection. Pipelining allows a client to make multiple requests without waiting for each response, allowing a single TCP connection to be used much more efficiently, with much lower elapsed time.</p>
</li>
<li><p>Network congestion is reduced by reducing the number of packets caused by TCP opens, and by allowing TCP sufficient time to determine the congestion state of the network.</p>
</li>
<li><p>Latency on subsequent requests is reduced since there is no time spent in TCP’s connection opening handshake.</p>
</li>
<li><p>HTTP can evolve more gracefully, since errors can be reported without the penalty of closing the TCP connection. Clients using future versions of HTTP might optimistically try a new feature, but if communicating with an older server, retry with old semantics after an error is reported.</p>
</li>
</ol>
<p>RFC 2616 （P47）还指出：单用户客户端与任何服务器或代理之间的连接数不应该超过2个。一个代理与其它服务器或代码之间应该使用不超过2 * N的活跃并发连接。这是为了提高HTTP响应时间，避免拥塞（冗余的连接并不能代码执行性能的提升）</p>
<h4 id="回到我们的问题（即如何判断消息内容-x2F-长度的大小？）"><a href="#回到我们的问题（即如何判断消息内容-x2F-长度的大小？）" class="headerlink" title="回到我们的问题（即如何判断消息内容&#x2F;长度的大小？）"></a>回到我们的问题（即如何判断消息内容&#x2F;长度的大小？）</h4><p>Keep-Alive模式，客户端如何判断请求所得到的响应数据已经接收完成（或者说如何知道服务器已经发生完了数据）？我们已经知道 了，Keep-Alive模式发送玩数据HTTP服务器不会自动断开连接，所有不能再使用返回EOF（-1）来判断（当然你一定要这样使用也没有办法，可 以想象那效率是何等的低）！下面我介绍两种来判断方法。</p>
<h6 id="使用消息首部字段Conent-Length"><a href="#使用消息首部字段Conent-Length" class="headerlink" title="使用消息首部字段Conent-Length"></a>使用消息首部字段Conent-Length</h6><p>故名思意，Conent-Length表示实体内容长度，客户端（服务器）可以根据这个值来判断数据是否接收完成。但是如果消息中没有Conent-Length，那该如何来判断呢？又在什么情况下会没有Conent-Length呢？请继续往下看……</p>
<h6 id="使用消息首部字段Transfer-Encoding"><a href="#使用消息首部字段Transfer-Encoding" class="headerlink" title="使用消息首部字段Transfer-Encoding"></a>使用消息首部字段Transfer-Encoding</h6><p>当客户端向服务器请求一个静态页面或者一张图片时，服务器可以很清楚的知道内容大小，然后通过Content-length消息首部字段告诉客户端 需要接收多少数据。但是如果是动态页面等时，服务器是不可能预先知道内容大小，这时就可以使用Transfer-Encoding：chunk模式来传输 数据了。即如果要一边产生数据，一边发给客户端，服务器就需要使用”Transfer-Encoding: chunked”这样的方式来代替Content-Length。</p>
<p>chunk编码将数据分成一块一块的发生。Chunked编码将使用若干个Chunk串连而成，由一个标明长度为0 的chunk标示结束。每个Chunk分为头部和正文两部分，头部内容指定正文的字符总数（十六进制的数字 ）和数量单位（一般不写），正文部分就是指定长度的实际内容，两部分之间用回车换行(CRLF) 隔开。在最后一个长度为0的Chunk中的内容是称为footer的内容，是一些附加的Header信息（通常可以直接忽略）。 Chunk编码的格式如下：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Chunked-Body = *<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>chunk <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="string">&quot;0&quot;</span> CRLF</span><br><span class="line">footer</span><br><span class="line">CRLF</span><br><span class="line">chunk = chunk-size [ chunk-ext ] CRLF</span><br><span class="line">chunk-data CRLF</span><br><span class="line"></span><br><span class="line">hex-no-zero = &amp;<span class="literal">lt</span>;HEX excluding <span class="string">&quot;0&quot;</span>&amp;<span class="literal">gt</span>;</span><br><span class="line"></span><br><span class="line">chunk-size = hex-no-zero *HEX</span><br><span class="line">chunk-ext = *( <span class="string">&quot;;&quot;</span> chunk-ext-name [ <span class="string">&quot;=&quot;</span> chunk-ext-value ] )</span><br><span class="line">chunk-ext-name = token</span><br><span class="line">chunk-ext-val = token | quoted-string</span><br><span class="line">chunk-data = chunk-size(OCTET)</span><br><span class="line"></span><br><span class="line">footer = *entity-header</span><br><span class="line"></span><br><span class="line">即Chunk编码由四部分组成： <span class="number">1</span>、<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>0至多个chunk块<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span> ，<span class="number">2</span>、<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>&quot;0&quot; CRLF <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span>，<span class="number">3</span>、<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>footer <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span>，<span class="number">4</span>、<span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>CRLF<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span> <span class="language-xml"><span class="tag">&lt;<span class="name">strong</span>&gt;</span>.<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span> 而每个chunk块由：chunk-size、chunk-ext（可选）、CRLF、chunk-data、CRLF组成。</span><br></pre></td></tr></table></figure>

<h4 id="消息长度的总结"><a href="#消息长度的总结" class="headerlink" title="消息长度的总结"></a>消息长度的总结</h4><p>其实，上面2中方法都可以归纳为是如何判断http消息的大小、消息的数量。RFC 2616 对 消息的长度总结如下：一个消息的transfer-length（传输长度）是指消息中的message-body（消息体）的长度。当应用了 transfer-coding（传输编码），每个消息中的message-body（消息体）的长度（transfer-length）由以下几种情况 决定（优先级由高到低）：</p>
<ol>
<li><p>任何不含有消息体的消息（如1XXX、204、304等响应消息和任何头(HEAD，首部)请求的响应消息），总是由一个空行（CLRF）结束。</p>
</li>
<li><p>如果出现了Transfer-Encoding头字段 并且值为非“identity”，那么transfer-length由“chunked” 传输编码定义，除非消息由于关闭连接而终止。</p>
</li>
<li><p>如果出现了Content-Length头字段，它的值表示entity-length（实体长度）和transfer-length（传输长 度）。如果这两个长度的大小不一样（i.e.设置了Transfer-Encoding头字段），那么将不能发送Content-Length头字段。并 且如果同时收到了Transfer-Encoding字段和Content-Length头字段，那么必须忽略Content-Length字段。</p>
</li>
<li><p>如果消息使用媒体类型“multipart&#x2F;byteranges”，并且transfer-length 没有另外指定，那么这种自定界（self-delimiting）媒体类型定义transfer-length 。除非发送者知道接收者能够解析该类型，否则不能使用该类型。</p>
</li>
<li><p>由服务器关闭连接确定消息长度。（注意：关闭连接不能用于确定请求消息的结束，因为服务器不能再发响应消息给客户端了。）</p>
</li>
</ol>
<p>为了兼容HTTP&#x2F;1.0应用程序，HTTP&#x2F;1.1的请求消息体中必须包含一个合法的Content-Length头字段，除非知道服务器兼容 HTTP&#x2F;1.1。一个请求包含消息体，并且Content-Length字段没有给定，如果不能判断消息的长度，服务器应该用用400 (bad request) 来响应；或者服务器坚持希望收到一个合法的Content-Length字段，用 411 (length required)来响应。</p>
<p>所有HTTP&#x2F;1.1的接收者应用程序必须接受“chunked” transfer-coding (传输编码)，因此当不能事先知道消息的长度，允许使用这种机制来传输消息。消息不应该够同时包含 Content-Length头字段和non-identity transfer-coding。如果一个消息同时包含non-identity transfer-coding和Content-Length ，必须忽略Content-Length 。</p>
<h4 id="HTTP头字段总结"><a href="#HTTP头字段总结" class="headerlink" title="HTTP头字段总结"></a>HTTP头字段总结</h4><p>最后我总结下HTTP协议的头部字段。</p>
<ol>
<li><p>Accept：告诉WEB服务器自己接受什么介质类型，&#x2F; 表示任何类型，type&#x2F;* 表示该类型下的所有子类型，type&#x2F;sub-type。</p>
</li>
<li><p>Accept-Charset： 浏览器申明自己接收的字符集 Accept-Encoding： 浏览器申明自己接收的编码方法，通常指定压缩方法，是否支持压缩，支持什么压缩方法（gzip，deflate） Accept-Language：浏览器申明自己接收的语言 语言跟字符集的区别：中文是语言，中文有多种字符集，比如big5，gb2312，gbk等等。</p>
</li>
<li><p>Accept-Ranges：WEB服务器表明自己是否接受获取其某个实体的一部分（比如文件的一部分）的请求。bytes：表示接受，none：表示不接受。</p>
</li>
<li><p>Age：当代理服务器用自己缓存的实体去响应请求时，用该头部表明该实体从产生到现在经过多长时间了。</p>
</li>
<li><p>Authorization：当客户端接收到来自WEB服务器的 WWW-Authenticate 响应时，用该头部来回应自己的身份验证信息给WEB服务器。</p>
</li>
<li><p>Cache-Control：请求：no-cache（不要缓存的实体，要求现在从WEB服务器去取） max-age：（只接受 Age 值小于 max-age 值，并且没有过期的对象） max-stale：（可以接受过去的对象，但是过期时间必须小于 max-stale 值） min-fresh：（接受其新鲜生命期大于其当前 Age 跟 min-fresh 值之和的缓存对象） 响应：public(可以用 Cached 内容回应任何用户) private（只能用缓存内容回应先前请求该内容的那个用户） no-cache（可以缓存，但是只有在跟WEB服务器验证了其有效后，才能返回给客户端） max-age：（本响应包含的对象的过期时间） ALL: no-store（不允许缓存）</p>
</li>
<li><p>Connection：请求：close（告诉WEB服务器或者代理服务器，在完成本次请求的响应后，断开连接，不要等待本次连接的后续请求了）。 keepalive（告诉WEB服务器或者代理服务器，在完成本次请求的响应后，保持连接，等待本次连接的后续请求）。 响应：close（连接已经关闭）。 keepalive（连接保持着，在等待本次连接的后续请求）。 Keep-Alive：如果浏览器请求保持连接，则该头部表明希望 WEB 服务器保持连接多长时间（秒）。例如：Keep-Alive：300</p>
</li>
<li><p>Content-Encoding：WEB服务器表明自己使用了什么压缩方法（gzip，deflate）压缩响应中的对象。例如：Content-Encoding：gzip</p>
</li>
<li><p>Content-Language：WEB 服务器告诉浏览器自己响应的对象的语言。</p>
</li>
<li><p>Content-Length： WEB 服务器告诉浏览器自己响应的对象的长度。例如：Content-Length: 26012</p>
</li>
<li><p>Content-Range： WEB 服务器表明该响应包含的部分对象为整个对象的哪个部分。例如：Content-Range: bytes 21010-47021&#x2F;47022</p>
</li>
<li><p>Content-Type： WEB 服务器告诉浏览器自己响应的对象的类型。例如：Content-Type：application&#x2F;xml</p>
</li>
<li><p>ETag：就是一个对象（比如URL）的标志值，就一个对象而言，比如一个 html 文件，如果被修改了，其 Etag 也会别修改，所以ETag 的作用跟 Last-Modified 的作用差不多，主要供 WEB 服务器判断一个对象是否改变了。比如前一次请求某个 html 文件时，获得了其 ETag，当这次又请求这个文件时，浏览器就会把先前获得的 ETag 值发送给WEB 服务器，然后 WEB 服务器会把这个 ETag 跟该文件的当前 ETag 进行对比，然后就知道这个文件有没有改变了。</p>
</li>
<li><p>Expired：WEB服务器表明该实体将在什么时候过期，对于过期了的对象，只有在跟WEB服务器验证了其有效性后，才能用来响应客户请求。是 HTTP&#x2F;1.0 的头部。例如：Expires：Sat, 23 May 2009 10:02:12 GMT</p>
</li>
<li><p>Host：客户端指定自己想访问的WEB服务器的域名&#x2F;IP 地址和端口号。例如：Host：rss.sina.com.cn</p>
</li>
<li><p>If-Match：如果对象的 ETag 没有改变，其实也就意味著对象没有改变，才执行请求的动作。</p>
</li>
<li><p>If-None-Match：如果对象的 ETag 改变了，其实也就意味著对象也改变了，才执行请求的动作。</p>
</li>
<li><p>If-Modified-Since：如果请求的对象在该头部指定的时间之后修改了，才执行请求的动作（比如返回对象），否则返回代码304，告诉浏览器 该对象没有修改。例如：If-Modified-Since：Thu, 10 Apr 2008 09:14:42 GMT</p>
</li>
<li><p>If-Unmodified-Since：如果请求的对象在该头部指定的时间之后没修改过，才执行请求的动作（比如返回对象）。</p>
</li>
<li><p>If-Range：浏览器告诉 WEB 服务器，如果我请求的对象没有改变，就把我缺少的部分给我，如果对象改变了，就把整个对象给我。浏览器通过发送请求对象的 ETag 或者 自己所知道的最后修改时间给 WEB 服务器，让其判断对象是否改变了。总是跟 Range 头部一起使用。</p>
</li>
<li><p>Last-Modified：WEB 服务器认为对象的最后修改时间，比如文件的最后修改时间，动态页面的最后产生时间等等。例如：Last-Modified：Tue, 06 May 2008 02:42:43 GMT</p>
</li>
<li><p>Location：WEB 服务器告诉浏览器，试图访问的对象已经被移到别的位置了，到该头部指定的位置去取。例如：Location：<a target="_blank" rel="noopener" href="http://i0.sinaimg.cn/dy/deco/2008/0528/sinahome_0803_ws_005_text_0.gif">http://i0.sinaimg.cn/dy/deco/2008/0528/sinahome_0803_ws_005_text_0.gif</a></p>
</li>
<li><p>Pramga：主要使用 Pramga: no-cache，相当于 Cache-Control： no-cache。例如：Pragma：no-cache</p>
</li>
<li><p>Proxy-Authenticate： 代理服务器响应浏览器，要求其提供代理身份验证信息。Proxy-Authorization：浏览器响应代理服务器的身份验证请求，提供自己的身份信息。</p>
</li>
<li><p>Range：浏览器（比如 Flashget 多线程下载时）告诉 WEB 服务器自己想取对象的哪部分。例如：Range: bytes&#x3D;1173546-</p>
</li>
<li><p>Referer：浏览器向 WEB 服务器表明自己是从哪个 网页&#x2F;URL 获得&#x2F;点击 当前请求中的网址&#x2F;URL。例如：Referer：<a target="_blank" rel="noopener" href="http://www.sina.com/">http://www.sina.com/</a></p>
</li>
<li><p>Server: WEB 服务器表明自己是什么软件及版本等信息。例如：Server：Apache&#x2F;2.0.61 (Unix)</p>
</li>
<li><p>User-Agent: 浏览器表明自己的身份（是哪种浏览器）。例如：User-Agent：Mozilla&#x2F;5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.8.1.14) Gecko&#x2F;20080404 Firefox&#x2F;2、0、0、14</p>
</li>
<li><p>Transfer-Encoding: WEB 服务器表明自己对本响应消息体（不是消息体里面的对象）作了怎样的编码，比如是否分块（chunked）。例如：Transfer-Encoding: chunked</p>
</li>
<li><p>Vary: WEB服务器用该头部的内容告诉 Cache 服务器，在什么条件下才能用本响应所返回的对象响应后续的请求。假如源WEB服务器在接到第一个请求消息时，其响应消息的头部为：Content- Encoding: gzip; Vary: Content-Encoding那么 Cache 服务器会分析后续请求消息的头部，检查其 Accept-Encoding，是否跟先前响应的 Vary 头部值一致，即是否使用相同的内容编码方法，这样就可以防止 Cache 服务器用自己 Cache 里面压缩后的实体响应给不具备解压能力的浏览器。例如：Vary：Accept-Encoding</p>
</li>
<li><p>Via： 列出从客户端到 OCS 或者相反方向的响应经过了哪些代理服务器，他们用什么协议（和版本）发送的请求。当客户端请求到达第一个代理服务器时，该服务器会在自己发出的请求里面添 加 Via 头部，并填上自己的相关信息，当下一个代理服务器收到第一个代理服务器的请求时，会在自己发出的请求里面复制前一个代理服务器的请求的Via 头部，并把自己的相关信息加到后面，以此类推，当 OCS 收到最后一个代理服务器的请求时，检查 Via 头部，就知道该请求所经过的路由。例如：Via：1.0 236.D0707195.sina.com.cn:80 (squid&#x2F;2.6.STABLE13)</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">通过Service拉起进程，同时开始Service的全过程分析学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-17 15:27:26" itemprop="dateCreated datePublished" datetime="2017-03-17T15:27:26+08:00">2017-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:35:00" itemprop="dateModified" datetime="2022-05-11T14:35:00+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>我们通过提供一个对外部的Service拉起相关的进程和服务，这样能够确保我们有一个进程能够一直在后台，从而进行相关的后台操作。那么通过Service去启动所在进程都做了哪些事情，我们做个深入的分析和探讨。</p>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><p>一般来说，我们在Activity中开启一个服务的代码如下</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">    Intent intent = <span class="keyword">new</span> <span class="constructor">Intent()</span>;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">12</span>)</span><br><span class="line">        intent.add<span class="constructor">Flags(0x00000020)</span>; <span class="comment">// Intent.FLAG_INCLUDE_STOPPED_PACKAGES</span></span><br><span class="line">    intent.set<span class="constructor">Action(<span class="string">&quot;com.vanda.intent.action.FRIEND&quot;</span>)</span>;</span><br><span class="line">    intent.set<span class="constructor">ClassName(<span class="string">&quot;com.vanda&quot;</span>, <span class="string">&quot;com.vanda.bridge&quot;</span>)</span>;</span><br><span class="line">    intent.put<span class="constructor">Extra(<span class="string">&quot;source&quot;</span>, <span class="params">getPackageName</span>()</span>);</span><br><span class="line">    start<span class="constructor">Service(<span class="params">intent</span>)</span>;</span><br><span class="line">&#125; catch (Throwable tr) &#123;</span><br><span class="line">    <span class="comment">// No such service or security error or oom error.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码是一个APP调起另一个APP中的Service进程，这属于跨进程之间的通信范畴，接下来，我们来分析startService是如何工作的。</p>
<h4 id="Android进程间通信"><a href="#Android进程间通信" class="headerlink" title="Android进程间通信"></a>Android进程间通信</h4><p>Android系统是基于Linux内核的，而Linux内核继承和兼容了丰富的Unix系统进程间通信（IPC（Inter process communication））机制。有传统的管道（Pipe）、信号（Signal）和跟踪（Trace），这三项通信手段只能用于父进程与子进程之间，或者兄弟进程之间；后来又增加了命令管道（Named Pipe），使得进程间通信不再局限于父子进程或者兄弟进程之间；为了更好地支持商业应用中的事务处理，在AT&amp;T的Unix系统V中，又增加了三种称为“System V IPC”的进程间通信机制，分别是报文队列（Message）、共享内存（Share Memory）和信号量（Semaphore）；后来BSD Unix对“System V IPC”机制进行了重要的扩充，提供了一种称为插口（Socket）的进程间通信机制。</p>
<p>Android系统没有采用上述提到的各种进程间通信机制，而是采用Binder机制。在Android系统的Binder机制中，由一些系统组件组成，分别是Client、Server、Service Manager和Binder驱动程序，其中Client、Server和Service Manager运行在用户空间，Binder驱动程序运行内核空间。Binder就是一种把这四个组件粘合在一起的粘结剂了，其中，核心组件便是Binder驱动程序了，Service Manager提供了辅助管理的功能，Client和Server正是在Binder驱动和Service Manager提供的基础设施上，进行Client-Server之间的通信。Service Manager和Binder驱动已经在Android平台中实现好，开发者只要按照规范实现自己的Client和Server组件就可以了。</p>
<p><img src="/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/img/Binder.png"></p>
<ol>
<li><p>Client、Server和Service Manager实现在用户空间中，Binder驱动程序实现在内核空间中</p>
</li>
<li><p>Binder驱动程序和Service Manager在Android平台中已经实现，开发者只需要在用户空间实现自己的Client和Server</p>
</li>
<li><p>Binder驱动程序提供设备文件&#x2F;dev&#x2F;binder与用户空间交互，Client、Server和Service Manager通过open和ioctl文件操作函数与Binder驱动程序进行通信</p>
</li>
<li><p>Client和Server之间的进程间通信通过Binder驱动程序间接实现</p>
</li>
<li><p>Service Manager是一个守护进程，用来管理Server，并向Client提供查询Server接口的能力<br> （感谢老罗说的那么多）</p>
</li>
</ol>
<h4 id="Java层的ServiceManager"><a href="#Java层的ServiceManager" class="headerlink" title="Java层的ServiceManager"></a>Java层的ServiceManager</h4><p>Service Manager（我觉得是C&#x2F;C++层）是一个守护进程，用来管理Server，并向Client提供查询Server接口的能力，我们看下类图构成：</p>
<p><img src="/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/img/ServiceManager.jpg"></p>
<ol>
<li><p>ServiceManager提供了外部查询的和添加Service的方法，最为核心的是具备实现IServiceManager的ServiceManagerNative类。</p>
</li>
<li><p>ServiceManagerNative需要一个实现IBinder的对象，这个对象通过BinderInternal.getContextObject()获得一个C层的BinderProxy对象，这是系统中全局的”context object”。</p>
</li>
<li><p>ServiceManagerNative通过一个代理类ServiceManagerProxy，ServiceManagerProxy类实现了IServiceManager接口，IServiceManager提供了getService和addService两个成员函数来管理系统中的Service。从ServiceManagerProxy类的构造函数可以看出，它需要一个BinderProxy对象的IBinder接口来作为参数。因此，要获取Service Manager的Java远程接口ServiceManagerProxy，首先要有一个BinderProxy对象。再来看一下是通过什么路径来获取Service Manager的Java远程接口ServiceManagerProxy的。这个主角就是ServiceManager了，ServiceManager类有一个静态成员函getIServiceManager，它的作用就是用来获取Service Manager的Java远程接口了，而这个函数又是通过ServiceManagerNative来获取Service Manager的Java远程接口的。</p>
</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title">getIServiceManager</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sServiceManager != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sServiceManager;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Find the service manager</span></span><br><span class="line">    sServiceManager = ServiceManagerNative.asInterface(BinderInternal.getContextObject());</span><br><span class="line">    <span class="keyword">return</span> sServiceManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在C&#x2F;C++层将对象进行了转换，结果是sServiceManager &#x3D; ServiceManagerNative.asInterface(new BinderProxy()); 那么我们看下ServiceManagerNative.asInterface做了什么事情</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title function_">asInterface</span><span class="params">(IBinder obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">IServiceManager</span> <span class="variable">in</span> <span class="operator">=</span></span><br><span class="line">        (IServiceManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceManagerProxy</span>(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的静态方法中看出，如果当地查询不到IServiceManager，in为null ,obj是一个BinderProxy对象,那么就会以BinderProxy对象为参数创建一个ServiceManagerProxy对象。实质上等价的代码为<br>sServiceManager &#x3D; new ServiceManagerProxy(new BinderProxy());<br>ServiceManager就是这为了这句代码写的，就是在Java层，我们拥有了一个Service Manager远程接口ServiceManagerProxy，而这个ServiceManagerProxy对象在JNI层有一个句柄值为0的BpBinder对象与之通过gBinderProxyOffsets关联起来。这样获取Service Manager的Java远程接口ServiceManagerProxy的过程就完成了。</p>
<p>我们简单的看下C层做了些什么</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; ProcessState::get<span class="constructor">ContextObject(<span class="params">const</span> <span class="params">sp</span>&lt;IBinder&gt;&amp; <span class="params">caller</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    return get<span class="constructor">StrongProxyForHandle(0)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">static jobject android_os_BinderInternal_getContextObject(JNIEnv* env, jobject clazz)</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::self()-&gt;getContextObject(NULL);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> javaObjectForIBinder(env, b);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">jobject javaObjectForIBinder(JNIEnv* env, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; <span class="keyword">val</span>)</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">val</span> == NULL) <span class="keyword">return</span> NULL;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">val</span>-&gt;checkSubclass(&amp;gBinderOffsets)) &#123;</span><br><span class="line">        <span class="comment">// One of our own!</span></span><br><span class="line">        jobject <span class="keyword">object</span> = static_cast&lt;JavaBBinder*&gt;(<span class="keyword">val</span>.<span class="keyword">get</span>())-&gt;<span class="keyword">object</span>();</span><br><span class="line">        LOGDEATH(<span class="string">&quot;objectForBinder %p: it&#x27;s our own %p!\n&quot;</span>, <span class="keyword">val</span>.<span class="keyword">get</span>(), <span class="keyword">object</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">object</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// For the rest of the function we will hold this lock, to serialize</span></span><br><span class="line">    <span class="comment">// looking/creation of Java proxies for native Binder proxies.</span></span><br><span class="line">    AutoMutex _l(mProxyLock);</span><br><span class="line">    <span class="comment">// Someone else&#x27;s...  do we know about it?</span></span><br><span class="line">    jobject <span class="keyword">object</span> = (jobject)<span class="keyword">val</span>-&gt;findObject(&amp;gBinderProxyOffsets);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">object</span> != NULL) &#123;</span><br><span class="line">        jobject res = jniGetReferent(env, <span class="keyword">object</span>);</span><br><span class="line">        <span class="keyword">if</span> (res != NULL) &#123;</span><br><span class="line">            ALOGV(<span class="string">&quot;objectForBinder %p: found existing %p!\n&quot;</span>, <span class="keyword">val</span>.<span class="keyword">get</span>(), res);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">        LOGDEATH(<span class="string">&quot;Proxy object %p of IBinder %p no longer in working set!!!&quot;</span>, <span class="keyword">object</span>, <span class="keyword">val</span>.<span class="keyword">get</span>());</span><br><span class="line">        android_atomic_dec(&amp;gNumProxyRefs);</span><br><span class="line">        <span class="keyword">val</span>-&gt;detachObject(&amp;gBinderProxyOffsets);</span><br><span class="line">        env-&gt;DeleteGlobalRef(<span class="keyword">object</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">object</span> = env-&gt;NewObject(gBinderProxyOffsets.mClass, gBinderProxyOffsets.mConstructor);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">object</span> != NULL) &#123;</span><br><span class="line">        LOGDEATH(<span class="string">&quot;objectForBinder %p: created new proxy %p !\n&quot;</span>, <span class="keyword">val</span>.<span class="keyword">get</span>(), <span class="keyword">object</span>);</span><br><span class="line">        <span class="comment">// The proxy holds a reference to the native object.</span></span><br><span class="line">        env-&gt;SetIntField(<span class="keyword">object</span>, gBinderProxyOffsets.mObject, (int)<span class="keyword">val</span>.<span class="keyword">get</span>());</span><br><span class="line">        <span class="keyword">val</span>-&gt;incStrong((void*)javaObjectForIBinder);</span><br><span class="line">        <span class="comment">// The native object needs to hold a weak reference back to the</span></span><br><span class="line">        <span class="comment">// proxy, so we can retrieve the same proxy if it is still active.</span></span><br><span class="line">        jobject refObject = env-&gt;NewGlobalRef(</span><br><span class="line">                env-&gt;GetObjectField(<span class="keyword">object</span>, gBinderProxyOffsets.mSelf));</span><br><span class="line">        <span class="keyword">val</span>-&gt;attachObject(&amp;gBinderProxyOffsets, refObject,</span><br><span class="line">                jnienv_to_javavm(env), proxy_cleanup);</span><br><span class="line">        <span class="comment">// Also remember the death recipients registered on this proxy</span></span><br><span class="line">        sp&lt;DeathRecipientList&gt; drl = new DeathRecipientList;</span><br><span class="line">        drl-&gt;incStrong((void*)javaObjectForIBinder);</span><br><span class="line">        env-&gt;SetIntField(<span class="keyword">object</span>, gBinderProxyOffsets.mOrgue, reinterpret_cast&lt;jint&gt;(drl.<span class="keyword">get</span>()));</span><br><span class="line">        <span class="comment">// Note that a new object reference has been created.</span></span><br><span class="line">        android_atomic_inc(&amp;gNumProxyRefs);</span><br><span class="line">        incRefsCreated(env);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">object</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回一个句柄值为0的BpBinder对象<br>sp<IBinder> b &#x3D; new BpBinder(0);<br>然后将这个BpBinder对象转换成一个BinderProxy，这样Java层代理类就获得这个对象。<br>说了这么一大坨就是为了方便我们之后获取Binder填好坑。</IBinder></p>
<h4 id="关联startService相关类图"><a href="#关联startService相关类图" class="headerlink" title="关联startService相关类图"></a>关联startService相关类图</h4><p>不难发现startService可以有多个入口调用，原因看如下类图：</p>
<p><img src="/2017/03/17/%E9%80%9A%E8%BF%87Service%E6%8B%89%E8%B5%B7%E8%BF%9B%E7%A8%8B%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%A7%8BService%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0/img/startService.png"></p>
<ol>
<li><p>Activity、Application、Service都是继承ContextWrapper，其中Service拥有Applcation实例。</p>
</li>
<li><p>在ContextWrapper类中，实现了startService函数。在ContextWrapper类中，有一个成员变量mBase，它是一个ContextImpl实例。</p>
</li>
<li><p>ContextImpl类和ContextWrapper类一样继承于Context类，ContextWrapper类的startService函数最终过调用ContextImpl类的startService函数来实现。这种类设计方法在设计模式里面，就称之为装饰模式（Decorator），或者包装模式（Wrapper）。</p>
</li>
<li><p>在ContextImpl类的startService类，最终又调用了ActivityManagerProxy类的startService来实现启动服务的操作</p>
</li>
</ol>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ComponentName startServiceCommon(Intent service, UserHandle user) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        validateServiceIntent(service);</span><br><span class="line">        service.prepareToLeaveProcess();</span><br><span class="line">        ComponentName <span class="literal">cn</span> = ActivityManagerNative.getDefault().startService(</span><br><span class="line">            mMainThread.getApplicationThread(), service,</span><br><span class="line">            service.resolveTypeIfNeeded(getContentResolver()), user.getIdentifier());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">cn</span> != <span class="built_in">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">cn</span>.getPackageName().<span class="keyword">equals</span>(<span class="string">&quot;!&quot;</span>)) &#123;</span><br><span class="line">                throw <span class="literal">new</span> SecurityException(</span><br><span class="line">                        <span class="string">&quot;Not allowed to start service &quot;</span> + service</span><br><span class="line">                        + <span class="string">&quot; without permission &quot;</span> + <span class="literal">cn</span>.getClassName());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">cn</span>.getPackageName().<span class="keyword">equals</span>(<span class="string">&quot;!!&quot;</span>)) &#123;</span><br><span class="line">                throw <span class="literal">new</span> SecurityException(</span><br><span class="line">                        <span class="string">&quot;Unable to start service &quot;</span> + service</span><br><span class="line">                        + <span class="string">&quot;: &quot;</span> + <span class="literal">cn</span>.getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">cn</span>;</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合ServiceManager和类图我们可以知道ActivityManagerProxy是一个Binder对象的远程接口了，ServiceManagerProxy远程对象是C层的ServiceManager，而ActivityManagerProxy这个Binder远程对象就是ActivityManagerService了。在手机启动时会初始化这个Binder，我们看下源码：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> SystemServer &#123;</span><br><span class="line">    <span class="keyword">private</span> static final String TAG = <span class="string">&quot;SystemServer&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    public static final <span class="built_in">int</span> FACTORY_TEST_OFF = <span class="number">0</span>;</span><br><span class="line">    public static final <span class="built_in">int</span> FACTORY_TEST_LOW_LEVEL = <span class="number">1</span>;</span><br><span class="line">    public static final <span class="built_in">int</span> FACTORY_TEST_HIGH_LEVEL = <span class="number">2</span>;</span><br><span class="line"> </span><br><span class="line">    static Timer timer;</span><br><span class="line">    static final long SNAPSHOT_INTERVAL = <span class="number">60</span><span class="operator"> * </span><span class="number">60</span><span class="operator"> * </span><span class="number">1000</span>; <span class="comment">// 1hr</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// The earliest supported time.  We pick one day into 1970, to</span></span><br><span class="line">    <span class="comment">// give any timezone code room without going into negative time.</span></span><br><span class="line">    <span class="keyword">private</span> static final long EARLIEST_SUPPORTED_TIME = <span class="number">86400</span><span class="operator"> * </span><span class="number">1000</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called to initialize native system services.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> static native void native<span class="constructor">Init()</span>;</span><br><span class="line"> </span><br><span class="line">    public static void main(String<span class="literal">[]</span> args) &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * In case the runtime switched since last boot (such as when</span></span><br><span class="line"><span class="comment">         * the old runtime was removed in an OTA), set the system</span></span><br><span class="line"><span class="comment">         * property so that it is in sync. We can&#x27;t do this in</span></span><br><span class="line"><span class="comment">         * libnativehelper&#x27;s JniInvocation::Init code where we already</span></span><br><span class="line"><span class="comment">         * had to fallback to a different runtime because it is</span></span><br><span class="line"><span class="comment">         * running as root and we need to be the system user to set</span></span><br><span class="line"><span class="comment">         * the property. http://b/11463182</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">SystemProperties</span>.</span></span>set(<span class="string">&quot;persist.sys.dalvik.vm.lib&quot;</span>,</span><br><span class="line">                             <span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.vm<span class="constructor">Library()</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span> &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line">            <span class="comment">// If a device&#x27;s clock is before 1970 (before 0), a lot of</span></span><br><span class="line">            <span class="comment">// APIs crash dealing with negative numbers, notably</span></span><br><span class="line">            <span class="comment">// java.io.File#setLastModified, so instead we fake it and</span></span><br><span class="line">            <span class="comment">// hope that time from cell towers or NTP fixes it</span></span><br><span class="line">            <span class="comment">// shortly.</span></span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>w(TAG, <span class="string">&quot;System clock is before 1970; setting to 1970.&quot;</span>);</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">SystemClock</span>.</span></span>set<span class="constructor">CurrentTimeMillis(EARLIEST_SUPPORTED_TIME)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>is<span class="constructor">Enabled()</span>) &#123;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>start<span class="literal">()</span>;</span><br><span class="line">            timer = <span class="keyword">new</span> <span class="constructor">Timer()</span>;</span><br><span class="line">            timer.schedule(<span class="keyword">new</span> <span class="constructor">TimerTask()</span> &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run<span class="literal">()</span> &#123;</span><br><span class="line">                    <span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>write<span class="constructor">Snapshot(<span class="string">&quot;system_server&quot;</span>, <span class="params">null</span>)</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Mmmmmm... more memory!</span></span><br><span class="line">        dalvik.system.<span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.clear<span class="constructor">GrowthLimit()</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// The system server has to run all of the time, so it needs to be</span></span><br><span class="line">        <span class="comment">// as efficient as possible with its memory usage.</span></span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.set<span class="constructor">TargetHeapUtilization(0.8f)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Environment</span>.</span></span>set<span class="constructor">UserRequired(<span class="params">true</span>)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>load<span class="constructor">Library(<span class="string">&quot;android_servers&quot;</span>)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>i(TAG, <span class="string">&quot;Entered the Android system server!&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Initialize native services.</span></span><br><span class="line">        native<span class="constructor">Init()</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// This used to be its own separate thread, but now it is</span></span><br><span class="line">        <span class="comment">// just the loop we run on the main thread.</span></span><br><span class="line">        ServerThread thr = <span class="keyword">new</span> <span class="constructor">ServerThread()</span>;</span><br><span class="line">        thr.init<span class="constructor">AndLoop()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ServerThread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;SystemServer&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENCRYPTING_STATE</span> <span class="operator">=</span> <span class="string">&quot;trigger_restart_min_framework&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENCRYPTED_STATE</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    ContentResolver mContentResolver;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reportWtf</span><span class="params">(String msg, Throwable e)</span> &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;***********************************************&quot;</span>);</span><br><span class="line">        Log.wtf(TAG, <span class="string">&quot;BOOT FAILURE &quot;</span> + msg, e);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initAndLoop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">            context = ActivityManagerService.main(factoryTest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;************ Failure starting bootstrap service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            ActivityManagerService.setSystemProcess();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line">            Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;************ Failure starting core service&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>系统启动时，会通过ActivityManagerService.main()创建出实例，通过ActivityManagerService.setSystemProcess();将服务添加到Service Manager中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title class_">ActivityManagerNative</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Context <span class="title function_">main</span><span class="params">(<span class="type">int</span> factoryTest)</span> &#123;</span><br><span class="line">        <span class="type">AThread</span> <span class="variable">thr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AThread</span>();</span><br><span class="line">        thr.start();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">synchronized</span> (thr) &#123;</span><br><span class="line">                <span class="keyword">while</span> (thr.mService == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        thr.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="type">ActivityManagerService</span> <span class="variable">m</span> <span class="operator">=</span> thr.mService;</span><br><span class="line">        mSelf = m;</span><br><span class="line">     </span><br><span class="line">        ...</span><br><span class="line"> </span><br><span class="line">        m.startRunning(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setSystemProcess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ActivityManagerService</span> <span class="variable">m</span> <span class="operator">=</span> mSelf;</span><br><span class="line"> </span><br><span class="line">                ServiceManager.addService(Context.ACTIVITY_SERVICE, m, <span class="literal">true</span>);</span><br><span class="line">                ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                <span class="string">&quot;Unable to find android system package&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就把ActivityManagerService这个Binder添加到Service Manager中，之后通信的时候，需要通过代理去获取它。这样ActivityManagerService就启动了。</p>
<ol>
<li><p>现在知道ActivityManagerProxy.startService是通过ActivityManagerService的startService</p>
</li>
<li><p>ActivityManagerProxy的mBinder持有ActivityManagerService Binder的引用，执行接口赋予的功能</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/17/%E7%A0%94%E7%A9%B6Notification/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="伍中联">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="伍中联(Vanda)的博客">
      <meta itemprop="description" content="珍惜在生命中遇到的每一个人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 伍中联(Vanda)的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/17/%E7%A0%94%E7%A9%B6Notification/" class="post-title-link" itemprop="url">研究Notification时想知道的进程间通信Binder机制在应用程序框架层的Java接口源代码分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-17 15:20:55" itemprop="dateCreated datePublished" datetime="2017-03-17T15:20:55+08:00">2017-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-11 14:35:00" itemprop="dateModified" datetime="2022-05-11T14:35:00+08:00">2022-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="问题来源"><a href="#问题来源" class="headerlink" title="问题来源"></a>问题来源</h4><p>在调研notification时，这里涉及多个进程间的通信。并且在调研push通知开关状态时，涉及到framework的源码分析。所有，对系统想做一个系统的分析学习。</p>
<p>在framework&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;SystemServer.java中</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> SystemServer &#123;<span class="operator"></span></span><br><span class="line"><span class="operator"> </span></span><br><span class="line"><span class="operator"> </span></span><br><span class="line"><span class="operator">...</span></span><br><span class="line"><span class="operator"></span>...</span><br><span class="line">    <span class="keyword">private</span> static native void native<span class="constructor">Init()</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    public static void main(String<span class="literal">[]</span> args) &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">SystemProperties</span>.</span></span>set(<span class="string">&quot;persist.sys.dalvik.vm.lib&quot;</span>,</span><br><span class="line"> </span><br><span class="line">                             <span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.vm<span class="constructor">Library()</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>current<span class="constructor">TimeMillis()</span> &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>w(TAG, <span class="string">&quot;System clock is before 1970; setting to 1970.&quot;</span>);</span><br><span class="line"> </span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">SystemClock</span>.</span></span>set<span class="constructor">CurrentTimeMillis(EARLIEST_SUPPORTED_TIME)</span>;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>is<span class="constructor">Enabled()</span>) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>start<span class="literal">()</span>;</span><br><span class="line"> </span><br><span class="line">            timer = <span class="keyword">new</span> <span class="constructor">Timer()</span>;</span><br><span class="line"> </span><br><span class="line">            timer.schedule(<span class="keyword">new</span> <span class="constructor">TimerTask()</span> &#123;</span><br><span class="line"> </span><br><span class="line">                @Override</span><br><span class="line"> </span><br><span class="line">                public void run<span class="literal">()</span> &#123;</span><br><span class="line"> </span><br><span class="line">                    <span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>write<span class="constructor">Snapshot(<span class="string">&quot;system_server&quot;</span>, <span class="params">null</span>)</span>;</span><br><span class="line"> </span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">            &#125;, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Mmmmmm... more memory!</span></span><br><span class="line"> </span><br><span class="line">        dalvik.system.<span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.clear<span class="constructor">GrowthLimit()</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// The system server has to run all of the time, so it needs to be</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">// as efficient as possible with its memory usage.</span></span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">VMRuntime</span>.</span></span>get<span class="constructor">Runtime()</span>.set<span class="constructor">TargetHeapUtilization(0.8f)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Environment</span>.</span></span>set<span class="constructor">UserRequired(<span class="params">true</span>)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>load<span class="constructor">Library(<span class="string">&quot;android_servers&quot;</span>)</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>i(TAG, <span class="string">&quot;Entered the Android system server!&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Initialize native services.</span></span><br><span class="line"> </span><br><span class="line">        native<span class="constructor">Init()</span>;</span><br><span class="line">        <span class="comment">// This used to be its own separate thread, but now it is</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">// just the loop we run on the main thread.</span></span><br><span class="line"> </span><br><span class="line">        ServerThread thr = <span class="keyword">new</span> <span class="constructor">ServerThread()</span>;</span><br><span class="line"> </span><br><span class="line">        thr.init<span class="constructor">AndLoop()</span>;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>这里存在一个java的main函数的入口，这个是初始化应用层相关服务的，我们分析initAndLoop，这个方法里面包含初始化各种系统的Service，而这些都是通过ServiceManager去做的。</p>
<p>我们需要获取的ServiceManager的Java远程接口是一个ServiceManagerProxy对象的IServiceManager接口。ServiceManagerProxy类图结构：</p>
<p><img src="/2017/03/17/%E7%A0%94%E7%A9%B6Notification/img/ClassDiagram1.png"></p>
<p>从上图可以知道ServiceManagerProxy类实现了IServiceManager接口，IServiceManager提供了getService和addService两个成员方法来管理系统中的Service。在ServiceManagerProxy类的构造函数可以得知需要一个BinderProxy对象的IBinder接口来作为参数。因此，要获取ServiceManager的Java远程接口ServiceManagerProxy，首先要有一个BinderProxy对象。BinderProxy对象是如何获得的？</p>
<p>我们先看看ServiceManager里面做了些什么</p>
<p><img src="/2017/03/17/%E7%A0%94%E7%A9%B6Notification/img/Main.png"></p>
<p>我想知道这些Service是如何去通信的，我们看下在ServiceManager中的代码</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** @hide */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ServiceManager</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">String</span> TAG = <span class="string">&quot;ServiceManager&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IServiceManager sServiceManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">HashMap</span>&lt;<span class="built_in">String</span>, IBinder&gt; sCache = <span class="keyword">new </span><span class="class title_">HashMap</span>&lt;<span class="built_in">String</span>, IBinder&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title function_">getIServiceManager</span>() &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (sServiceManager != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> sServiceManager;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Find the service manager</span></span><br><span class="line">        sServiceManager = ServiceManagerNative.<span class="property">asInterface</span>(BinderInternal.<span class="property">getContextObject</span>());</span><br><span class="line">        <span class="keyword">return</span> sServiceManager;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面贴出了ServiceManager的一个静态方法<br>getIServiceManager<br>这个方法是获取Java远程接口，getIServiceManager内部是通过方法<br>ServiceManagerNative.asInterface(BinderInternal.getContextObject())<br>去获取远程接口。在调用ServiceManagerNative.asInterface方法之前是需要传入一个参数，这个参数是<br>BinderInternal.getContextObject()返回的值。我们看下这个方法到底是什么鬼：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * Private and debugging Binder APIs.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * @see IBinder</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinderInternal</span> &#123;</span><br><span class="line">  </span><br><span class="line">...</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * Return the global &quot;context object&quot; of the system.  This is usually</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * an implementation of IServiceManager, which you can use to find</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * other services.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">native</span> IBinder getContextObject();</span><br><span class="line">  </span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BinderInternal.getContextObject是一个JNI方法，返回的值是IBinder类型，在framework搜索这个方法的JNI实现</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static jobject android<span class="constructor">_os_BinderInternal_getContextObject(JNIEnv<span class="operator">*</span> <span class="params">env</span>, <span class="params">jobject</span> <span class="params">clazz</span>)</span></span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::self<span class="literal">()</span>-&gt;get<span class="constructor">ContextObject(NULL)</span>;</span><br><span class="line"> </span><br><span class="line">    return java<span class="constructor">ObjectForIBinder(<span class="params">env</span>, <span class="params">b</span>)</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是调用ProcessState::self函数，self函数是ProcessState的静态成员函数，它的作用是返回一个全局唯一的ProcessState实例变量，就是单例模式了，这个变量名为gProcess。如果gProcess尚未创建，就会执行创建操作，在ProcessState的构造函数中，会通过open文件操作函数打开设备文件&#x2F;dev&#x2F;binder，并且返回来的设备文件描述符保存在成员变量mDriverFD中。<br>接着调用gProcess-&gt;getContextObject函数来获得一个句柄值为0的Binder引用，即BpBinder了,相似的代码：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IBinder&gt; b <span class="operator">=</span> new BpBinder(<span class="number">0</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>我们在看看ServiceManagerNative.asInterface里面的代码</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * Native implementation of the service manager.  Most clients will only</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * care about getDefault() and possibly asInterface().</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * @hide</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="title">implements</span> <span class="title">IServiceManager</span></span></span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * Cast a Binder object into a service manager interface, generating</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     * a proxy if needed.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"> </span><br><span class="line">    static public <span class="type">IServiceManager</span> asInterface(<span class="type">IBinder</span> obj)</span><br><span class="line"> </span><br><span class="line">    &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="type">IServiceManager</span> in = (<span class="type">IServiceManager</span>)obj.queryLocalInterface(descriptor);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (in != <span class="literal">null</span>) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">ServiceManagerProxy</span>(obj);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在静态方法asInterface里面需要一个IBinder的参数，就是一个代理对象，如果当地不存在描述的IServiceManager那么就通过这个BinderProxy去创建一个。</p>
<p>那我们在创建AIDL文件时，系统到底做了什么？</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">伍中联</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
